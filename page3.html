<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>صفحة المطابقة بالذكاء الاصطناعي (OpenAI)</title>
    <style>
        /* ===================== CSS Variables and Global Styles ===================== */
        :root {
            --bg: #0f172a;
            --card: #111827;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #22c55e;
            --accent-2: #3b82f6;
            --btn-bg: #1f2937;
            --btn-hover: #374151;
            --shadow: 0 10px 25px rgba(0, 0, 0, .35);
            --radius: 18px;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", Arial, sans-serif;
            line-height: 1.6;
        }

        /* ===================== Layout and Card Styles ===================== */
        .wrap {
            min-height: 100vh;
            display: grid;
            place-items: center;
            padding: 24px;
        }

        .card {
            width: min(1200px, 96vw);
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .01));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: var(--radius);
            padding: 28px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(6px);
        }

        h1 {
            margin: 0 0 10px;
            font-size: clamp(26px, 3.5vw, 40px);
            letter-spacing: .2px;
        }

        p.lead {
            margin: 0 0 26px;
            color: var(--muted);
        }

        /* ===================== Buttons and Links ===================== */
        button.btn,
        a.btn {
            display: inline-block;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            background: var(--btn-bg);
            color: var(--text);
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .08);
            transition: transform .12s ease, background .12s ease, border-color .12s ease;
            box-shadow: 0 6px 14px rgba(0, 0, 0, .25);
            font-family: inherit;
            font-size: inherit;
        }

        button.btn:hover,
        a.btn:hover {
            background: var(--btn-hover);
            transform: translateY(-1px);
        }

        button.btn.primary,
        a.btn.primary {
            background: var(--accent-2);
            border-color: transparent;
            color: #fff;
        }

        button.btn.success,
        a.btn.success {
            background: var(--accent);
            border-color: transparent;
            color: #fff;
        }

        button.btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ===================== Sections and Status ===================== */
        .status-section,
        .controls-section,
        .results-section {
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            text-align: center;
        }

        .stat-item .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-2);
        }

        .stat-item .stat-label {
            font-size: 12px;
            color: var(--muted);
        }

        #status-message {
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            display: none;
            margin-bottom: 16px;
        }

        #status-message.info {
            background: rgba(59, 130, 246, .1);
            color: var(--accent-2);
            border: 1px solid rgba(59, 130, 246, .2);
        }

        #status-message.success {
            background: rgba(34, 197, 94, .1);
            color: var(--accent);
            border: 1px solid rgba(34, 197, 94, .2);
        }

        #status-message.error {
            background: rgba(239, 68, 68, .1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, .2);
        }

        .loader {
            border: 4px solid var(--btn-bg);
            border-top: 4px solid var(--accent-2);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ===================== Match Results Styling ===================== */
        .matches-container {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        .match-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: var(--radius);
            padding: 20px;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            padding-bottom: 12px;
        }

        .match-quality {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .match-quality.ممتازة {
            background: #10b981;
            color: #fff;
        }

        .match-quality.جيدة {
            background: #f59e0b;
            color: #fff;
        }

        .match-quality.مقبولة {
            background: #6b7280;
            color: #fff;
        }

        .match-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .detail-item strong {
            color: var(--accent-2);
        }

        .match-reason {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 10px;
            margin: 16px 0;
            font-style: italic;
            border-left: 3px solid var(--accent);
        }

        .match-texts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .text-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 10px;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .text-box h4 {
            margin: 0 0 8px;
            color: var(--accent-2);
        }

        /* ===================== Responsive Design ===================== */
        @media (max-width: 768px) {
            .match-texts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h1><span style="font-size: 24px;">🤖</span> مطابقة العروض والطلبات العقارية</h1>
            <p class="lead">استخدم الذكاء الاصطناعي لتحليل النصوص وإيجاد أفضل المطابقات بين العروض والطلبات — باستخدام OpenAI.</p>

            <!-- Status Section -->
            <div class="status-section">
                <h2>📊 حالة البيانات</h2>
                <div id="status-message"></div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="total-docs">0</div>
                        <div class="stat-label">إجمالي المستندات</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="request-count">0</div>
                        <div class="stat-label">الطلبات</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="offer-count">0</div>
                        <div class="stat-label">العروض</div>
                    </div>
                </div>
            </div>

            <!-- Controls Section -->
            <div class="controls-section" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                <button class="btn success" id="start-matching-btn" onclick="runMatching()">🚀 بدء المطابقة بالذكاء الاصطناعي</button>
                <button class="btn" onclick="promptAndSaveApiKey()">🔑 إعداد مفتاح OpenAI</button>
                <button class="btn" onclick="testApiKey()">🧪 اختبار المفتاح</button>
                <a class="btn" href="page2.html" style="margin-inline-start:auto;">العودة للملفات</a>
            </div>

            <!-- Results Section -->
            <div class="results-section">
                <h2>💡 نتائج المطابقة</h2>
                <div id="loader" class="loader"></div>
                <div id="matches-container" class="matches-container"></div>
                <p id="no-results" style="color: var(--muted); text-align: center; display: block;">لم يتم إجراء أي عملية مطابقة بعد. اضغط على زر "بدء المطابقة" للبدء.</p>
            </div>
        </div>
    </div>

    <script>
        // =================================================================================
        // SCRIPT START
        // =================================================================================

        // ===================== General Settings =====================
        const DB_NAME = 'FilesStorage';
        const DB_VERSION = 1;
        const STORE_NAME = 'files';
        let db;

        const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
        const OPENAI_MODEL = 'gpt-4o-mini';
        const API_KEY_STORAGE_KEY = 'OPENAI_API_KEY';

        // ===================== Global State Variables =====================
        let allTextFiles = [];
        let requests = [];
        let offers = [];

        // ===================== App Initialization =====================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                showMessage('info', 'قاعدة البيانات جاهزة. اضبط مفتاح OpenAI واضغط البدء.');
                // Load data immediately to display stats
                await loadDataForMatching();
                await classifyAndSeparateFiles();
            } catch (error) {
                console.error("Initialization failed:", error);
                showMessage('error', `❌ خطأ فادح في التهيئة: ${error.message}`);
            }
        });

        // ===================== OpenAI API Key Management =====================
        function getApiKey() {
            return localStorage.getItem(API_KEY_STORAGE_KEY) || '';
        }

        function saveApiKey(key) {
            if (!key || !key.trim()) return false;
            localStorage.setItem(API_KEY_STORAGE_KEY, key.trim());
            return true;
        }

        function promptAndSaveApiKey() {
            const currentKey = getApiKey();
            const newKey = prompt('أدخل مفتاح OpenAI (يُخزن محلياً في متصفحك):', currentKey);
            if (newKey !== null) {
                if (saveApiKey(newKey)) {
                    showMessage('success', '✅ تم حفظ مفتاح OpenAI محلياً.');
                } else {
                    showMessage('error', '❌ لم يتم حفظ المفتاح. تأكد أنه غير فارغ.');
                }
            }
        }

        async function ensureApiKeyOrFail() {
            const key = getApiKey();
            if (!key) {
                showMessage('error', '❌ لا يوجد مفتاح OpenAI. اضغط "إعداد مفتاح OpenAI" لإدخاله.');
                throw new Error('API key is missing');
            }
            return key;
        }

        async function testApiKey() {
            const startBtn = document.getElementById('start-matching-btn');
            const loader = document.getElementById('loader');
            try {
                const key = await ensureApiKeyOrFail();
                showMessage('info', '🧪 جاري اختبار المفتاح...');
                startBtn.disabled = true;
                loader.style.display = 'block';

                const res = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: [{
                            role: 'system',
                            content: 'You are a JSON-only responder.'
                        }, {
                            role: 'user',
                            content: 'Return exactly this JSON: {"ok":true}'
                        }],
                        temperature: 0,
                        max_tokens: 50
                    })
                });

                if (!res.ok) {
                    const errorBody = await res.text();
                    console.error('OpenAI test error:', errorBody);
                    throw new Error(`فشل الاختبار: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                const content = data?.choices?.[0]?.message?.content ?? '';
                if (content.includes('"ok":true')) {
                    showMessage('success', '✅ المفتاح يعمل بشكل صحيح.');
                } else {
                    showMessage('error', '⚠️ استجابة غير متوقعة، تحقق من الصلاحيات.');
                }
            } catch (error) {
                console.error("API Key test failed:", error);
                showMessage('error', `❌ اختبار المفتاح فشل: ${error.message}`);
            } finally {
                startBtn.disabled = false;
                loader.style.display = 'none';
            }
        }

        // ===================== UI Status Messages =====================
        function showMessage(type, message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = type;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (type !== 'error') {
                setTimeout(() => {
                    if (statusDiv.textContent === message) {
                        statusDiv.style.display = 'none';
                    }
                }, 5000);
            }
        }

        // ===================== IndexedDB Management =====================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("خطأ في فتح قاعدة البيانات");
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, {
                            keyPath: 'id'
                        });
                        store.createIndex('name', 'name', {
                            unique: false
                        });
                        store.createIndex('uploadTime', 'uploadTime', {
                            unique: false
                        });
                    }
                };
            });
        }

        // ===================== Data Loading and Processing =====================
        async function loadDataForMatching() {
            showMessage('info', '📂 جاري تحميل البيانات من قاعدة البيانات...');
            return new Promise((resolve, reject) => {
                if (!db) return reject("Database not initialized");
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    const allFiles = request.result;
                    console.log(`📋 Total files in DB: ${allFiles.length}`);

                    allTextFiles = allFiles.filter(file =>
                        (file.type && (file.type.includes('text') || file.type.includes('json'))) ||
                        (file.name && (file.name.endsWith('.txt') || file.name.endsWith('.json')))
                    );

                    console.log(`✅ Filtered ${allTextFiles.length} text/json files.`);

                    if (allTextFiles.length === 0) {
                        showMessage('error', '❌ لم يتم العثور على ملفات نصية أو JSON صالحة للمطابقة.');
                        // Don't reject, just resolve. It's not a fatal error.
                        resolve();
                        return;
                    }

                    showMessage('success', `✅ تم تحميل ${allTextFiles.length} مستند بنجاح.`);
                    document.getElementById('total-docs').textContent = allTextFiles.length;
                    resolve();
                };

                request.onerror = () => {
                    console.error('❌ Error reading from DB:', request.error);
                    showMessage('error', '❌ فشل في قراءة الملفات من قاعدة البيانات.');
                    reject(request.error);
                };
            });
        }

        function classifyMessageType(text) {
            if (!text) return 'غير محدد';
            const textLower = text.toLowerCase();
            const requestKeywords = ['مطلوب', 'ابحث عن', 'أريد', 'نريد', 'محتاج', 'بحث عن', 'عاوز', 'عايز', 'ادور على', 'أدور على', 'نبحث عن', 'wanted', 'looking for', 'need', 'require'];
            const offerKeywords = ['للبيع', 'للايجار', 'للإيجار', 'معروض', 'متوفر', 'يوجد', 'عندي', 'لدي', 'متاح', 'للتنازل', 'أعرض', 'for sale', 'for rent', 'available', 'offering'];

            const requestCount = requestKeywords.reduce((sum, keyword) => sum + (textLower.includes(keyword) ? 1 : 0), 0);
            const offerCount = offerKeywords.reduce((sum, keyword) => sum + (textLower.includes(keyword) ? 1 : 0), 0);

            if (requestCount > offerCount) return 'مطلوب';
            if (offerCount > requestCount) return 'معروض';
            return 'غير محدد';
        }

        async function classifyAndSeparateFiles() {
            showMessage('info', '🔄 جاري تصنيف المستندات إلى طلبات وعروض...');
            requests = [];
            offers = [];

            for (const file of allTextFiles) {
                try {
                    let textContent = '';
                    if (file.data && file.data.includes(',')) {
                        const base64 = file.data.split(',')[1];
                        if (base64) {
                            textContent = decodeURIComponent(escape(atob(base64)));
                        }
                    }
                    if (!textContent) continue;

                    if (file.name.toLowerCase().endsWith('.json')) {
                        const json = JSON.parse(textContent);
                        if (json.messages && Array.isArray(json.messages)) {
                            json.messages.forEach(message => {
                                const messageText = message.original_text || '';
                                if (messageText.trim()) {
                                    const type = classifyMessageType(messageText);
                                    if (type !== 'غير محدد') {
                                        const info = {
                                            text: messageText,
                                            source: file.name,
                                            phones: message.phones || [],
                                            prices: message.prices || []
                                        };
                                        if (type === 'مطلوب') requests.push(info);
                                        else if (type === 'معروض') offers.push(info);
                                    }
                                }
                            });
                        }
                    } else {
                        const type = classifyMessageType(textContent);
                        if (type !== 'غير محدد') {
                            const info = {
                                text: textContent,
                                source: file.name
                            };
                            if (type === 'مطلوب') requests.push(info);
                            else if (type === 'معروض') offers.push(info);
                        }
                    }
                } catch (e) {
                    console.error(`❌ Failed to process file ${file.name}:`, e);
                }
            }

            document.getElementById('request-count').textContent = requests.length;
            document.getElementById('offer-count').textContent = offers.length;
            console.log(`📊 Classification complete: ${requests.length} requests, ${offers.length} offers.`);
            showMessage('success', `✅ تم التصنيف: ${requests.length} طلب، ${offers.length} عرض.`);
        }

        // ===================== OpenAI Prompt and API Call =====================
        function createMatchingPrompt(requestsBatch, offersBatch) {
            let prompt = `أنت خبير مطابقة عقارية محترف. مهمتك هي تحليل قائمة الطلبات وقائمة العروض التالية وإيجاد أفضل المطابقات الممكنة.

### قواعد المطابقة:
1. **الهدف**: طابق بين "طلب" و "عرض". لا تطابق طلب مع طلب أو عرض مع عرض.
2. **المعايير الأساسية**: يجب أن يتطابق نوع العقار والمنطقة.
3. **جودة المطابقة**: صنّف المطابقة إلى "ممتازة" أو "جيدة" أو "مقبولة".

### تعليمات الإخراج:
أرجع **مصفوفة JSON فقط** (بدون أي نص إضافي). كل عنصر:
{
  "quality": "...",
  "property_type": "...",
  "area": "...",
  "requested_price": "...",
  "offered_price": "...",
  "requester_phone": "...",
  "offerer_phone": "...",
  "reason": "...",
  "request_text": "...",
  "offer_text": "..."
}
إذا لا توجد مطابقات أرجع [] فقط.

---
### الطلبات:
`;
            requestsBatch.forEach((req, i) => {
                prompt += `\n--- طلب ${i+1} ---\n${req.text}\n`;
            });
            prompt += `\n---\n### العروض:\n`;
            offersBatch.forEach((off, i) => {
                prompt += `\n--- عرض ${i+1} ---\n${off.text}\n`;
            });
            prompt += `\n---\nأعد الآن المصفوفة فقط.`;
            return prompt;
        }

        async function callOpenAI(prompt) {
            const key = await ensureApiKeyOrFail();
            console.log(`\n🤖 Calling OpenAI with prompt length: ${prompt.length}`);
            showMessage('info', '⏳ جاري إرسال البيانات إلى OpenAI... قد يستغرق بعض الوقت.');

            try {
                const res = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        temperature: 0.3,
                        max_tokens: 4000,
                        messages: [{
                            role: 'system',
                            content: 'أعد استجابة JSON فقط وبدون أي مقدمة أو شرح.'
                        }, {
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!res.ok) {
                    const errorBody = await res.text();
                    console.error("❌ OpenAI Error:", {
                        status: res.status,
                        body: errorBody
                    });
                    if (res.status === 401) throw new Error('مفتاح OpenAI غير صحيح.');
                    if (res.status === 429) throw new Error('تم تجاوز حدود المعدل/الكوتا (Rate Limit).');
                    throw new Error(`خطأ من OpenAI: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                let content = data?.choices?.[0]?.message?.content || '[]';
                console.log(`📝 OpenAI raw response:`, content);

                content = content.replace(/```json|```/g, '').trim();
                return JSON.parse(content);

            } catch (error) {
                console.error('❌ Error during OpenAI call or parsing:', error);
                showMessage('error', `❌ فشل في معالجة الاستجابة من OpenAI: ${error.message}`);
                return null;
            }
        }

        // ===================== Display Results =====================
        function displayMatches(matches) {
            const container = document.getElementById('matches-container');
            const noResultsP = document.getElementById('no-results');
            container.innerHTML = '';

            if (!matches || matches.length === 0) {
                noResultsP.textContent = '✅ اكتمل التحليل. لم يتم العثور على مطابقات قوية.';
                noResultsP.style.display = 'block';
                return;
            }

            noResultsP.style.display = 'none';

            matches.forEach(match => {
                const card = document.createElement('div');
                card.className = 'match-card';
                card.innerHTML = `
                    <div class="match-header">
                        <h3>مطابقة ${match.property_type || 'عقارية'}</h3>
                        <span class="match-quality ${match.quality || ''}">${match.quality || 'غير محدد'}</span>
                    </div>
                    <div class="match-details">
                        <div class="detail-item"><strong>المنطقة:</strong> ${match.area || 'غير محدد'}</div>
                        <div class="detail-item"><strong>سعر الطلب:</strong> ${match.requested_price || 'غير محدد'}</div>
                        <div class="detail-item"><strong>سعر العرض:</strong> ${match.offered_price || 'غير محدد'}</div>
                        <div class="detail-item"><strong>رقم الطالب:</strong> ${match.requester_phone || 'غير متوفر'}</div>
                        <div class="detail-item"><strong>رقم العارض:</strong> ${match.offerer_phone || 'غير متوفر'}</div>
                    </div>
                    <div class="match-reason"><strong>💡 سبب المطابقة:</strong> ${match.reason || 'لا يوجد سبب محدد.'}</div>
                    <div class="match-texts">
                        <div class="text-box"><h4>📝 نص الطلب</h4><p>${match.request_text || ''}</p></div>
                        <div class="text-box"><h4>🏠 نص العرض</h4><p>${match.offer_text || ''}</p></div>
                    </div>`;
                container.appendChild(card);
            });
        }

        // ===================== Main Execution Function =====================
        async function runMatching() {
            const startBtn = document.getElementById('start-matching-btn');
            const loader = document.getElementById('loader');
            const matchesContainer = document.getElementById('matches-container');
            const noResults = document.getElementById('no-results');

            startBtn.disabled = true;
            startBtn.textContent = '⏳ جاري التحليل...';
            loader.style.display = 'block';
            matchesContainer.innerHTML = '';
            noResults.style.display = 'none';

            try {
                await ensureApiKeyOrFail();
                await loadDataForMatching();
                await classifyAndSeparateFiles();

                if (requests.length === 0 || offers.length === 0) {
                    throw new Error('يجب وجود طلبات وعروض لإجراء المطابقة.');
                }

                const prompt = createMatchingPrompt(requests, offers);
                const matches = await callOpenAI(prompt);

                if (matches) {
                    displayMatches(matches);
                    if (matches.length > 0) {
                        showMessage('success', `🎉 اكتمل التحليل! تم العثور على ${matches.length} مطابقة.`);
                    } else {
                        showMessage('info', '✅ اكتمل التحليل. لم يتم العثور على مطابقات قوية.');
                    }
                } else {
                    // Error message is already shown by callOpenAI
                    noResults.textContent = 'حدث خطأ أثناء التحليل. يرجى مراجعة الـ Console.';
                    noResults.style.display = 'block';
                }
            } catch (error) {
                console.error("Matching process failed:", error);
                showMessage('error', `فشلت العملية: ${error.message}`);
                noResults.textContent = `فشلت العملية: ${error.message}`;
                noResults.style.display = 'block';
            } finally {
                startBtn.disabled = false;
                startBtn.textContent = '🚀 بدء المطابقة بالذكاء الاصطناعي';
                loader.style.display = 'none';
            }
        }
    </script>
</body>

</html>
