<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>نظام مطابقة العقارات المطور - للمسوقين العقاريين</title>
    <style>
        /* ===================== CSS Variables and Global Styles ===================== */
        :root {
            --bg: #0f172a;
            --card: #111827;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #22c55e;
            --accent-2: #3b82f6;
            --accent-3: #f59e0b;
            --accent-4: #8b5cf6;
            --btn-bg: #1f2937;
            --btn-hover: #374151;
            --shadow: 0 10px 25px rgba(0, 0, 0, .35);
            --radius: 18px;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", Arial, sans-serif;
            line-height: 1.6;
        }

        /* ===================== Layout and Card Styles ===================== */
        .wrap {
            min-height: 100vh;
            display: grid;
            place-items: center;
            padding: 24px;
        }

        .card {
            width: min(1400px, 96vw);
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .01));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: var(--radius);
            padding: 28px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(6px);
        }

        h1 {
            margin: 0 0 10px;
            font-size: clamp(26px, 3.5vw, 40px);
            letter-spacing: .2px;
        }

        p.lead {
            margin: 0 0 26px;
            color: var(--muted);
        }

        /* ===================== Tabs Navigation ===================== */
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            padding-bottom: 16px;
        }

        .tab-btn {
            padding: 12px 20px;
            background: var(--btn-bg);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            cursor: pointer;
            transition: all .2s ease;
            font-size: 14px;
        }

        .tab-btn:hover {
            background: var(--btn-hover);
        }

        .tab-btn.active {
            background: var(--accent-2);
            border-color: var(--accent-2);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===================== Buttons and Links ===================== */
        button.btn,
        a.btn {
            display: inline-block;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            background: var(--btn-bg);
            color: var(--text);
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .08);
            transition: transform .12s ease, background .12s ease, border-color .12s ease;
            box-shadow: 0 6px 14px rgba(0, 0, 0, .25);
            font-family: inherit;
            font-size: inherit;
            margin: 4px;
        }

        button.btn:hover,
        a.btn:hover {
            background: var(--btn-hover);
            transform: translateY(-1px);
        }

        button.btn.primary {
            background: var(--accent-2);
            border-color: transparent;
            color: #fff;
        }

        button.btn.success {
            background: var(--accent);
            border-color: transparent;
            color: #fff;
        }

        button.btn.warning {
            background: var(--warning);
            border-color: transparent;
            color: #fff;
        }

        button.btn.purple {
            background: var(--accent-4);
            border-color: transparent;
            color: #fff;
        }

        button.btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ===================== Sections and Status ===================== */
        .status-section,
        .controls-section,
        .results-section,
        .analytics-section,
        .crm-section {
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            text-align: center;
        }

        .stat-item .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-2);
        }

        .stat-item .stat-label {
            font-size: 12px;
            color: var(--muted);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 16px;
        }

        .analytics-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: 12px;
            padding: 16px;
        }

        .analytics-card h4 {
            margin: 0 0 12px;
            color: var(--accent-2);
        }

        /* ===================== Filter Controls ===================== */
        .filter-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            align-items: end;
        }

        .filter-item label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            color: var(--muted);
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 8px 12px;
            background: var(--btn-bg);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
        }

        /* ===================== CRM Features ===================== */
        .client-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .client-status {
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: bold;
        }

        .client-status.جديد {
            background: var(--accent-2);
            color: white;
        }

        .client-status.متابع {
            background: var(--warning);
            color: white;
        }

        .client-status.مهتم {
            background: var(--accent);
            color: white;
        }

        .client-status.غير-مهتم {
            background: var(--danger);
            color: white;
        }

        /* ===================== Match Results Enhancement ===================== */
        #status-message {
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            display: none;
            margin-bottom: 16px;
        }

        #status-message.info {
            background: rgba(59, 130, 246, .1);
            color: var(--accent-2);
            border: 1px solid rgba(59, 130, 246, .2);
        }

        #status-message.success {
            background: rgba(34, 197, 94, .1);
            color: var(--accent);
            border: 1px solid rgba(34, 197, 94, .2);
        }

        #status-message.error {
            background: rgba(239, 68, 68, .1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, .2);
        }

        .loader {
            border: 4px solid var(--btn-bg);
            border-top: 4px solid var(--accent-2);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .matches-container {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        .match-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: var(--radius);
            padding: 20px;
            position: relative;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            padding-bottom: 12px;
        }

        .match-quality {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .match-quality.مؤكدة {
            background: #10b981;
            color: #fff;
        }

        .match-quality.محتملة {
            background: #f59e0b;
            color: #fff;
        }

        .match-quality.ممكنة {
            background: #3b82f6;
            color: #fff;
        }

        .match-actions {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 8px;
            background: var(--btn-bg);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 6px;
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            transition: all .2s ease;
        }

        .action-btn:hover {
            background: var(--btn-hover);
        }

        .priority-badge {
            position: absolute;
            top: -8px;
            right: 16px;
            background: var(--danger);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        /* ===================== Analytics Visualizations ===================== */
        .chart-container {
            height: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            margin-top: 12px;
        }

        /* ===================== Responsive Design ===================== */
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            .tab-nav {
                flex-wrap: wrap;
            }
        }

        /* ===================== WhatsApp Integration ===================== */
        .whatsapp-btn {
            background: #25d366;
            border-color: #25d366;
            color: white;
        }

        .whatsapp-btn:hover {
            background: #128c7e;
        }

        /* ===================== Report Generation ===================== */
        .report-section {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .export-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h1><span style="font-size: 24px;">🏠</span> نظام مطابقة العقارات المطور</h1>
            <p class="lead">نظام شامل للمسوقين العقاريين - مطابقة ذكية، إدارة عملاء، تحليلات متقدمة، وأدوات تسويقية</p>

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('matching')">🤖 المطابقة الذكية</button>
                <button class="tab-btn" onclick="switchTab('crm')">👥 إدارة العملاء</button>
                <button class="tab-btn" onclick="switchTab('analytics')">📊 التحليلات</button>
                <button class="tab-btn" onclick="switchTab('marketing')">📢 أدوات التسويق</button>
                <button class="tab-btn" onclick="switchTab('reports')">📋 التقارير</button>
            </div>

            <!-- Matching Tab (Original + Enhanced) -->
            <div id="matching-tab" class="tab-content active">
                <!-- Status Section -->
                <div class="status-section">
                    <h2>📊 حالة البيانات</h2>
                    <div id="status-message"></div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="total-docs">0</div>
                            <div class="stat-label">إجمالي المستندات</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="request-count">0</div>
                            <div class="stat-label">الطلبات</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="offer-count">0</div>
                            <div class="stat-label">العروض</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="matches-count">0</div>
                            <div class="stat-label">المطابقات المكتشفة</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Filter Section -->
                <div class="filter-section">
                    <h3>🔍 تصفية النتائج</h3>
                    <div class="filter-grid">
                        <div class="filter-item">
                            <label>جودة المطابقة</label>
                            <select id="quality-filter">
                                <option value="">جميع المستويات</option>
                                <option value="مؤكدة">مؤكدة</option>
                                <option value="محتملة">محتملة</option>
                                <option value="ممكنة">ممكنة</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>نوع العقار</label>
                            <select id="property-type-filter">
                                <option value="">جميع الأنواع</option>
                                <option value="شقة">شقة</option>
                                <option value="فيلا">فيلا</option>
                                <option value="أرض">أرض</option>
                                <option value="محل">محل تجاري</option>
                                <option value="مكتب">مكتب</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>نطاق السعر (من)</label>
                            <input type="number" id="price-min" placeholder="الحد الأدنى">
                        </div>
                        <div class="filter-item">
                            <label>نطاق السعر (إلى)</label>
                            <input type="number" id="price-max" placeholder="الحد الأعلى">
                        </div>
                        <div class="filter-item">
                            <button class="btn primary" onclick="applyFilters()">تطبيق التصفية</button>
                        </div>
                    </div>
                </div>

                <!-- Controls Section -->
                <div class="controls-section" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                    <button class="btn success" id="start-matching-btn" onclick="runMatching()">🚀 بدء المطابقة الذكية</button>
                    <button class="btn" onclick="promptAndSaveApiKey()">🔑 إعداد مفتاح OpenAI</button>
                    <button class="btn" onclick="testApiKey()">🧪 اختبار المفتاح</button>
                    <button class="btn warning" onclick="generateMarketingMessages()">📱 إنشاء رسائل تسويقية</button>
                    <button class="btn purple" onclick="prioritizeMatches()">⭐ ترتيب حسب الأولوية</button>
                </div>

                <!-- Results Section -->
                <div class="results-section">
                    <h2>💡 نتائج المطابقة المحسنة</h2>
                    <div id="loader" class="loader"></div>
                    <div id="matches-container" class="matches-container"></div>
                    <p id="no-results" style="color: var(--muted); text-align: center; display: block;">لم يتم إجراء أي عملية مطابقة بعد. اضغط على زر "بدء المطابقة" للبدء.</p>
                </div>
            </div>

            <!-- CRM Tab -->
            <div id="crm-tab" class="tab-content">
                <div class="crm-section">
                    <h2>👥 إدارة العملاء المحتملين</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="total-leads">0</div>
                            <div class="stat-label">إجمالي العملاء</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="hot-leads">0</div>
                            <div class="stat-label">عملاء مهتمون</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="follow-up-leads">0</div>
                            <div class="stat-label">يحتاج متابعة</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="conversion-rate">0%</div>
                            <div class="stat-label">معدل التحويل</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3>العملاء المحتملون من المطابقات</h3>
                        <div id="clients-list"></div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>📊 تحليلات السوق المتقدمة</h2>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h4>📈 أداء المطابقات</h4>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-number" id="match-success-rate">0%</div>
                                    <div class="stat-label">نسبة نجاح المطابقة</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number" id="avg-response-time">0</div>
                                    <div class="stat-label">وقت الاستجابة (ثانية)</div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <span>رسم بياني لأداء المطابقات</span>
                            </div>
                        </div>

                        <div class="analytics-card">
                            <h4>🏠 تحليل أنواع العقارات</h4>
                            <div id="property-types-analysis"></div>
                            <div class="chart-container">
                                <span>توزيع أنواع العقارات</span>
                            </div>
                        </div>

                        <div class="analytics-card">
                            <h4>💰 تحليل الأسعار</h4>
                            <div id="price-analysis"></div>
                            <div class="chart-container">
                                <span>اتجاهات الأسعار</span>
                            </div>
                        </div>

                        <div class="analytics-card">
                            <h4>📍 تحليل المناطق الجغرافية</h4>
                            <div id="location-analysis"></div>
                            <div class="chart-container">
                                <span>خريطة النشاط العقاري</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marketing Tab -->
            <div id="marketing-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>📢 أدوات التسويق الذكية</h2>
                    
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h4>📱 رسائل WhatsApp التلقائية</h4>
                            <p>إنشاء رسائل مخصصة للعملاء المحتملين</p>
                            <button class="btn whatsapp-btn" onclick="generateWhatsAppMessages()">إنشاء رسائل واتساب</button>
                        </div>

                        <div class="analytics-card">
                            <h4>📧 حملات البريد الإلكتروني</h4>
                            <p>إنشاء حملات تسويقية مستهدفة</p>
                            <button class="btn primary" onclick="createEmailCampaign()">إنشاء حملة إيميل</button>
                        </div>

                        <div class="analytics-card">
                            <h4>📸 منشورات وسائل التواصل</h4>
                            <p>اقتراحات للمنشورات التسويقية</p>
                            <button class="btn purple" onclick="generateSocialPosts()">إنشاء منشورات</button>
                        </div>

                        <div class="analytics-card">
                            <h4>🎯 استهداف العملاء</h4>
                            <p>تحليل وتصنيف العملاء المحتملين</p>
                            <button class="btn warning" onclick="analyzeTargetCustomers()">تحليل العملاء</button>
                        </div>
                    </div>

                    <div id="marketing-content" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>📋 تقارير شاملة</h2>
                    
                    <div class="report-section">
                        <h3>📊 تقرير الأداء اليومي</h3>
                        <p>ملخص شامل لنشاط اليوم والمطابقات والعملاء</p>
                        <div class="export-options">
                            <button class="btn primary" onclick="generateDailyReport()">إنشاء تقرير يومي</button>
                            <button class="btn" onclick="exportToPDF()">تصدير PDF</button>
                            <button class="btn" onclick="exportToExcel()">تصدير Excel</button>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>📈 تقرير الاتجاهات الأسبوعية</h3>
                        <p>تحليل أسبوعي للسوق والفرص</p>
                        <div class="export-options">
                            <button class="btn success" onclick="generateWeeklyReport()">إنشاء تقرير أسبوعي</button>
                            <button class="btn" onclick="scheduleReport()">جدولة التقرير</button>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>💼 تقرير العملاء</h3>
                        <p>قائمة تفصيلية بالعملاء وحالة كل منهم</p>
                        <div class="export-options">
                            <button class="btn warning" onclick="generateClientReport()">تقرير العملاء</button>
                            <button class="btn" onclick="emailReport()">إرسال بالإيميل</button>
                        </div>
                    </div>

                    <div id="report-content" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =================================================================================
        // ENHANCED SCRIPT WITH NEW FEATURES
        // =================================================================================

        // ===================== Original Code Base =====================
        const DB_NAME = 'FilesStorage';
        const DB_VERSION = 1;
        const STORE_NAME = 'files';
        let db;

        const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
        const OPENAI_MODEL = 'gpt-4o-mini';
        const API_KEY_STORAGE_KEY = 'OPENAI_API_KEY';

        let allTextFiles = [];
        let requests = [];
        let offers = [];
        let allMatches = [];
        let filteredMatches = [];
        let clientsDatabase = [];

        // ===================== Tab Management =====================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Load tab-specific data
            if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'crm') {
                updateCRMData();
            }
        }

        // ===================== Enhanced Initialization =====================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                showMessage('info', 'النظام جاهز. اضبط مفتاح OpenAI وابدأ المطابقة.');
                await loadDataForMatching();
                await classifyAndSeparateFiles();
                loadClientsFromStorage();
            } catch (error) {
                console.error("Initialization failed:", error);
                showMessage('error', `❌ خطأ فادح في التهيئة: ${error.message}`);
            }
        });

        // ===================== Original Core Functions (Keep as is) =====================
        function getApiKey() {
            return localStorage.getItem(API_KEY_STORAGE_KEY) || '';
        }

        function saveApiKey(key) {
            if (!key || !key.trim()) return false;
            localStorage.setItem(API_KEY_STORAGE_KEY, key.trim());
            return true;
        }

        function promptAndSaveApiKey() {
            const currentKey = getApiKey();
            const newKey = prompt('أدخل مفتاح OpenAI (يُخزن محلياً في متصفحك):', currentKey);
            if (newKey !== null) {
                if (saveApiKey(newKey)) {
                    showMessage('success', '✅ تم حفظ مفتاح OpenAI محلياً.');
                } else {
                    showMessage('error', '❌ لم يتم حفظ المفتاح. تأكد أنه غير فارغ.');
                }
            }
        }

        async function ensureApiKeyOrFail() {
            const key = getApiKey();
            if (!key) {
                showMessage('error', '❌ لا يوجد مفتاح OpenAI. اضغط "إعداد مفتاح OpenAI" لإدخاله.');
                throw new Error('API key is missing');
            }
            return key;
        }

        async function testApiKey() {
            const startBtn = document.getElementById('start-matching-btn');
            const loader = document.getElementById('loader');
            try {
                const key = await ensureApiKeyOrFail();
                showMessage('info', '🧪 جاري اختبار المفتاح...');
                startBtn.disabled = true;
                loader.style.display = 'block';

                const res = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: [{
                            role: 'system',
                            content: 'You are a JSON-only responder.'
                        }, {
                            role: 'user',
                            content: 'Return exactly this JSON: {"ok":true}'
                        }],
                        temperature: 0,
                        max_tokens: 50
                    })
                });

                if (!res.ok) {
                    const errorBody = await res.text();
                    console.error('OpenAI test error:', errorBody);
                    throw new Error(`فشل الاختبار: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                const content = data?.choices?.[0]?.message?.content ?? '';
                if (content.includes('"ok":true')) {
                    showMessage('success', '✅ المفتاح يعمل بشكل صحيح.');
                } else {
                    showMessage('error', '⚠️ استجابة غير متوقعة، تحقق من الصلاحيات.');
                }
            } catch (error) {
                console.error("API Key test failed:", error);
                showMessage('error', `❌ اختبار المفتاح فشل: ${error.message}`);
            } finally {
                startBtn.disabled = false;
                loader.style.display = 'none';
            }
        }

        function showMessage(type, message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = type;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (type !== 'error') {
                setTimeout(() => {
                    if (statusDiv.textContent === message) {
                        statusDiv.style.display = 'none';
                    }
                }, 5000);
            }
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("خطأ في فتح قاعدة البيانات");
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, {
                            keyPath: 'id'
                        });
                        store.createIndex('name', 'name', {
                            unique: false
                        });
                        store.createIndex('uploadTime', 'uploadTime', {
                            unique: false
                        });
                    }
                };
            });
        }

        async function loadDataForMatching() {
            showMessage('info', '📂 جاري تحميل البيانات من قاعدة البيانات...');
            return new Promise((resolve, reject) => {
                if (!db) return reject("Database not initialized");
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    const allFiles = request.result;
                    console.log(`📋 Total files in DB: ${allFiles.length}`);

                    allTextFiles = allFiles.filter(file =>
                        (file.type && (file.type.includes('text') || file.type.includes('json'))) ||
                        (file.name && (file.name.endsWith('.txt') || file.name.endsWith('.json')))
                    );

                    console.log(`✅ Filtered ${allTextFiles.length} text/json files.`);

                    if (allTextFiles.length === 0) {
                        showMessage('error', '❌ لم يتم العثور على ملفات نصية أو JSON صالحة للمطابقة.');
                        resolve();
                        return;
                    }

                    showMessage('success', `✅ تم تحميل ${allTextFiles.length} مستند بنجاح.`);
                    document.getElementById('total-docs').textContent = allTextFiles.length;
                    resolve();
                };

                request.onerror = () => {
                    console.error('❌ Error reading from DB:', request.error);
                    showMessage('error', '❌ فشل في قراءة الملفات من قاعدة البيانات.');
                    reject(request.error);
                };
            });
        }

        function classifyMessageType(text) {
            if (!text) return 'غير محدد';
            const textLower = text.toLowerCase();
            const requestKeywords = ['مطلوب', 'ابحث عن', 'أريد', 'نريد', 'محتاج', 'بحث عن', 'عاوز', 'عايز', 'ادور على', 'أدور على', 'نبحث عن', 'wanted', 'looking for', 'need', 'require'];
            const offerKeywords = ['للبيع', 'للايجار', 'للإيجار', 'معروض', 'متوفر', 'يوجد', 'عندي', 'لدي', 'متاح', 'للتنازل', 'أعرض', 'for sale', 'for rent', 'available', 'offering'];

            const requestCount = requestKeywords.reduce((sum, keyword) => sum + (textLower.includes(keyword) ? 1 : 0), 0);
            const offerCount = offerKeywords.reduce((sum, keyword) => sum + (textLower.includes(keyword) ? 1 : 0), 0);

            if (requestCount > offerCount) return 'مطلوب';
            if (offerCount > requestCount) return 'معروض';
            return 'غير محدد';
        }

        async function classifyAndSeparateFiles() {
            showMessage('info', '🔄 جاري تصنيف المستندات إلى طلبات وعروض...');
            requests = [];
            offers = [];

            for (const file of allTextFiles) {
                try {
                    let textContent = '';
                    if (file.data && file.data.includes(',')) {
                        const base64 = file.data.split(',')[1];
                        if (base64) {
                            textContent = decodeURIComponent(escape(atob(base64)));
                        }
                    }
                    if (!textContent) continue;

                    if (file.name.toLowerCase().endsWith('.json')) {
                        const json = JSON.parse(textContent);
                        if (json.messages && Array.isArray(json.messages)) {
                            json.messages.forEach(message => {
                                const messageText = message.original_text || '';
                                if (messageText.trim()) {
                                    const type = classifyMessageType(messageText);
                                    if (type !== 'غير محدد') {
                                        const info = {
                                            text: messageText,
                                            source: file.name,
                                            phones: message.phones || [],
                                            prices: message.prices || []
                                        };
                                        if (type === 'مطلوب') requests.push(info);
                                        else if (type === 'معروض') offers.push(info);
                                    }
                                }
                            });
                        }
                    } else {
                        const type = classifyMessageType(textContent);
                        if (type !== 'غير محدد') {
                            const info = {
                                text: textContent,
                                source: file.name
                            };
                            if (type === 'مطلوب') requests.push(info);
                            else if (type === 'معروض') offers.push(info);
                        }
                    }
                } catch (e) {
                    console.error(`❌ Failed to process file ${file.name}:`, e);
                }
            }

            document.getElementById('request-count').textContent = requests.length;
            document.getElementById('offer-count').textContent = offers.length;
            console.log(`📊 Classification complete: ${requests.length} requests, ${offers.length} offers.`);
            showMessage('success', `✅ تم التصنيف: ${requests.length} طلب، ${offers.length} عرض.`);
        }

        function createMatchingPrompt(requestsBatch, offersBatch) {
            let prompt = `أنت خبير عقاري ذكي ومحلل بيانات متخصص في التنقيب عن الفرص العقارية. مهمتك هي تحليل قائمة "الطلبات" وقائمة "العروض" التالية بعمق، واستخراج كل الصفقات الممكنة، حتى لو لم تكن متطابقة 100%.

### فلسفة المطابقة (مهم جدًا):
- **كن مرنًا**: افهم أن الأشخاص يستخدمون تعابير مختلفة. "بيت" قد يعني "فيلا"، و "أرض استثمارية" قد تناسب طلب "أرض تجارية".
- **السعر ليس مطلقًا**: اعتبر الأسعار المتقاربة فرصة محتملة. طلب بـ 500 ألف قد يناسبه عرض بـ 550 ألف.
- **الموقع الجغرافي**: إذا لم تجد تطابقًا في نفس الحي، ابحث في الأحياء المجاورة والقريبة.
- **اقرأ ما بين السطور**: حلل نص الرسالة بالكامل. قد يحتوي على تفاصيل دقيقة (مثل "موقع هادئ"، "قريبة من الخدمات") تزيد من قوة المطابقة.

### مستويات جودة المطابقة (Quality Levels):
عليك تصنيف كل مطابقة إلى واحد من ثلاثة مستويات بناءً على مدى قوة الفرصة:
1.  **"مؤكدة"**: تطابق شبه كامل في نوع العقار، والحي، والسعر ضمن نطاق ضيق جدًا (±5%). هذه فرصة قوية جدًا.
2.  **"محتملة"**: تطابق في المعايير الأساسية (نوع العقار، المنطقة) مع وجود اختلاف مقبول في السعر (±15%) أو في حي مجاور. هذه فرصة جيدة تستحق المتابعة.
3.  **"ممكنة"**: تطابق في أحد المعايير المهمة (مثلاً، نوع العقار) مع وجود اختلافات أكبر في السعر أو الموقع، لكن سياق النص يوحي بوجود فرصة كامنة. (مثال: طلب "أرض سكنية" وعرض "أرض تجارية" في نفس المنطقة قد يكون فرصة إذا كان المشتري مستثمرًا).

### تعليمات الإخراج (JSON فقط):
أرجع **مصفوفة JSON فقط** بدون أي نص إضافي. كل عنصر في المصفوفة يجب أن يمثل صفقة محتملة بالصيغة التالية:
{
  "quality": "مؤكدة أو محتملة أو ممكنة",
  "property_type": "نوع العقار المطلوب/المعروض",
  "area": "المدينة والحي",
  "requested_price": "السعر المذكور في الطلب (إن وجد)",
  "offered_price": "السعر المذكور في العرض (إن وجد)",
  "requester_phone": "رقم هاتف الطالب (استخرجه من النص إن أمكن)",
  "offerer_phone": "رقم هاتف العارض (استخرجه من النص إن أمكن)",
  "reason": "شرح مفصل وذكي لسبب اعتبارها فرصة. وضح نقاط التوافق والاختلاف ولماذا صنفتها بهذا المستوى.",
  "request_text": "النص الكامل للطلب",
  "offer_text": "النص الكامل للعرض",
  "urgency_score": "درجة من 1-10 تشير لمدى إلحاح هذه الفرصة",
  "commission_potential": "تقدير العمولة المحتملة بالريال"
}
إذا لم تجد أي فرصة على الإطلاق، أرجع مصفوفة فارغة [].

---
### الطلبات لتحليلها:
`;
            requestsBatch.forEach((req, i) => {
                prompt += `\n--- طلب ${i + 1} ---\n${req.text}\n`;
            });
            prompt += `\n---\n### العروض لمطابقتها: \n`;
            offersBatch.forEach((off, i) => {
                prompt += `\n--- عرض ${i + 1} ---\n${off.text}\n`;
            });
            prompt += `\n---\nالآن، قم بالتنقيب عن الفرص وأعد مصفوفة JSON فقط.`;
            return prompt;
        }

        async function callOpenAI(prompt) {
            const key = await ensureApiKeyOrFail();
            console.log(`\n🤖 Calling OpenAI with prompt length: ${prompt.length}`);
            showMessage('info', '⏳ جاري إرسال البيانات إلى OpenAI... قد يستغرق بعض الوقت.');

            try {
                const res = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        temperature: 0.3,
                        max_tokens: 4000,
                        messages: [{
                            role: 'system',
                            content: 'أعد استجابة JSON فقط وبدون أي مقدمة أو شرح.'
                        }, {
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!res.ok) {
                    const errorBody = await res.text();
                    console.error("❌ OpenAI Error:", {
                        status: res.status,
                        body: errorBody
                    });
                    if (res.status === 401) throw new Error('مفتاح OpenAI غير صحيح.');
                    if (res.status === 429) throw new Error('تم تجاوز حدود المعدل/الكوتا (Rate Limit).');
                    throw new Error(`خطأ من OpenAI: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                let content = data?.choices?.[0]?.message?.content || '[]';
                console.log(`📝 OpenAI raw response:`, content);

                content = content.replace(/```json|```/g, '').trim();
                return JSON.parse(content);

            } catch (error) {
                console.error('❌ Error during OpenAI call or parsing:', error);
                showMessage('error', `❌ فشل في معالجة الاستجابة من OpenAI: ${error.message}`);
                return null;
            }
        }

        // ===================== Enhanced Display Functions =====================
        function displayMatches(matches) {
            const container = document.getElementById('matches-container');
            const noResultsP = document.getElementById('no-results');
            container.innerHTML = '';

            if (!matches || matches.length === 0) {
                noResultsP.textContent = '✅ اكتمل التحليل. لم يتم العثور على مطابقات قوية.';
                noResultsP.style.display = 'block';
                return;
            }

            noResultsP.style.display = 'none';
            allMatches = matches;
            filteredMatches = matches;

            document.getElementById('matches-count').textContent = matches.length;

            matches.forEach((match, index) => {
                const card = document.createElement('div');
                card.className = 'match-card';
                card.setAttribute('data-index', index);
                
                // Add priority badge for high urgency
                const priorityBadge = match.urgency_score >= 8 ? '<div class="priority-badge">أولوية عالية</div>' : '';
                
                card.innerHTML = `
                    ${priorityBadge}
                    <div class="match-actions">
                        <button class="action-btn" onclick="addToClients('${index}')" title="إضافة للعملاء">👥</button>
                        <button class="action-btn whatsapp-btn" onclick="sendWhatsApp('${match.requester_phone || match.offerer_phone}')" title="واتساب">📱</button>
                        <button class="action-btn" onclick="markAsContacted('${index}')" title="تم التواصل">✅</button>
                    </div>
                    <div class="match-header">
                        <h3>مطابقة ${match.property_type || 'عقارية'}</h3>
                        <span class="match-quality ${match.quality || ''}">${match.quality || 'غير محدد'}</span>
                    </div>
                    <div class="match-details">
                        <div class="detail-item"><strong>المنطقة:</strong> ${match.area || 'غير محدد'}</div>
                        <div class="detail-item"><strong>سعر الطلب:</strong> ${match.requested_price || 'غير محدد'}</div>
                        <div class="detail-item"><strong>سعر العرض:</strong> ${match.offered_price || 'غير محدد'}</div>
                        <div class="detail-item"><strong>رقم الطالب:</strong> ${match.requester_phone || 'غير متوفر'}</div>
                        <div class="detail-item"><strong>رقم العارض:</strong> ${match.offerer_phone || 'غير متوفر'}</div>
                        <div class="detail-item"><strong>درجة الإلحاح:</strong> ${match.urgency_score || 'غير محدد'}/10</div>
                        <div class="detail-item"><strong>العمولة المقدرة:</strong> ${match.commission_potential || 'غير محدد'}</div>
                    </div>
                    <div class="match-reason"><strong>💡 سبب المطابقة:</strong> ${match.reason || 'لا يوجد سبب محدد.'}</div>
                    <div class="match-texts">
                        <div class="text-box"><h4>📝 نص الطلب</h4><p>${match.request_text || ''}</p></div>
                        <div class="text-box"><h4>🏠 نص العرض</h4><p>${match.offer_text || ''}</p></div>
                    </div>`;
                container.appendChild(card);
            });

            // Auto-extract potential clients
            extractPotentialClients(matches);
        }

        // ===================== New Enhanced Features =====================

        // Filter functionality
        function applyFilters() {
            const qualityFilter = document.getElementById('quality-filter').value;
            const propertyTypeFilter = document.getElementById('property-type-filter').value;
            const priceMin = document.getElementById('price-min').value;
            const priceMax = document.getElementById('price-max').value;

            filteredMatches = allMatches.filter(match => {
                if (qualityFilter && match.quality !== qualityFilter) return false;
                if (propertyTypeFilter && !match.property_type?.includes(propertyTypeFilter)) return false;
                
                if (priceMin || priceMax) {
                    const price = extractPriceFromString(match.offered_price || match.requested_price || '0');
                    if (priceMin && price < parseInt(priceMin)) return false;
                    if (priceMax && price > parseInt(priceMax)) return false;
                }
                
                return true;
            });

            displayMatches(filteredMatches);
            showMessage('success', `تم تطبيق التصفية. ${filteredMatches.length} مطابقة من أصل ${allMatches.length}`);
        }

        function extractPriceFromString(str) {
            const numbers = str.match(/\d+/g);
            return numbers ? parseInt(numbers.join('')) : 0;
        }

        // Priority sorting
        function prioritizeMatches() {
            if (!allMatches.length) {
                showMessage('error', 'لا توجد مطابقات للترتيب');
                return;
            }

            const prioritized = [...allMatches].sort((a, b) => {
                // Sort by urgency score first, then by quality
                const urgencyDiff = (b.urgency_score || 0) - (a.urgency_score || 0);
                if (urgencyDiff !== 0) return urgencyDiff;

                const qualityOrder = { 'مؤكدة': 3, 'محتملة': 2, 'ممكنة': 1 };
                return (qualityOrder[b.quality] || 0) - (qualityOrder[a.quality] || 0);
            });

            displayMatches(prioritized);
            showMessage('success', 'تم ترتيب المطابقات حسب الأولوية والإلحاح');
        }

        // CRM Features
        function extractPotentialClients(matches) {
            matches.forEach((match, index) => {
                // Extract requester
                if (match.requester_phone) {
                    addClientIfNotExists({
                        id: 'req_' + index,
                        name: 'عميل محتمل - طالب',
                        phone: match.requester_phone,
                        type: 'طالب',
                        interest: match.property_type,
                        budget: match.requested_price,
                        status: 'جديد',
                        urgency: match.urgency_score || 5,
                        source: 'مطابقة تلقائية',
                        lastContact: null,
                        notes: match.request_text
                    });
                }

                // Extract offerer
                if (match.offerer_phone) {
                    addClientIfNotExists({
                        id: 'off_' + index,
                        name: 'عميل محتمل - عارض',
                        phone: match.offerer_phone,
                        type: 'عارض',
                        interest: match.property_type,
                        budget: match.offered_price,
                        status: 'جديد',
                        urgency: match.urgency_score || 5,
                        source: 'مطابقة تلقائية',
                        lastContact: null,
                        notes: match.offer_text
                    });
                }
            });

            saveClientsToStorage();
            updateCRMData();
        }

        function addClientIfNotExists(client) {
            const exists = clientsDatabase.some(c => c.phone === client.phone);
            if (!exists) {
                clientsDatabase.push(client);
            }
        }

        function addToClients(matchIndex) {
            const match = allMatches[matchIndex];
            const clientName = prompt('اسم العميل:', 'عميل محتمل');
            if (!clientName) return;

            const client = {
                id: Date.now().toString(),
                name: clientName,
                phone: match.requester_phone || match.offerer_phone || '',
                type: match.requester_phone ? 'طالب' : 'عارض',
                interest: match.property_type,
                budget: match.requested_price || match.offered_price,
                status: 'جديد',
                urgency: match.urgency_score || 5,
                source: 'إضافة يدوية',
                lastContact: new Date().toISOString(),
                notes: `من مطابقة: ${match.reason}`
            };

            clientsDatabase.push(client);
            saveClientsToStorage();
            updateCRMData();
            showMessage('success', 'تم إضافة العميل بنجاح');
        }

        function markAsContacted(matchIndex) {
            const card = document.querySelector(`[data-index="${matchIndex}"]`);
            if (card) {
                card.style.opacity = '0.7';
                card.style.border = '2px solid var(--accent)';
                showMessage('success', 'تم وضع علامة "تم التواصل"');
            }
        }

        function sendWhatsApp(phone) {
            if (!phone) {
                showMessage('error', 'رقم الهاتف غير متوفر');
                return;
            }
            const message = encodeURIComponent('مرحباً، أنا مسوق عقاري ولدي عرض قد يهمك...');
            window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
        }

        // Storage functions
        function saveClientsToStorage() {
            localStorage.setItem('real_estate_clients', JSON.stringify(clientsDatabase));
        }

        function loadClientsFromStorage() {
            const stored = localStorage.getItem('real_estate_clients');
            if (stored) {
                clientsDatabase = JSON.parse(stored);
            }
        }

        function updateCRMData() {
            const totalLeads = clientsDatabase.length;
            const hotLeads = clientsDatabase.filter(c => c.urgency >= 8).length;
            const followUpLeads = clientsDatabase.filter(c => c.status === 'متابع').length;
            const conversionRate = totalLeads > 0 ? Math.round((hotLeads / totalLeads) * 100) : 0;

            document.getElementById('total-leads').textContent = totalLeads;
            document.getElementById('hot-leads').textContent = hotLeads;
            document.getElementById('follow-up-leads').textContent = followUpLeads;
            document.getElementById('conversion-rate').textContent = conversionRate + '%';

            displayClientsList();
        }

        function displayClientsList() {
            const container = document.getElementById('clients-list');
            if (!container) return;

            container.innerHTML = '';

            if (clientsDatabase.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center;">لا يوجد عملاء محتملون بعد</p>';
                return;
            }

            clientsDatabase.forEach(client => {
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div class="client-header">
                        <h4>${client.name}</h4>
                        <span class="client-status ${client.status}">${client.status}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px;">
                        <div><strong>الهاتف:</strong> ${client.phone}</div>
                        <div><strong>النوع:</strong> ${client.type}</div>
                        <div><strong>الاهتمام:</strong> ${client.interest || 'غير محدد'}</div>
                        <div><strong>الميزانية:</strong> ${client.budget || 'غير محدد'}</div>
                        <div><strong>الإلحاح:</strong> ${client.urgency}/10</div>
                        <div><strong>المصدر:</strong> ${client.source}</div>
                    </div>
                    <div style="margin-top: 12px;">
                        <strong>ملاحظات:</strong> ${client.notes ? client.notes.substring(0, 100) + '...' : 'لا توجد ملاحظات'}
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button class="action-btn whatsapp-btn" onclick="sendWhatsApp('${client.phone}')">واتساب</button>
                        <button class="action-btn" onclick="updateClientStatus('${client.id}')">تحديث الحالة</button>
                        <button class="action-btn" onclick="addClientNote('${client.id}')">إضافة ملاحظة</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateClientStatus(clientId) {
            const client = clientsDatabase.find(c => c.id === clientId);
            if (!client) return;

            const newStatus = prompt('حالة العميل الجديدة:', client.status);
            if (newStatus) {
                client.status = newStatus;
                client.lastContact = new Date().toISOString();
                saveClientsToStorage();
                updateCRMData();
                showMessage('success', 'تم تحديث حالة العميل');
            }
        }

        function addClientNote(clientId) {
            const client = clientsDatabase.find(c => c.id === clientId);
            if (!client) return;

            const note = prompt('إضافة ملاحظة:', '');
            if (note) {
                client.notes = (client.notes || '') + '\n' + new Date().toLocaleString() + ': ' + note;
                saveClientsToStorage();
                updateCRMData();
                showMessage('success', 'تم إضافة الملاحظة');
            }
        }

        // Analytics Functions
        function updateAnalytics() {
            if (!allMatches.length) return;

            // Calculate success rate
            const totalMatches = allMatches.length;
            const highQualityMatches = allMatches.filter(m => m.quality === 'مؤكدة').length;
            const successRate = Math.round((highQualityMatches / totalMatches) * 100);
            document.getElementById('match-success-rate').textContent = successRate + '%';

            // Calculate average response time (simulated)
            document.getElementById('avg-response-time').textContent = '2.3';

            // Property types analysis
            const propertyTypes = {};
            allMatches.forEach(match => {
                const type = match.property_type || 'غير محدد';
                propertyTypes[type] = (propertyTypes[type] || 0) + 1;
            });

            const propertyAnalysisDiv = document.getElementById('property-types-analysis');
            propertyAnalysisDiv.innerHTML = Object.entries(propertyTypes)
                .map(([type, count]) => `<div><strong>${type}:</strong> ${count} مطابقة</div>`)
                .join('');

            // Price analysis
            const prices = allMatches
                .map(m => extractPriceFromString(m.offered_price || m.requested_price || '0'))
                .filter(p => p > 0);

            if (prices.length > 0) {
                const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);

                const priceAnalysisDiv = document.getElementById('price-analysis');
                priceAnalysisDiv.innerHTML = `
                    <div><strong>متوسط السعر:</strong> ${avgPrice.toLocaleString()} ريال</div>
                    <div><strong>أقل سعر:</strong> ${minPrice.toLocaleString()} ريال</div>
                    <div><strong>أعلى سعر:</strong> ${maxPrice.toLocaleString()} ريال</div>
                `;
            }

            // Location analysis
            const locations = {};
            allMatches.forEach(match => {
                const area = match.area || 'غير محدد';
                locations[area] = (locations[area] || 0) + 1;
            });

            const locationAnalysisDiv = document.getElementById('location-analysis');
            locationAnalysisDiv.innerHTML = Object.entries(locations)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([area, count]) => `<div><strong>${area}:</strong> ${count} نشاط</div>`)
                .join('');
        }

        // Marketing Functions
        async function generateMarketingMessages() {
            if (!allMatches.length) {
                showMessage('error', 'لا توجد مطابقات لإنشاء رسائل تسويقية');
                return;
            }

            showMessage('info', 'جاري إنشاء رسائل تسويقية مخصصة...');

            const topMatches = allMatches
                .filter(m => m.quality === 'مؤكدة' || m.quality === 'محتملة')
                .slice(0, 5);

            const marketingPrompt = `أنشئ رسائل تسويقية احترافية ومقنعة للمطابقات العقارية التالية. كل رسالة يجب أن تكون:
- مخصصة للعقار والعميل
- مقنعة ومحفزة للعمل
- تحتوي على دعوة واضحة للعمل
- مناسبة للواتساب والرسائل النصية

المطابقات:
${topMatches.map((match, i) => `
مطابقة ${i + 1}:
- نوع العقار: ${match.property_type}
- المنطقة: ${match.area}
- السعر: ${match.offered_price || match.requested_price}
- الجودة: ${match.quality}
`).join('\n')}

أرجع JSON مع رسائل تسويقية مخصصة لكل مطابقة.`;

            try {
                const messages = await callOpenAI(marketingPrompt);
                displayMarketingContent(messages, 'رسائل تسويقية مخصصة');
            } catch (error) {
                showMessage('error', 'فشل في إنشاء الرسائل التسويقية');
            }
        }

        async function generateWhatsAppMessages() {
            showMessage('info', 'جاري إنشاء رسائل واتساب...');

            const whatsappPrompt = `أنشئ رسائل واتساب قصيرة ومؤثرة للمسوقين العقاريين. الرسائل يجب أن تكون:
- قصيرة (50-100 كلمة)
- ودودة ومهنية
- تحتوي على قيمة مضافة
- مناسبة للثقافة السعودية

أنشئ 5 رسائل مختلفة للحالات التالية:
1. رسالة أولى للتعارف
2. رسالة عرض عقار
3. رسالة طلب عقار
4. رسالة متابعة
5. رسالة شكر وإغلاق صفقة

أرجع JSON مع الرسائل.`;

            try {
                const messages = await callOpenAI(whatsappPrompt);
                displayMarketingContent(messages, 'قوالب رسائل واتساب');
            } catch (error) {
                showMessage('error', 'فشل في إنشاء رسائل واتساب');
            }
        }

        async function generateSocialPosts() {
            showMessage('info', 'جاري إنشاء منشورات وسائل التواصل...');

            const socialPrompt = `أنشئ منشورات تسويقية احترافية لوسائل التواصل الاجتماعي للمسوق العقاري. كل منشور يجب أن يكون:
- جذاب ومحفز
- يحتوي على هاشتاقات مناسبة
- مناسب للسوق السعودي
- يحتوي على دعوة للعمل

أنشئ 5 منشورات مختلفة:
1. منشور تعريف بالخدمات
2. منشور عرض عقار مميز
3. منشور نصائح للمستثمرين
4. منشور شهادة عميل
5. منشور دعوة للتواصل

أرجع JSON مع المنشورات والهاشتاقات.`;

            try {
                const posts = await callOpenAI(socialPrompt);
                displayMarketingContent(posts, 'منشورات وسائل التواصل');
            } catch (error) {
                showMessage('error', 'فشل في إنشاء المنشورات');
            }
        }

        async function createEmailCampaign() {
            showMessage('info', 'جاري إنشاء حملة إيميل...');

            const emailPrompt = `أنشئ حملة بريد إلكتروني احترافية للمسوق العقاري تتكون من:
1. خط الموضوع الجذاب
2. نص الإيميل الرئيسي
3. دعوة للعمل
4. توقيع احترافي

الحملة يجب أن تكون:
- مهنية وموثوقة
- تحتوي على قيمة مضافة
- مناسبة للعملاء السعوديين
- تحفز على التفاعل

أرجع JSON مع مكونات الحملة.`;

            try {
                const campaign = await callOpenAI(emailPrompt);
                displayMarketingContent(campaign, 'حملة البريد الإلكتروني');
            } catch (error) {
                showMessage('error', 'فشل في إنشاء حملة الإيميل');
            }
        }

        async function analyzeTargetCustomers() {
            if (!clientsDatabase.length) {
                showMessage('error', 'لا يوجد عملاء للتحليل');
                return;
            }

            showMessage('info', 'جاري تحليل العملاء المستهدفين...');

            const analysisPrompt = `حلل قاعدة العملاء التالية وقدم رؤى تسويقية:

العملاء:
${clientsDatabase.map(client => `
- النوع: ${client.type}
- الاهتمام: ${client.interest}
- الميزانية: ${client.budget}
- الإلحاح: ${client.urgency}/10
`).join('\n')}

قدم تحليلاً يشمل:
1. تصنيف العملاء حسب الأولوية
2. اقتراحات لاستراتيجيات التسويق
3. توصيات للمتابعة
4. فرص البيع المتقدم

أرجع JSON مع التحليل والتوصيات.`;

            try {
                const analysis = await callOpenAI(analysisPrompt);
                displayMarketingContent(analysis, 'تحليل العملاء المستهدفين');
            } catch (error) {
                showMessage('error', 'فشل في تحليل العملاء');
            }
        }

        function displayMarketingContent(content, title) {
            const container = document.getElementById('marketing-content');
            if (!container) return;

            container.innerHTML = `
                <div class="analytics-card">
                    <h3>${title}</h3>
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
                        ${typeof content === 'string' ? content : JSON.stringify(content, null, 2)}
                    </div>
                    <button class="btn primary" onclick="copyToClipboard('${encodeURIComponent(JSON.stringify(content))}')">نسخ المحتوى</button>
                </div>
            `;
        }

        function copyToClipboard(encodedContent) {
            const content = JSON.parse(decodeURIComponent(encodedContent));
            navigator.clipboard.writeText(typeof content === 'string' ? content : JSON.stringify(content, null, 2));
            showMessage('success', 'تم نسخ المحتوى');
        }

        // Report Functions
        async function generateDailyReport() {
            showMessage('info', 'جاري إنشاء التقرير اليومي...');

            const reportData = {
                date: new Date().toLocaleDateString('ar-SA'),
                totalMatches: allMatches.length,
                qualityBreakdown: {
                    confirmed: allMatches.filter(m => m.quality === 'مؤكدة').length,
                    potential: allMatches.filter(m => m.quality === 'محتملة').length,
                    possible: allMatches.filter(m => m.quality === 'ممكنة').length
                },
                totalClients: clientsDatabase.length,
                hotLeads: clientsDatabase.filter(c => c.urgency >= 8).length,
                revenue: allMatches.reduce((sum, match) => {
                    const commission = extractPriceFromString(match.commission_potential || '0');
                    return sum + commission;
                }, 0)
            };

            const reportPrompt = `أنشئ تقريراً يومياً احترافياً للمسوق العقاري باللغة العربية يتضمن:

البيانات:
${JSON.stringify(reportData, null, 2)}

التقرير يجب أن يشمل:
1. ملخص تنفيذي
2. إحصائيات الأداء
3. أهم المطابقات
4. حالة العملاء
5. التوصيات للغد
6. الفرص المفقودة

اجعل التقرير مهنياً ومفصلاً وقابلاً للطباعة.`;

            try {
                const report = await callOpenAI(reportPrompt);
                displayReportContent(report, 'التقرير اليومي');
            } catch (error) {
                showMessage('error', 'فشل في إنشاء التقرير');
            }
        }

        async function generateWeeklyReport() {
            showMessage('info', 'جاري إنشاء التقرير الأسبوعي...');
            // Similar implementation for weekly report
            const report = "تقرير أسبوعي مفصل (يتطلب بيانات تاريخية)";
            displayReportContent(report, 'التقرير الأسبوعي');
        }

        async function generateClientReport() {
            const clientsReport = `
# تقرير العملاء المحتملين

## إجمالي العملاء: ${clientsDatabase.length}

${clientsDatabase.map(client => `
### ${client.name}
- **الهاتف:** ${client.phone}
- **النوع:** ${client.type}
- **الاهتمام:** ${client.interest || 'غير محدد'}
- **الميزانية:** ${client.budget || 'غير محدد'}
- **الحالة:** ${client.status}
- **الإلحاح:** ${client.urgency}/10
- **المصدر:** ${client.source}
- **آخر تواصل:** ${client.lastContact || 'لم يتم التواصل'}
- **الملاحظات:** ${client.notes || 'لا توجد ملاحظات'}

---
`).join('')}
            `;

            displayReportContent(clientsReport, 'تقرير العملاء');
        }

        function displayReportContent(content, title) {
            const container = document.getElementById('report-content');
            if (!container) return;

            container.innerHTML = `
                <div class="analytics-card">
                    <h3>${title}</h3>
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; white-space: pre-wrap; max-height: 500px; overflow-y: auto; font-family: monospace;">
                        ${typeof content === 'string' ? content : JSON.stringify(content, null, 2)}
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button class="btn primary" onclick="copyToClipboard('${encodeURIComponent(content)}')">نسخ التقرير</button>
                        <button class="btn success" onclick="downloadReport('${title}', '${encodeURIComponent(content)}')">تحميل</button>
                        <button class="btn warning" onclick="printReport()">طباعة</button>
                    </div>
                </div>
            `;
        }

        function downloadReport(title, encodedContent) {
            const content = decodeURIComponent(encodedContent);
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title}_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function exportToPDF() {
            showMessage('info', 'تصدير PDF يتطلب مكتبة خارجية');
        }

        function exportToExcel() {
            showMessage('info', 'تصدير Excel يتطلب مكتبة خارجية');
        }

        function scheduleReport() {
            showMessage('info', 'جدولة التقارير متاحة في النسخة المتقدمة');
        }

        function emailReport() {
            showMessage('info', 'إرسال التقارير بالإيميل متاح في النسخة المتقدمة');
        }

        // ===================== Main Execution Function (Enhanced) =====================
        async function runMatching() {
            const startBtn = document.getElementById('start-matching-btn');
            const loader = document.getElementById('loader');
            const matchesContainer = document.getElementById('matches-container');
            const noResults = document.getElementById('no-results');

            startBtn.disabled = true;
            startBtn.textContent = '⏳ جاري التحليل المتقدم...';
            loader.style.display = 'block';
            matchesContainer.innerHTML = '';
            noResults.style.display = 'none';

            try {
                await ensureApiKeyOrFail();
                await loadDataForMatching();
                await classifyAndSeparateFiles();

                if (requests.length === 0 || offers.length === 0) {
                    throw new Error('يجب وجود طلبات وعروض لإجراء المطابقة.');
                }

                const prompt = createMatchingPrompt(requests, offers);
                const matches = await callOpenAI(prompt);

                if (matches) {
                    displayMatches(matches);
                    if (matches.length > 0) {
                        showMessage('success', `🎉 اكتمل التحليل المتقدم! تم العثور على ${matches.length} مطابقة مع ميزات ذكية.`);
                        
                        // Auto-update analytics
                        setTimeout(updateAnalytics, 1000);
                    } else {
                        showMessage('info', '✅ اكتمل التحليل. لم يتم العثور على مطابقات قوية.');
                    }
                } else {
                    noResults.textContent = 'حدث خطأ أثناء التحليل. يرجى مراجعة الـ Console.';
                    noResults.style.display = 'block';
                }
            } catch (error) {
                console.error("Matching process failed:", error);
                showMessage('error', `فشلت العملية: ${error.message}`);
                noResults.textContent = `فشلت العملية: ${error.message}`;
                noResults.style.display = 'block';
            } finally {
                startBtn.disabled = false;
                startBtn.textContent = '🚀 بدء المطابقة الذكية';
                loader.style.display = 'none';
            }
        }
    </script>
</body>

</html>