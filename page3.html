<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (OpenAI)</title>
<style>
  :root {
    --bg: #0f172a; --card: #111827; --text: #e5e7eb; --muted: #9ca3af;
    --accent: #22c55e; --accent-2: #3b82f6; --btn-bg: #1f2937; --btn-hover: #374151;
    --shadow: 0 10px 25px rgba(0,0,0,.35); --radius: 18px; --danger: #ef4444;
  }
  * { box-sizing: border-box; }
  html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", Arial, sans-serif; line-height: 1.6; }
  .wrap { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
  .card { width: min(1200px, 96vw); background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    border: 1px solid rgba(255,255,255,.08); border-radius: var(--radius); padding: 28px; box-shadow: var(--shadow); backdrop-filter: blur(6px); }
  h1 { margin: 0 0 10px; font-size: clamp(26px, 3.5vw, 40px); letter-spacing: .2px; }
  p.lead { margin: 0 0 26px; color: var(--muted); }
  .btn { display: inline-block; text-decoration: none; text-align: center; cursor: pointer; background: var(--btn-bg); color: var(--text);
    padding: 14px 16px; border-radius: 14px; border: 1px solid rgba(255,255,255,.08);
    transition: transform .12s ease, background .12s ease, border-color .12s ease; box-shadow: 0 6px 14px rgba(0,0,0,.25); font-family: inherit; font-size: inherit; }
  .btn:hover { background: var(--btn-hover); transform: translateY(-1px); }
  .btn.primary { background: var(--accent-2); border-color: transparent; color: #fff; }
  .btn.success { background: var(--accent); border-color: transparent; color: #fff; }
  .status-section, .controls-section, .results-section { margin-bottom: 24px; padding: 16px; background: rgba(255,255,255,0.02); border-radius: var(--radius); }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; text-align: center; }
  .stat-item .stat-number { font-size: 28px; font-weight: bold; color: var(--accent-2); }
  .stat-item .stat-label { font-size: 12px; color: var(--muted); }
  #status-message { padding: 12px; border-radius: 10px; text-align: center; display: none; margin-bottom: 16px; }
  #status-message.info { background: rgba(59, 130, 246, .1); color: var(--accent-2); border: 1px solid rgba(59, 130, 246, .2); }
  #status-message.success { background: rgba(34, 197, 94, .1); color: var(--accent); border: 1px solid rgba(34, 197, 94, .2); }
  #status-message.error { background: rgba(239, 68, 68, .1); color: var(--danger); border: 1px solid rgba(239, 68, 68, .2); }
  .loader { border: 4px solid var(--btn-bg); border-top: 4px solid var(--accent-2); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .matches-container { display: grid; gap: 16px; grid-template-columns: 1fr; }
  .match-card { background: var(--card); border: 1px solid rgba(255,255,255,.1); border-radius: var(--radius); padding: 20px; }
  .match-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,.1); padding-bottom: 12px; }
  .match-quality { padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; }
  .match-quality.Ù…Ù…ØªØ§Ø²Ø© { background: #10b981; color: #fff; }
  .match-quality.Ø¬ÙŠØ¯Ø© { background: #f59e0b; color: #fff; }
  .match-quality.Ù…Ù‚Ø¨ÙˆÙ„Ø© { background: #6b7280; color: #fff; }
  .match-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px; }
  .detail-item strong { color: var(--accent-2); }
  .match-reason { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; margin: 16px 0; font-style: italic; border-left: 3px solid var(--accent); }
  .match-texts { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .text-box { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px; font-size: 13px; white-space: pre-wrap; word-break: break-word; max-height: 200px; overflow-y: auto; }
  .text-box h4 { margin: 0 0 8px; color: var(--accent-2); }
  @media (max-width: 768px) { .match-texts { grid-template-columns: 1fr; } }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1><span style="font-size: 24px;">ğŸ¤–</span> Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</h1>
      <p class="lead">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ¥ÙŠØ¬Ø§Ø¯ Ø£ÙØ¶Ù„ Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª â€” Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenAI.</p>

      <div class="status-section">
        <h2>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
        <div id="status-message"></div>
        <div class="stats-grid">
          <div class="stat-item"><div class="stat-number" id="total-docs">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</div></div>
          <div class="stat-item"><div class="stat-number" id="request-count">0</div><div class="stat-label">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div></div>
          <div class="stat-item"><div class="stat-number" id="offer-count">0</div><div class="stat-label">Ø§Ù„Ø¹Ø±ÙˆØ¶</div></div>
        </div>
      </div>

      <div class="controls-section" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <button class="btn success" id="start-matching-btn" onclick="runMatching()">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
        <button class="btn" onclick="promptAndSaveApiKey()">ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ OpenAI</button>
        <button class="btn" onclick="testApiKey()">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙØªØ§Ø­</button>
        <a class="btn" href="page2.html" style="margin-inline-start:auto;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù„ÙØ§Øª</a>
      </div>

      <div class="results-section">
        <h2>ğŸ’¡ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</h2>
        <div id="loader" class="loader"></div>
        <div id="matches-container" class="matches-container"></div>
        <p id="no-results" style="color: var(--muted); text-align: center; display: block;">Ù„Ù… ÙŠØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©" Ù„Ù„Ø¨Ø¯Ø¡.</p>
      </div>
    </div>
  </div>

<script>
// ===================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =====================
const DB_NAME = 'FilesStorage';
const DB_VERSION = 1;
const STORE_NAME = 'files';
let db;

const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
const OPENAI_MODEL   = 'gpt-4o-mini'; // Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ§Ø­ Ù„Ø¯ÙŠÙƒ

// ===================== Ø¥Ø¯Ø§Ø±Ø© Ù…ÙØªØ§Ø­ OpenAI =====================
const API_KEY_STORAGE_KEY = 'OPENAI_API_KEY';

function getApiKey() { return localStorage.getItem(API_KEY_STORAGE_KEY) || ''; }
function saveApiKey(key) { if (!key || !key.trim()) return false; localStorage.setItem(API_KEY_STORAGE_KEY, key.trim()); return true; }
function promptAndSaveApiKey() {
  const current = getApiKey();
  const value = prompt('Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ OpenAI (ÙŠÙØ®Ø²Ù† Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù…ØªØµÙØ­Ùƒ):', current);
  if (value !== null) {
    if (saveApiKey(value)) showMessage('success', 'âœ… ØªÙ… Ø­ÙØ¸ Ù…ÙØªØ§Ø­ OpenAI Ù…Ø­Ù„ÙŠÙ‹Ø§.');
    else showMessage('error', 'âŒ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­. ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ ØºÙŠØ± ÙØ§Ø±Øº.');
  }
}
async function ensureApiKeyOrFail() {
  const key = getApiKey();
  if (!key) { showMessage('error','âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ OpenAI. Ø§Ø¶ØºØ· "Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ OpenAI" Ù„Ø¥Ø¯Ø®Ø§Ù„Ù‡.'); throw new Error('API key is missing'); }
  return key;
}
async function testApiKey() {
  try {
    const key = await ensureApiKeyOrFail();
    const res = await fetch(OPENAI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify({
        model: OPENAI_MODEL,
        messages: [
          { role: 'system', content: 'You are a JSON-only responder.' },
          { role: 'user', content: 'Return exactly this JSON: {"ok":true}' }
        ],
        temperature: 0,
        response_format: { type: "json_object" }
      })
    });
    if (!res.ok) {
      const body = await res.text();
      console.error('OpenAI test error:', body);
      showMessage('error', `âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${res.status} ${res.statusText}`);
      return;
    }
    const data = await res.json();
    const content = data?.choices?.[0]?.message?.content ?? '';
    if (content.includes('"ok":true')) showMessage('success','âœ… Ø§Ù„Ù…ÙØªØ§Ø­ ÙŠØ¹Ù…Ù„.');
    else showMessage('error','âš ï¸ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.');
  } catch (e) { showMessage('error', `âŒ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙØªØ§Ø­ ÙØ´Ù„: ${e.message}`); }
}

// ===================== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© =====================
let allTextFiles = [];
let requests = [];
let offers = [];

// ===================== Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====================
function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onerror = () => reject("Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    request.onsuccess = () => { db = request.result; resolve(db); };
  });
}

// ===================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====================
async function loadDataForMatching() {
  showMessage('info', 'ğŸ” Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.getAll();

    request.onsuccess = () => {
      const allFiles = request.result;
      allTextFiles = allFiles.filter(file =>
        (file.type && (file.type.includes('text') || file.type.includes('json'))) ||
        (file.name && (file.name.endsWith('.txt') || file.name.endsWith('.json')))
      );
      if (allTextFiles.length === 0) { showMessage('error','âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª Ù†ØµÙŠØ© Ø£Ùˆ JSON.'); reject('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ØµØ§Ù„Ø­Ø©'); return; }
      showMessage('success', `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allTextFiles.length} Ù…Ø³ØªÙ†Ø¯ Ø¨Ù†Ø¬Ø§Ø­.`);
      document.getElementById('total-docs').textContent = allTextFiles.length;
      resolve();
    };
    request.onerror = () => { showMessage('error','âŒ ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.'); reject(request.error); };
  });
}

// ===================== ØªØµÙ†ÙŠÙ Ø·Ù„Ø¨/Ø¹Ø±Ø¶ =====================
function classifyMessageType(text) {
  if (!text) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  const textLower = text.toLowerCase();
  const requestKeywords = ['Ù…Ø·Ù„ÙˆØ¨','Ø§Ø¨Ø­Ø« Ø¹Ù†','Ø£Ø±ÙŠØ¯','Ù†Ø±ÙŠØ¯','Ù…Ø­ØªØ§Ø¬','Ø¨Ø­Ø« Ø¹Ù†','Ø¹Ø§ÙˆØ²','Ø¹Ø§ÙŠØ²','Ø§Ø¯ÙˆØ± Ø¹Ù„Ù‰','Ø£Ø¯ÙˆØ± Ø¹Ù„Ù‰','Ù†Ø¨Ø­Ø« Ø¹Ù†'];
  const offerKeywords   = ['Ù„Ù„Ø¨ÙŠØ¹','Ù„Ù„Ø§ÙŠØ¬Ø§Ø±','Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±','Ù…Ø¹Ø±ÙˆØ¶','Ù…ØªÙˆÙØ±','ÙŠÙˆØ¬Ø¯','Ø¹Ù†Ø¯ÙŠ','Ù„Ø¯ÙŠ','Ù…ØªØ§Ø­','Ù„Ù„ØªÙ†Ø§Ø²Ù„','Ø£Ø¹Ø±Ø¶'];
  const r = requestKeywords.reduce((s,k)=>s+(textLower.includes(k)?1:0),0);
  const o = offerKeywords.reduce((s,k)=>s+(textLower.includes(k)?1:0),0);
  if (r>o) return 'Ù…Ø·Ù„ÙˆØ¨'; if (o>r) return 'Ù…Ø¹Ø±ÙˆØ¶'; return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
}

async function classifyAndSeparateFiles() {
  showMessage('info', 'ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¥Ù„Ù‰ Ø·Ù„Ø¨Ø§Øª ÙˆØ¹Ø±ÙˆØ¶...');
  requests = []; offers = [];
  for (const file of allTextFiles) {
    try {
      const base64 = file.data.split(',')[1]; if (!base64) continue;
      const textContent = decodeURIComponent(escape(atob(base64)));
      if (file.name.endsWith('.json')) {
        const json = JSON.parse(textContent);
        if (json.messages && Array.isArray(json.messages)) {
          json.messages.forEach(m => {
            const type = classifyMessageType(m.original_text || '');
            if (type !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
              const info = { text: m.original_text };
              if (type==='Ù…Ø·Ù„ÙˆØ¨') requests.push(info); else if (type==='Ù…Ø¹Ø±ÙˆØ¶') offers.push(info);
            }
          });
        }
      } else {
        const type = classifyMessageType(textContent);
        if (type !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
          const info = { text: textContent };
          if (type==='Ù…Ø·Ù„ÙˆØ¨') requests.push(info); else if (type==='Ù…Ø¹Ø±ÙˆØ¶') offers.push(info);
        }
      }
    } catch (e) { console.error(`ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù ${file.name}:`, e); }
  }
  document.getElementById('request-count').textContent = requests.length;
  document.getElementById('offer-count').textContent = offers.length;
  showMessage('success', `âœ… ØªÙ… Ø§Ù„ØªØµÙ†ÙŠÙ: ${requests.length} Ø·Ù„Ø¨ØŒ ${offers.length} Ø¹Ø±Ø¶.`);
}

// ===================== Ø¥Ù†Ø´Ø§Ø¡ Prompt =====================
function createMatchingPrompt(requestsBatch, offersBatch) {
  let prompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¹Ù‚Ø§Ø±ÙŠØ© Ù…Ø­ØªØ±Ù. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ØªØ­Ù„ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ§Ù„ÙŠØ© ÙˆØ¥ÙŠØ¬Ø§Ø¯ Ø£ÙØ¶Ù„ Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù…Ù…ÙƒÙ†Ø©.

### Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:
1.  **Ø§Ù„Ù‡Ø¯Ù**: Ø·Ø§Ø¨Ù‚ Ø¨ÙŠÙ† "Ø·Ù„Ø¨" Ùˆ "Ø¹Ø±Ø¶". Ù„Ø§ ØªØ·Ø§Ø¨Ù‚ Ø·Ù„Ø¨ Ù…Ø¹ Ø·Ù„Ø¨ Ø£Ùˆ Ø¹Ø±Ø¶ Ù…Ø¹ Ø¹Ø±Ø¶.
2.  **Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©**: ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ·Ø§Ø¨Ù‚ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø©.
3.  **Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©**: ØµÙ†Ù‘Ù Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¥Ù„Ù‰ "Ù…Ù…ØªØ§Ø²Ø©" Ø£Ùˆ "Ø¬ÙŠØ¯Ø©" Ø£Ùˆ "Ù…Ù‚Ø¨ÙˆÙ„Ø©".

### ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬:
Ø£Ø±Ø¬Ø¹ **Ù…ØµÙÙˆÙØ© JSON ÙÙ‚Ø·** (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ). ÙƒÙ„ Ø¹Ù†ØµØ±:
{
  "quality": "...",
  "property_type": "...",
  "area": "...",
  "requested_price": "...",
  "offered_price": "...",
  "requester_phone": "...",
  "offerer_phone": "...",
  "reason": "...",
  "request_text": "...",
  "offer_text": "..."
}
Ø¥Ø°Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø£Ø±Ø¬Ø¹ [] ÙÙ‚Ø·.

---
### Ø§Ù„Ø·Ù„Ø¨Ø§Øª:
`;
  requestsBatch.forEach((req, i) => { prompt += `\n--- Ø·Ù„Ø¨ ${i+1} ---\n${req.text}\n`; });
  prompt += `\n---\n### Ø§Ù„Ø¹Ø±ÙˆØ¶:\n`;
  offersBatch.forEach((off, i) => { prompt += `\n--- Ø¹Ø±Ø¶ ${i+1} ---\n${off.text}\n`; });
  prompt += `\n---\nØ£Ø¹Ø¯ Ø§Ù„Ø¢Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© ÙÙ‚Ø·.`;
  return prompt;
}

// ===================== Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ OpenAI =====================
async function callOpenAI(prompt) {
  const key = await ensureApiKeyOrFail();
  try {
    const res = await fetch(OPENAI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify({
        model: OPENAI_MODEL,
        temperature: 0,
        response_format: { type: "json_object" }, // Ù†Ø¬Ø¨Ø±Ù‡ Ø¹Ù„Ù‰ JSON (Ø³ÙŠØ¹ÙŠØ¯ ÙƒØ§Ø¦Ù†Ø› Ø³Ù†Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
        messages: [
          { role: 'system', content: 'Ø£Ø¹Ø¯ Ø§Ø³ØªØ¬Ø§Ø¨Ø© JSON ÙÙ‚Ø· ÙˆØ¨Ø¯ÙˆÙ† Ø£ÙŠ Ù…Ù‚Ø¯Ù…Ø© Ø£Ùˆ Ø´Ø±Ø­.' },
          { role: 'user', content: prompt }
        ]
      })
    });

    if (!res.ok) {
      const errorBody = await res.text();
      console.error("OpenAI Response Error:", errorBody);
      if (res.status === 401) throw new Error('Ù…ÙØªØ§Ø­ OpenAI ØºÙŠØ± ØµØ­ÙŠØ­.');
      if (res.status === 429) throw new Error('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø¹Ø¯Ù„/Ø§Ù„ÙƒÙˆØªØ§ (Rate Limit).');
      throw new Error(`Ø®Ø·Ø£ Ù…Ù† OpenAI: ${res.status} ${res.statusText}`);
    }

    const data = await res.json();
    let content = data?.choices?.[0]?.message?.content || '';
    // Ù‚Ø¯ ÙŠØ¹ÙŠØ¯ ÙƒØ§Ø¦Ù† JSONØ› Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¯Ø§Ø®Ù„Ù‡ Ø£Ùˆ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹
    let parsed;
    try {
      parsed = JSON.parse(content);
      // Ø¥Ù† ÙƒØ§Ù† ÙƒØ§Ø¦Ù† ÙˆÙÙŠÙ‡ Ù…ØµÙÙˆÙØ© Ø¨Ø§Ø³Ù… matchesØŒ Ø£Ùˆ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ù†ÙØ³Ù‡Ø§ Ù…ØµÙÙˆÙØ©
      if (Array.isArray(parsed)) return parsed;
      const maybeArr = parsed.matches || parsed.result || parsed.data;
      if (Array.isArray(maybeArr)) return maybeArr;
      // Ù„Ùˆ Ø±Ø¬Ù‘Ø¹ ÙƒØ§Ø¦Ù† ÙˆØ§Ø­Ø¯ØŒ Ù†Ø­ÙˆÙ„Ù‡ Ù„Ù…ØµÙÙˆÙØ© ÙˆØ§Ø­Ø¯Ø©
      if (parsed && typeof parsed === 'object') return [parsed];
    } catch {
      // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª ÙƒÙˆØ¯ Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
      content = content.replace(/```json|```/g,'').trim();
      return JSON.parse(content);
    }
    return [];
  } catch (error) {
    showMessage('error', `âŒ ${error.message}`);
    console.error('callOpenAI error:', error);
    return null;
  }
}

// ===================== Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ =====================
function displayMatches(matches) {
  const container = document.getElementById('matches-container');
  const noResultsP = document.getElementById('no-results');
  container.innerHTML = '';

  if (!matches || matches.length === 0) {
    noResultsP.textContent = 'âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„. Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù‚ÙˆÙŠØ©.';
    noResultsP.style.display = 'block';
    return;
  }
  noResultsP.style.display = 'none';

  matches.forEach(match => {
    const card = document.createElement('div');
    card.className = 'match-card';
    card.innerHTML = `
      <div class="match-header">
        <h3>Ù…Ø·Ø§Ø¨Ù‚Ø© ${match.property_type || ''}</h3>
        <span class="match-quality ${match.quality || ''}">${match.quality || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
      </div>
      <div class="match-details">
        <div class="detail-item"><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${match.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
        <div class="detail-item"><strong>Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨:</strong> ${match.requested_price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
        <div class="detail-item"><strong>Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶:</strong> ${match.offered_price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
        <div class="detail-item"><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> ${match.requester_phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</div>
        <div class="detail-item"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ø±Ø¶:</strong> ${match.offerer_phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</div>
      </div>
      <div class="match-reason"><strong>ğŸ’¡ Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:</strong> ${match.reason || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¨Ø¨ Ù…Ø­Ø¯Ø¯.'}</div>
      <div class="match-texts">
        <div class="text-box"><h4>ğŸ” Ù†Øµ Ø§Ù„Ø·Ù„Ø¨</h4><p>${match.request_text || ''}</p></div>
        <div class="text-box"><h4>ğŸ  Ù†Øµ Ø§Ù„Ø¹Ø±Ø¶</h4><p>${match.offer_text || ''}</p></div>
      </div>`;
    container.appendChild(card);
  });
}

// ===================== Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ =====================
async function runMatching() {
  const startBtn = document.getElementById('start-matching-btn');
  const loader = document.getElementById('loader');
  const matchesContainer = document.getElementById('matches-container');
  const noResults = document.getElementById('no-results');

  startBtn.disabled = true;
  startBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...';
  loader.style.display = 'block';
  matchesContainer.innerHTML = '';
  noResults.style.display = 'none';

  try {
    await ensureApiKeyOrFail();
    await loadDataForMatching();
    await classifyAndSeparateFiles();

    if (requests.length === 0 || offers.length === 0) {
      showMessage('error', 'âŒ ÙŠØ¬Ø¨ ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨Ø§Øª ÙˆØ¹Ø±ÙˆØ¶ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©.');
      throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©');
    }

    showMessage('info', 'ğŸ¤– Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ OpenAI...');
    const prompt = createMatchingPrompt(requests, offers);
    const matches = await callOpenAI(prompt);

    if (matches) {
      displayMatches(matches);
      showMessage('success', `ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„! ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${matches.length} Ù…Ø·Ø§Ø¨Ù‚Ø©.`);
    } else {
      noResults.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù€ Console.';
      noResults.style.display = 'block';
    }
  } catch (error) {
    console.error("ÙØ´Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:", error);
    showMessage('error', `ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${error.message}`);
    noResults.textContent = `ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${error.message}`;
    noResults.style.display = 'block';
  } finally {
    startBtn.disabled = false;
    startBtn.textContent = 'ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ';
    loader.style.display = 'none';
  }
}

// ===================== Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„Ø© =====================
function showMessage(type, message) {
  const statusDiv = document.getElementById('status-message');
  statusDiv.className = type;
  statusDiv.textContent = message;
  statusDiv.style.display = 'block';
}

// ===================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====================
document.addEventListener('DOMContentLoaded', async () => {
  try {
    await initDB();
    showMessage('info', 'Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø©. Ø§Ø¶Ø¨Ø· Ù…ÙØªØ§Ø­ OpenAI ÙˆØ§Ø¶ØºØ· Ø§Ù„Ø¨Ø¯Ø¡.');
  } catch (error) {
    showMessage('error', `âŒ Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ${error}`);
  }
});
</script>
</body>
</html>
