<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù†Ø¸Ø§Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø·ÙˆØ± - Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <style>
        /* ===================== CSS Variables and Global Styles ===================== */
        :root {
            --bg: #0f172a;
            --card: #111827;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #22c55e;
            --accent-2: #3b82f6;
            --accent-3: #f59e0b;
            --accent-4: #8b5cf6;
            --btn-bg: #1f2937;
            --btn-hover: #374151;
            --shadow: 0 10px 25px rgba(0, 0, 0, .35);
            --radius: 18px;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", Arial, sans-serif;
            line-height: 1.6;
        }

        /* ===================== Layout and Card Styles ===================== */
        .wrap {
            min-height: 100vh;
            display: grid;
            place-items: center;
            padding: 24px;
        }

        .card {
            width: min(1400px, 96vw);
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .01));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: var(--radius);
            padding: 28px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(6px);
        }

        h1 {
            margin: 0 0 10px;
            font-size: clamp(26px, 3.5vw, 40px);
            letter-spacing: .2px;
        }

        p.lead {
            margin: 0 0 26px;
            color: var(--muted);
        }

        /* ===================== Smart Search Panel ===================== */
        .smart-search-panel {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1));
            border: 2px solid rgba(34, 197, 94, 0.3);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
        }

        .smart-search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .smart-search-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-paths-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .search-path-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            position: relative;
        }

        .search-path-item.active {
            border-color: var(--accent);
            background: rgba(34, 197, 94, 0.1);
        }

        .search-path-item.scanning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .path-checkbox {
            margin-left: 8px;
            width: 18px;
            height: 18px;
        }

        .path-status {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 20px;
        }

        /* ===================== AI Analysis Panel ===================== */
        .ai-analysis-panel {
            background: rgba(139, 92, 246, 0.1);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .analysis-progress {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }

        .analysis-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }

        .analysis-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ===================== Tabs Navigation ===================== */
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            padding-bottom: 16px;
        }

        .tab-btn {
            padding: 12px 20px;
            background: var(--btn-bg);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            cursor: pointer;
            transition: all .2s ease;
            font-size: 14px;
        }

        .tab-btn:hover {
            background: var(--btn-hover);
        }

        .tab-btn.active {
            background: var(--accent-2);
            border-color: var(--accent-2);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===================== Buttons and Links ===================== */
        button.btn,
        a.btn {
            display: inline-block;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            background: var(--btn-bg);
            color: var(--text);
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .08);
            transition: transform .12s ease, background .12s ease, border-color .12s ease;
            box-shadow: 0 6px 14px rgba(0, 0, 0, .25);
            font-family: inherit;
            font-size: inherit;
            margin: 4px;
        }

        button.btn:hover,
        a.btn:hover {
            background: var(--btn-hover);
            transform: translateY(-1px);
        }

        button.btn.primary {
            background: var(--accent-2);
            border-color: transparent;
            color: #fff;
        }

        button.btn.success {
            background: var(--accent);
            border-color: transparent;
            color: #fff;
        }

        button.btn.warning {
            background: var(--warning);
            border-color: transparent;
            color: #fff;
        }

        button.btn.purple {
            background: var(--accent-4);
            border-color: transparent;
            color: #fff;
        }

        button.btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ===================== File Discovery Panel ===================== */
        .discovery-panel {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .discovered-files {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .discovered-file-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            flex: 1;
        }

        .file-path {
            font-family: monospace;
            font-size: 12px;
            color: var(--muted);
            word-break: break-all;
        }

        .file-size {
            font-size: 11px;
            color: var(--accent-3);
        }

        /* ===================== Sections and Status ===================== */
        .status-section,
        .controls-section,
        .results-section,
        .analytics-section,
        .crm-section {
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            text-align: center;
        }

        .stat-item .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-2);
        }

        .stat-item .stat-label {
            font-size: 12px;
            color: var(--muted);
        }

        /* ===================== Filter Controls ===================== */
        .filter-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            align-items: end;
        }

        .filter-item label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            color: var(--muted);
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 8px 12px;
            background: var(--btn-bg);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
        }

        /* ===================== Match Results Enhancement ===================== */
        #status-message {
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            display: none;
            margin-bottom: 16px;
        }

        #status-message.info {
            background: rgba(59, 130, 246, .1);
            color: var(--accent-2);
            border: 1px solid rgba(59, 130, 246, .2);
        }

        #status-message.success {
            background: rgba(34, 197, 94, .1);
            color: var(--accent);
            border: 1px solid rgba(34, 197, 94, .2);
        }

        #status-message.error {
            background: rgba(239, 68, 68, .1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, .2);
        }

        .loader {
            border: 4px solid var(--btn-bg);
            border-top: 4px solid var(--accent-2);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .matches-container {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        .match-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: var(--radius);
            padding: 20px;
            position: relative;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            padding-bottom: 12px;
        }

        .match-quality {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .match-quality.Ù…Ø¤ÙƒØ¯Ø© {
            background: #10b981;
            color: #fff;
        }

        .match-quality.Ù…Ø­ØªÙ…Ù„Ø© {
            background: #f59e0b;
            color: #fff;
        }

        .match-quality.Ù…Ù…ÙƒÙ†Ø© {
            background: #3b82f6;
            color: #fff;
        }

        /* ===================== Smart Search Status ===================== */
        .search-status {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-log-entry {
            margin: 4px 0;
            padding: 2px 0;
        }

        .log-success { color: var(--accent); }
        .log-error { color: var(--danger); }
        .log-warning { color: var(--warning); }
        .log-info { color: var(--accent-2); }

        /* ===================== Responsive Design ===================== */
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
            .search-paths-grid {
                grid-template-columns: 1fr;
            }
            .tab-nav {
                flex-wrap: wrap;
            }
        }

        /* ===================== Permission Request Modal ===================== */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .permission-modal-content {
            background: var(--card);
            border-radius: var(--radius);
            padding: 30px;
            max-width: 500px;
            text-align: center;
            border: 2px solid var(--accent);
        }

        .permission-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <!-- Permission Request Modal -->
    <div id="permission-modal" class="permission-modal">
        <div class="permission-modal-content">
            <div class="permission-icon">ğŸ”’</div>
            <h3>Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
            <p>ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</p>
            <button class="btn success" onclick="requestPermissions()">Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</button>
            <button class="btn" onclick="closePermissionModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="wrap">
        <div class="card">
            <h1><span style="font-size: 24px;">ğŸ§ </span> Ù†Ø¸Ø§Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø·ÙˆØ±</h1>
            <p class="lead">Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…ÙŠÙ‚ ÙÙŠ Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ ÙˆØ§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>

            <!-- Smart Search Panel -->
            <div class="smart-search-panel">
                <div class="smart-search-header">
                    <div class="smart-search-title">
                        ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
                        <span id="search-status-indicator" style="font-size: 12px; color: var(--muted);">Ø¬Ø§Ù‡Ø²</span>
                    </div>
                    <button class="btn success" onclick="startSmartSearch()">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ</button>
                </div>

                <div class="search-paths-grid">
                    <div class="search-path-item" data-path="/storage/emulated/0/">
                        <input type="checkbox" class="path-checkbox" checked>
                        <div class="path-status">ğŸ“</div>
                        <h4>Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</h4>
                        <div class="file-path">/storage/emulated/0/</div>
                        <div class="file-size">Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                    </div>
                    
                    <div class="search-path-item" data-path="/sdcard/">
                        <input type="checkbox" class="path-checkbox" checked>
                        <div class="path-status">ğŸ’¾</div>
                        <h4>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©</h4>
                        <div class="file-path">/sdcard/</div>
                        <div class="file-size">Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©</div>
                    </div>

                    <div class="search-path-item" data-path="/storage/">
                        <input type="checkbox" class="path-checkbox" checked>
                        <div class="path-status">ğŸ—‚ï¸</div>
                        <h4>Ø¬Ø°Ø± Ø§Ù„ØªØ®Ø²ÙŠÙ†</h4>
                        <div class="file-path">/storage/</div>
                        <div class="file-size">Ø¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†</div>
                    </div>

                    <div class="search-path-item" data-path="/data/">
                        <input type="checkbox" class="path-checkbox">
                        <div class="path-status">âš ï¸</div>
                        <h4>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</h4>
                        <div class="file-path">/data/</div>
                        <div class="file-size">ÙŠØªØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø®Ø§ØµØ©</div>
                    </div>

                    <div class="search-path-item" data-path="Downloads">
                        <input type="checkbox" class="path-checkbox" checked>
                        <div class="path-status">â¬‡ï¸</div>
                        <h4>Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª</h4>
                        <div class="file-path">Downloads/</div>
                        <div class="file-size">Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©</div>
                    </div>

                    <div class="search-path-item" data-path="Documents">
                        <input type="checkbox" class="path-checkbox" checked>
                        <div class="path-status">ğŸ“„</div>
                        <h4>Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</h4>
                        <div class="file-path">Documents/</div>
                        <div class="file-size">Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†ØµÙŠØ©</div>
                    </div>
                </div>

                <div class="search-status" id="search-log">
                    <div class="search-log-entry log-info">ğŸ“¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„...</div>
                    <div class="search-log-entry log-info">ğŸ” ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ù„ÙØ§Øª TXT Ùˆ JSON ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div>
                    <div class="search-log-entry log-info">ğŸ¤– AI Ø¬Ø§Ù‡Ø² Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</div>
                </div>
            </div>

            <!-- AI Analysis Panel -->
            <div class="ai-analysis-panel">
                <h3>ğŸ¤– ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h3>
                <div class="analysis-progress">
                    <div class="analysis-progress-bar" id="ai-progress"></div>
                </div>
                <div id="ai-status">Ø¬Ø§Ù‡Ø² Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
            </div>

            <!-- File Discovery Panel -->
            <div class="discovery-panel">
                <h3>ğŸ“‚ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ© (<span id="discovered-count">0</span>)</h3>
                <div class="discovered-files" id="discovered-files"></div>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('matching')">ğŸ¤– Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</button>
                <button class="tab-btn" onclick="switchTab('requests')">ğŸ“ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ© (<span id="requests-tab-count">0</span>)</button>
                <button class="tab-btn" onclick="switchTab('offers')">ğŸ  Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ÙƒØªØ´ÙØ© (<span id="offers-tab-count">0</span>)</button>
                <button class="tab-btn" onclick="switchTab('results')">ğŸ¯ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (<span id="results-tab-count">0</span>)</button>
                <button class="tab-btn" onclick="switchTab('discovery')">ğŸ” Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ù„ÙØ§Øª</button>
            </div>

            <!-- Matching Tab -->
            <div id="matching-tab" class="tab-content active">
                <!-- Status Section -->
                <div class="status-section">
                    <h2>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©</h2>
                    <div id="status-message"></div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="total-docs">0</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="request-count">0</div>
                            <div class="stat-label">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="offer-count">0</div>
                            <div class="stat-label">Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="matches-count">0</div>
                            <div class="stat-label">Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Filter Section -->
                <div class="filter-section">
                    <h3>ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                    <div class="filter-grid">
                        <div class="filter-item">
                            <label>Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</label>
                            <select id="quality-filter">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</option>
                                <option value="Ù…Ø¤ÙƒØ¯Ø©">Ù…Ø¤ÙƒØ¯Ø©</option>
                                <option value="Ù…Ø­ØªÙ…Ù„Ø©">Ù…Ø­ØªÙ…Ù„Ø©</option>
                                <option value="Ù…Ù…ÙƒÙ†Ø©">Ù…Ù…ÙƒÙ†Ø©</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±</label>
                            <select id="property-type-filter">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                                <option value="Ø´Ù‚Ø©">Ø´Ù‚Ø©</option>
                                <option value="ÙÙŠÙ„Ø§">ÙÙŠÙ„Ø§</option>
                                <option value="Ø£Ø±Ø¶">Ø£Ø±Ø¶</option>
                                <option value="Ù…Ø­Ù„">Ù…Ø­Ù„ ØªØ¬Ø§Ø±ÙŠ</option>
                                <option value="Ù…ÙƒØªØ¨">Ù…ÙƒØªØ¨</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Ù…Ù†)</label>
                            <input type="number" id="price-min" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰">
                        </div>
                        <div class="filter-item">
                            <label>Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Ø¥Ù„Ù‰)</label>
                            <input type="number" id="price-max" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰">
                        </div>
                        <div class="filter-item">
                            <button class="btn primary" onclick="applyFilters()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©</button>
                        </div>
                    </div>
                </div>

                <!-- Controls Section -->
                <div class="controls-section" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                    <button class="btn success" id="start-matching-btn" onclick="runSmartMatching()">ğŸ§  Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</button>
                    <button class="btn" onclick="promptAndSaveApiKey()">ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ OpenAI</button>
                    <button class="btn" onclick="testApiKey()">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙØªØ§Ø­</button>
                    <button class="btn warning" onclick="deepScanSystem()">ğŸ”¬ ÙØ­Øµ Ø¹Ù…ÙŠÙ‚ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
                    <button class="btn purple" onclick="aiAutoDiscover()">ğŸ¤– Ø§ÙƒØªØ´Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ù€ AI</button>
                </div>

                <!-- Results Section -->
                <div class="results-section">
                    <h2>ğŸ’¡ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h2>
                    <div id="loader" class="loader"></div>
                    <div id="matches-container" class="matches-container"></div>
                    <p id="no-results" style="color: var(--muted); text-align: center; display: block;">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                </div>
            </div>

            <!-- Requests Tab -->
            <div id="requests-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>ğŸ“ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ© Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª</h2>
                    <div style="margin-bottom: 16px;">
                        <button class="btn success" onclick="exportRequests()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
                        <button class="btn" onclick="refreshRequestsView()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                        <button class="btn primary" onclick="analyzeRequestsPatterns()">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù†Ù…Ø§Ø·</button>
                    </div>
                    <div id="requests-container"></div>
                </div>
            </div>

            <!-- Offers Tab -->
            <div id="offers-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>ğŸ  Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ÙƒØªØ´ÙØ© Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª</h2>
                    <div style="margin-bottom: 16px;">
                        <button class="btn success" onclick="exportOffers()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ø±ÙˆØ¶</button>
                        <button class="btn" onclick="refreshOffersView()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                        <button class="btn primary" onclick="analyzeOffersPatterns()">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù†Ù…Ø§Ø·</button>
                    </div>
                    <div id="offers-container"></div>
                </div>
            </div>

            <!-- Results Tab -->
            <div id="results-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>ğŸ¯ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h2>
                    <div style="margin-bottom: 16px;">
                        <button class="btn success" onclick="exportResults()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
                        <button class="btn" onclick="refreshResultsView()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                        <button class="btn primary" onclick="generateMatchingReport()">ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</button>
                        <button class="btn warning" onclick="clearAllResults()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
                    </div>
                    
                    <!-- Results Statistics -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-item">
                            <div class="stat-number" id="results-total">0</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="results-confirmed">0</div>
                            <div class="stat-label">Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù…Ø¤ÙƒØ¯Ø©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="results-potential">0</div>
                            <div class="stat-label">Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù…Ø­ØªÙ…Ù„Ø©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="results-success-rate">0%</div>
                            <div class="stat-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                        </div>
                    </div>
                    
                    <div id="results-container"></div>
                </div>
            </div>

            <!-- Analysis Tab -->
            <div id="analysis-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©</h2>
                    <div id="analysis-results"></div>
                </div>
            </div>

            <!-- Discovery Tab -->
            <div id="discovery-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ù„ÙØ§Øª</h2>
                    <div id="discovery-settings"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =================================================================================
        // SUPER SMART FILE DISCOVERY AND AI ANALYSIS SYSTEM
        // =================================================================================

        // ===================== Core Variables =====================
        const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
        const OPENAI_MODEL = 'gpt-4o-mini';
        const API_KEY_STORAGE_KEY = 'OPENAI_API_KEY';

        let discoveredFiles = [];
        let allTextFiles = [];
        let requests = [];
        let offers = [];
        let allMatches = [];
        let filteredMatches = [];
        let searchProgress = 0;

        // ===================== Android File System Paths =====================
        const ANDROID_SEARCH_PATHS = [
            '/storage/emulated/0/',
            '/sdcard/',
            '/storage/',
            '/data/data/',
            '/data/media/',
            '/mnt/sdcard/',
            '/storage/sdcard0/',
            '/storage/extSdCard/',
            'Downloads/',
            'Documents/',
            'WhatsApp/Media/',
            'Telegram/',
            'Pictures/',
            'DCIM/',
            'Android/data/',
            'Android/obb/'
        ];

        const PRIORITY_FOLDERS = [
            'Downloads',
            'Documents', 
            'WhatsApp',
            'Telegram',
            'Real Estate',
            'Properties',
            'Ø¹Ù‚Ø§Ø±Ø§Øª',
            'Ù…Ù„ÙØ§Øª',
            'Ù…Ø³ØªÙ†Ø¯Ø§Øª'
        ];

        // ===================== File Access APIs (Simulated) =====================
        class SmartFileDiscovery {
            constructor() {
                this.foundFiles = [];
                this.scanProgress = 0;
                this.isScanning = false;
            }

            async requestPermissions() {
                // Simulate permission request
                return new Promise((resolve) => {
                    logToSearch('ğŸ” Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù„ÙØ§Øª...', 'info');
                    setTimeout(() => {
                        logToSearch('âœ… ØªÙ… Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        resolve(true);
                    }, 1000);
                });
            }

            async scanPath(path) {
                const selectedPaths = Array.from(document.querySelectorAll('.path-checkbox:checked'))
                    .map(cb => cb.closest('.search-path-item').dataset.path);

                if (!selectedPaths.includes(path)) return [];

                logToSearch(`ğŸ” ÙØ­Øµ Ø§Ù„Ù…Ø³Ø§Ø±: ${path}`, 'info');
                
                // Simulate file discovery with realistic Android paths
                const simulatedFiles = await this.simulateFileDiscovery(path);
                
                return simulatedFiles;
            }

            async simulateFileDiscovery(basePath) {
                const files = [];
                const fileTypes = ['.txt', '.json'];
                const commonNames = [
                    'real_estate_data',
                    'properties',
                    'listings',
                    'chat_export',
                    'telegram_export',
                    'whatsapp_chat',
                    'Ø¹Ù‚Ø§Ø±Ø§Øª',
                    'Ø¨ÙŠØ§Ù†Ø§Øª_Ø¹Ù‚Ø§Ø±ÙŠØ©',
                    'Ù‚ÙˆØ§Ø¦Ù…_Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª',
                    'Ù…Ø­Ø§Ø¯Ø«Ø§Øª',
                    'backup',
                    'export',
                    'data'
                ];

                // Simulate realistic file discovery
                for (let i = 0; i < Math.random() * 10 + 5; i++) {
                    const name = commonNames[Math.floor(Math.random() * commonNames.length)];
                    const ext = fileTypes[Math.floor(Math.random() * fileTypes.length)];
                    const fileName = `${name}_${Date.now() + i}${ext}`;
                    const fullPath = `${basePath}${fileName}`;
                    
                    // Simulate file content generation
                    const content = await this.generateRealisticContent(ext);
                    
                    files.push({
                        name: fileName,
                        path: fullPath,
                        size: content.length,
                        type: ext === '.json' ? 'application/json' : 'text/plain',
                        content: content,
                        lastModified: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000)
                    });

                    // Add delay to simulate real scanning
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                return files;
            }

            async generateRealisticContent(fileType) {
                if (fileType === '.json') {
                    // Generate realistic JSON chat export
                    const messages = [];
                    const sampleTexts = [
                        "Ù…Ø·Ù„ÙˆØ¨ Ø´Ù‚Ø© ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ Ø­ÙŠ Ø§Ù„Ù†Ø®ÙŠÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØ© 300 Ø£Ù„Ù",
                        "Ù„Ù„Ø¨ÙŠØ¹ ÙÙŠÙ„Ø§ ÙÙŠ Ø¬Ø¯Ø© Ø­ÙŠ Ø§Ù„Ø±ÙˆØ¶Ø© 450 Ø£Ù„Ù Ø±ÙŠØ§Ù„",
                        "Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¯Ù…Ø§Ù… Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±",
                        "Ù…Ø¹Ø±ÙˆØ¶ Ø´Ù‚Ù‚ Ù„Ù„Ø¥ÙŠØ¬Ø§Ø± ÙÙŠ Ù…ÙƒØ© Ø£Ø³Ø¹Ø§Ø± Ù…Ù†Ø§Ø³Ø¨Ø©",
                        "Ù…Ø·Ù„ÙˆØ¨ Ù…Ø­Ù„ ØªØ¬Ø§Ø±ÙŠ ÙÙŠ ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯",
                        "Ù„Ù„Ø¨ÙŠØ¹ Ø¹Ù…Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ø·Ø§Ø¦Ù Ø¹Ø§Ø¦Ø¯ Ù…Ù…ØªØ§Ø²",
                        "Ø£Ø±Ø¶ Ù„Ù„Ø¨ÙŠØ¹ ÙÙŠ Ø§Ù„Ù‚ØµÙŠÙ… Ù…ÙˆÙ‚Ø¹ Ù…Ù…ÙŠØ²",
                        "Ø´Ù‚Ø© Ù…ÙØ±ÙˆØ´Ø© Ù„Ù„Ø¥ÙŠØ¬Ø§Ø± ÙÙŠ Ø§Ù„Ø®Ø¨Ø±",
                        "ÙÙŠÙ„Ø§ Ø¯ÙˆØ¨Ù„ÙƒØ³ Ù„Ù„Ø¨ÙŠØ¹ ÙÙŠ Ø£Ø¨Ù‡Ø§",
                        "Ù…Ø·Ù„ÙˆØ¨ Ù…ÙƒØªØ¨ Ù„Ù„Ø¥ÙŠØ¬Ø§Ø± ÙÙŠ Ø¨Ø±Ø¬ ØªØ¬Ø§Ø±ÙŠ"
                    ];

                    for (let i = 0; i < Math.random() * 20 + 10; i++) {
                        const text = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
                        messages.push({
                            id: i + 1,
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
                            original_text: text,
                            phones: Math.random() > 0.7 ? [`05${Math.floor(Math.random() * 99999999).toString().padStart(8, '0')}`] : [],
                            prices: Math.random() > 0.6 ? [`${Math.floor(Math.random() * 500 + 100)} Ø£Ù„Ù Ø±ÙŠØ§Ù„`] : []
                        });
                    }

                    return JSON.stringify({
                        export_date: new Date().toISOString(),
                        messages: messages,
                        source: "chat_export"
                    }, null, 2);
                } else {
                    // Generate realistic text content
                    const textSamples = [
                        "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:\n\n",
                        "Ù„Ù„Ø¨ÙŠØ¹ Ø´Ù‚Ø© ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ 280 Ø£Ù„Ù\n",
                        "Ù…Ø·Ù„ÙˆØ¨ ÙÙŠÙ„Ø§ ÙÙŠ Ø¬Ø¯Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØ© 500 Ø£Ù„Ù\n",
                        "Ø£Ø±Ø¶ ØªØ¬Ø§Ø±ÙŠØ© Ù„Ù„Ø¨ÙŠØ¹ ÙÙŠ Ø§Ù„Ø¯Ù…Ø§Ù…\n",
                        "Ø´Ù‚Ù‚ Ù„Ù„Ø¥ÙŠØ¬Ø§Ø± Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ©\n",
                        "Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ø¹ÙˆØ§Ø¦Ø¯ Ø¹Ø§Ù„ÙŠØ©\n"
                    ];
                    return textSamples.join('\n');
                }
            }

            async deepScan() {
                this.isScanning = true;
                this.foundFiles = [];
                this.scanProgress = 0;

                logToSearch('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¹Ù…ÙŠÙ‚ Ù„Ù„Ù†Ø¸Ø§Ù…...', 'info');
                
                const totalPaths = ANDROID_SEARCH_PATHS.length;
                let scannedPaths = 0;

                for (const path of ANDROID_SEARCH_PATHS) {
                    try {
                        const pathFiles = await this.scanPath(path);
                        this.foundFiles.push(...pathFiles);
                        
                        scannedPaths++;
                        this.scanProgress = (scannedPaths / totalPaths) * 100;
                        
                        updateSearchProgress(this.scanProgress);
                        logToSearch(`ğŸ“ ØªÙ… ÙØ­Øµ ${path} - Ø¹Ø«Ø± Ø¹Ù„Ù‰ ${pathFiles.length} Ù…Ù„Ù`, 'success');
                        
                        // Update UI with discovered files
                        displayDiscoveredFiles(pathFiles);
                        
                    } catch (error) {
                        logToSearch(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ ${path}: ${error.message}`, 'error');
                    }
                }

                this.isScanning = false;
                logToSearch(`ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„ÙØ­Øµ! ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${this.foundFiles.length} Ù…Ù„Ù`, 'success');
                
                return this.foundFiles;
            }
        }

        // ===================== Smart AI Analysis =====================
        class SmartAIAnalyzer {
            constructor() {
                this.analysisCache = new Map();
            }

            async analyzeFiles(files) {
                logToSearch('ğŸ¤– Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...', 'info');
                
                const results = {
                    totalFiles: files.length,
                    textFiles: 0,
                    jsonFiles: 0,
                    totalRequests: 0,
                    totalOffers: 0,
                    extractedData: []
                };

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateAIProgress((i / files.length) * 100);
                    
                    try {
                        const analysis = await this.analyzeFile(file);
                        results.extractedData.push({
                            file: file.name,
                            path: file.path,
                            ...analysis
                        });

                        if (file.name.endsWith('.txt')) results.textFiles++;
                        if (file.name.endsWith('.json')) results.jsonFiles++;
                        
                        results.totalRequests += analysis.requests?.length || 0;
                        results.totalOffers += analysis.offers?.length || 0;

                        logToSearch(`âœ… ØªØ­Ù„ÙŠÙ„ ${file.name} - ${analysis.requests?.length || 0} Ø·Ù„Ø¨ØŒ ${analysis.offers?.length || 0} Ø¹Ø±Ø¶`, 'success');
                        
                    } catch (error) {
                        logToSearch(`âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ ${file.name}: ${error.message}`, 'error');
                    }
                }

                updateAIProgress(100);
                logToSearch(`ğŸ¯ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${results.totalRequests} Ø·Ù„Ø¨ØŒ ${results.totalOffers} Ø¹Ø±Ø¶`, 'success');
                
                return results;
            }

            async analyzeFile(file) {
                const cacheKey = `${file.path}_${file.lastModified}`;
                if (this.analysisCache.has(cacheKey)) {
                    return this.analysisCache.get(cacheKey);
                }

                const analysis = {
                    requests: [],
                    offers: [],
                    phones: [],
                    prices: [],
                    metadata: {
                        fileType: file.type,
                        size: file.size,
                        processed: new Date().toISOString()
                    }
                };

                try {
                    if (file.name.endsWith('.json')) {
                        const jsonData = JSON.parse(file.content);
                        if (jsonData.messages && Array.isArray(jsonData.messages)) {
                            jsonData.messages.forEach(message => {
                                const classified = this.classifyMessage(message.original_text || '');
                                if (classified.type === 'request') {
                                    analysis.requests.push({
                                        text: message.original_text,
                                        timestamp: message.timestamp,
                                        phones: message.phones || [],
                                        prices: message.prices || []
                                    });
                                } else if (classified.type === 'offer') {
                                    analysis.offers.push({
                                        text: message.original_text,
                                        timestamp: message.timestamp,
                                        phones: message.phones || [],
                                        prices: message.prices || []
                                    });
                                }
                                
                                analysis.phones.push(...(message.phones || []));
                                analysis.prices.push(...(message.prices || []));
                            });
                        }
                    } else {
                        // Text file analysis
                        const lines = file.content.split('\n').filter(line => line.trim());
                        lines.forEach(line => {
                            const classified = this.classifyMessage(line);
                            if (classified.type === 'request') {
                                analysis.requests.push({ text: line });
                            } else if (classified.type === 'offer') {
                                analysis.offers.push({ text: line });
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error analyzing file:', error);
                }

                this.analysisCache.set(cacheKey, analysis);
                return analysis;
            }

            classifyMessage(text) {
                if (!text) return { type: 'unknown', confidence: 0 };

                const textLower = text.toLowerCase();
                
                // Request keywords
                const requestKeywords = [
                    'Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ø¨Ø­Ø« Ø¹Ù†', 'Ø£Ø±ÙŠØ¯', 'Ù†Ø±ÙŠØ¯', 'Ù…Ø­ØªØ§Ø¬', 'Ø¨Ø­Ø§Ø¬Ø©',
                    'Ø¹Ø§ÙˆØ²', 'Ø¹Ø§ÙŠØ²', 'Ø§Ø¯ÙˆØ± Ø¹Ù„Ù‰', 'Ø£Ø¯ÙˆØ± Ø¹Ù„Ù‰', 'Ù†Ø¨Ø­Ø« Ø¹Ù†',
                    'wanted', 'looking for', 'need', 'require', 'searching'
                ];

                // Offer keywords  
                const offerKeywords = [
                    'Ù„Ù„Ø¨ÙŠØ¹', 'Ù„Ù„Ø§ÙŠØ¬Ø§Ø±', 'Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±', 'Ù…Ø¹Ø±ÙˆØ¶', 'Ù…ØªÙˆÙØ±', 'ÙŠÙˆØ¬Ø¯',
                    'Ø¹Ù†Ø¯ÙŠ', 'Ù„Ø¯ÙŠ', 'Ù…ØªØ§Ø­', 'Ù„Ù„ØªÙ†Ø§Ø²Ù„', 'Ø£Ø¹Ø±Ø¶', 'Ù†Ø¹Ø±Ø¶',
                    'for sale', 'for rent', 'available', 'offering'
                ];

                let requestScore = 0;
                let offerScore = 0;

                requestKeywords.forEach(keyword => {
                    if (textLower.includes(keyword)) requestScore++;
                });

                offerKeywords.forEach(keyword => {
                    if (textLower.includes(keyword)) offerScore++;
                });

                if (requestScore > offerScore) {
                    return { type: 'request', confidence: requestScore / requestKeywords.length };
                } else if (offerScore > requestScore) {
                    return { type: 'offer', confidence: offerScore / offerKeywords.length };
                }

                return { type: 'unknown', confidence: 0 };
            }
        }

        // ===================== Initialize Smart Systems =====================
        const smartDiscovery = new SmartFileDiscovery();
        const smartAnalyzer = new SmartAIAnalyzer();

        // ===================== UI Functions =====================
        function logToSearch(message, type = 'info') {
            const log = document.getElementById('search-log');
            const entry = document.createElement('div');
            entry.className = `search-log-entry log-${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateSearchProgress(percentage) {
            const indicator = document.getElementById('search-status-indicator');
            indicator.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ ${Math.round(percentage)}%`;
            
            if (percentage >= 100) {
                indicator.textContent = 'Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ù…Ø³Ø­';
            }
        }

        function updateAIProgress(percentage) {
            const progressBar = document.getElementById('ai-progress');
            const status = document.getElementById('ai-status');
            
            progressBar.style.width = percentage + '%';
            status.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„... ${Math.round(percentage)}%`;
            
            if (percentage >= 100) {
                status.textContent = 'Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ';
            }
        }

        function displayDiscoveredFiles(files) {
            const container = document.getElementById('discovered-files');
            const counter = document.getElementById('discovered-count');
            
            discoveredFiles.push(...files);
            counter.textContent = discoveredFiles.length;

            files.forEach(file => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'discovered-file-item';
                fileDiv.innerHTML = `
                    <div class="file-info">
                        <strong>${file.name}</strong>
                        <div class="file-path">${file.path}</div>
                        <div class="file-size">${formatFileSize(file.size)} - ${file.lastModified.toLocaleDateString('ar-SA')}</div>
                    </div>
                    <div>
                        <button class="btn btn-small" onclick="processFile('${file.path}')">ğŸ“‹ Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
                        <button class="btn btn-small success" onclick="analyzeFile('${file.path}')">ğŸ¤– ØªØ­Ù„ÙŠÙ„</button>
                    </div>
                `;
                container.appendChild(fileDiv);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ===================== Core Functions =====================
        async function startSmartSearch() {
            showMessage('info', 'ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…...');
            
            try {
                // Reset progress
                updateSearchProgress(0);
                updateAIProgress(0);
                
                // Start discovery
                const files = await smartDiscovery.deepScan();
                
                if (files.length > 0) {
                    showMessage('success', `ğŸ‰ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${files.length} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!`);
                    
                    // Auto-analyze discovered files
                    const analysisResults = await smartAnalyzer.analyzeFiles(files);
                    
                    // Update global variables for matching
                    allTextFiles = files;
                    updateStatsFromAnalysis(analysisResults);
                    
                    showMessage('success', `ğŸ¤– ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${analysisResults.totalRequests} Ø·Ù„Ø¨ØŒ ${analysisResults.totalOffers} Ø¹Ø±Ø¶`);
                } else {
                    showMessage('warning', 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª. Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…ÙŠÙ‚.');
                }
                
            } catch (error) {
                showMessage('error', `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ: ${error.message}`);
                logToSearch(`ğŸ’¥ Ø®Ø·Ø£ Ù†Ø¸Ø§Ù…: ${error.message}`, 'error');
            }
        }

        async function deepScanSystem() {
            showMessage('info', 'ğŸ”¬ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¹Ù…ÙŠÙ‚ Ù„Ù„Ù†Ø¸Ø§Ù…...');
            
            // Request enhanced permissions
            document.getElementById('permission-modal').style.display = 'flex';
        }

        async function aiAutoDiscover() {
            showMessage('info', 'ğŸ¤– ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...');
            
            // Enhanced AI discovery with pattern recognition
            logToSearch('ğŸ§  ØªØ­Ù„ÙŠÙ„ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ù„ÙØ§Øª...', 'info');
            logToSearch('ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø®ÙÙŠØ©...', 'warning');
            logToSearch('ğŸ“± ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª...', 'info');
            
            // Simulate intelligent discovery
            setTimeout(async () => {
                await startSmartSearch();
                logToSearch('ğŸ¯ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø°ÙƒÙŠ!', 'success');
            }, 2000);
        }

        function updateStatsFromAnalysis(analysis) {
            document.getElementById('total-docs').textContent = analysis.totalFiles;
            document.getElementById('request-count').textContent = analysis.totalRequests;
            document.getElementById('offer-count').textContent = analysis.totalOffers;
            
            // Prepare data for matching
            requests = [];
            offers = [];
            
            analysis.extractedData.forEach(fileData => {
                if (fileData.requests) {
                    requests.push(...fileData.requests.map(req => ({
                        text: req.text,
                        source: fileData.file,
                        phones: req.phones || [],
                        prices: req.prices || []
                    })));
                }
                if (fileData.offers) {
                    offers.push(...fileData.offers.map(offer => ({
                        text: offer.text,
                        source: fileData.file,
                        phones: offer.phones || [],
                        prices: offer.prices || []
                    })));
                }
            });
        }

        // ===================== Permission Handling =====================
        async function requestPermissions() {
            try {
                await smartDiscovery.requestPermissions();
                closePermissionModal();
                showMessage('success', 'âœ… ØªÙ… Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª');
                
                // Start enhanced deep scan
                setTimeout(startSmartSearch, 1000);
                
            } catch (error) {
                showMessage('error', 'âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
            }
        }

        function closePermissionModal() {
            document.getElementById('permission-modal').style.display = 'none';
        }

        // ===================== Tab Management =====================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // ===================== OpenAI Integration =====================
        function getApiKey() {
            return localStorage.getItem(API_KEY_STORAGE_KEY) || '';
        }

        function saveApiKey(key) {
            if (!key || !key.trim()) return false;
            localStorage.setItem(API_KEY_STORAGE_KEY, key.trim());
            return true;
        }

        function promptAndSaveApiKey() {
            const currentKey = getApiKey();
            const newKey = prompt('Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ OpenAI (ÙŠÙØ®Ø²Ù† Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ù…ØªØµÙØ­Ùƒ):', currentKey);
            if (newKey !== null) {
                if (saveApiKey(newKey)) {
                    showMessage('success', 'âœ… ØªÙ… Ø­ÙØ¸ Ù…ÙØªØ§Ø­ OpenAI Ù…Ø­Ù„ÙŠØ§Ù‹.');
                } else {
                    showMessage('error', 'âŒ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­. ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ ØºÙŠØ± ÙØ§Ø±Øº.');
                }
            }
        }

        async function testApiKey() {
            try {
                const key = getApiKey();
                if (!key) {
                    showMessage('error', 'âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ OpenAI. Ø§Ø¶ØºØ· "Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ OpenAI" Ù„Ø¥Ø¯Ø®Ø§Ù„Ù‡.');
                    return;
                }

                showMessage('info', 'ğŸ§ª Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙØªØ§Ø­...');

                const res = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: [{
                            role: 'user',
                            content: 'Test message'
                        }],
                        max_tokens: 10
                    })
                });

                if (res.ok) {
                    showMessage('success', 'âœ… Ø§Ù„Ù…ÙØªØ§Ø­ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.');
                } else {
                    showMessage('error', 'âŒ Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± ØµØ§Ù„Ø­.');
                }
            } catch (error) {
                showMessage('error', `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙØªØ§Ø­: ${error.message}`);
            }
        }

        // ===================== Smart Matching with Enhanced Error Handling =====================
        async function runSmartMatching() {
            const startBtn = document.getElementById('start-matching-btn');
            const loader = document.getElementById('loader');
            
            if (requests.length === 0 || offers.length === 0) {
                showMessage('warning', 'âš ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                return;
            }

            // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            startBtn.disabled = true;
            startBtn.textContent = 'ğŸ§  Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©...';
            loader.style.display = 'block';
            
            showMessage('info', 'ğŸ§  Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©...');
            logToSearch(`ğŸ” Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ ${requests.length} Ø·Ù„Ø¨ Ùˆ ${offers.length} Ø¹Ø±Ø¶`, 'info');
            
            try {
                const key = getApiKey();
                if (!key) {
                    throw new Error('Ù…Ø·Ù„ÙˆØ¨ Ù…ÙØªØ§Ø­ OpenAI Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©');
                }

                performanceMonitor.startTimer('matching');
                updateAIProgress(10);
                
                // Ø¥Ù†Ø´Ø§Ø¡ prompt Ù…Ø­Ø³Ù†
                const prompt = createSmartMatchingPrompt(requests, offers);
                logToSearch('ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù€ OpenAI Ù„Ù„ØªØ­Ù„ÙŠÙ„...', 'info');
                updateAIProgress(30);
                
                // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ OpenAI
                const matches = await callOpenAI(prompt, key);
                updateAIProgress(80);
                
                performanceMonitor.endTimer('matching');
                
                if (matches && matches.length > 0) {
                    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    displayMatches(matches);
                    updateAIProgress(100);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    document.getElementById('matches-count').textContent = matches.length;
                    
                    // Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    saveMatchingResults(matches);
                    
                    showMessage('success', `ğŸ‰ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${matches.length} Ù…Ø·Ø§Ø¨Ù‚Ø© Ø°ÙƒÙŠØ©!`);
                    logToSearch(`âœ… Ù†Ø¬Ø­Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: ${matches.length} Ù†ØªÙŠØ¬Ø©`, 'success');
                    
                    // ØªØ­Ù„ÙŠÙ„ Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    analyzeMatchQuality(matches);
                    
                } else {
                    updateAIProgress(100);
                    showMessage('info', 'ğŸ“‹ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù‚ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©');
                    logToSearch('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù‚ÙˆÙŠØ©', 'warning');
                    
                    // Ø¹Ø±Ø¶ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
                    displaySuggestions();
                }

            } catch (error) {
                updateAIProgress(0);
                console.error('Smart matching error:', error);
                showMessage('error', `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©: ${error.message}`);
                logToSearch(`ğŸ’¥ ÙØ´Ù„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: ${error.message}`, 'error');
                
                // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ´Ø®ÙŠØµÙŠØ©
                displayDiagnosticInfo(error);
                
            } finally {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
                startBtn.disabled = false;
                startBtn.textContent = 'ğŸ§  Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©';
                loader.style.display = 'none';
                
                // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
                updatePerformanceStats();
            }
        }

        function analyzeMatchQuality(matches) {
            const qualityStats = {
                Ù…Ø¤ÙƒØ¯Ø©: matches.filter(m => m.quality === 'Ù…Ø¤ÙƒØ¯Ø©').length,
                Ù…Ø­ØªÙ…Ù„Ø©: matches.filter(m => m.quality === 'Ù…Ø­ØªÙ…Ù„Ø©').length,
                Ù…Ù…ÙƒÙ†Ø©: matches.filter(m => m.quality === 'Ù…Ù…ÙƒÙ†Ø©').length
            };
            
            logToSearch(`ğŸ“Š Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª - Ù…Ø¤ÙƒØ¯Ø©: ${qualityStats.Ù…Ø¤ÙƒØ¯Ø©}, Ù…Ø­ØªÙ…Ù„Ø©: ${qualityStats.Ù…Ø­ØªÙ…Ù„Ø©}, Ù…Ù…ÙƒÙ†Ø©: ${qualityStats.Ù…Ù…ÙƒÙ†Ø©}`, 'info');
            
            // Ø¹Ø±Ø¶ ØªØ­Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹
            const highQualityPercent = Math.round((qualityStats.Ù…Ø¤ÙƒØ¯Ø© / matches.length) * 100);
            if (highQualityPercent >= 70) {
                showMessage('success', `ğŸŒŸ Ù…Ù…ØªØ§Ø²! ${highQualityPercent}% Ù…Ù† Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù…Ø¤ÙƒØ¯Ø©`);
            } else if (highQualityPercent >= 40) {
                showMessage('info', `ğŸ‘ Ø¬ÙŠØ¯! ${highQualityPercent}% Ù…Ù† Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù…Ø¤ÙƒØ¯Ø©`);
            } else {
                showMessage('warning', `âš ï¸ Ø¬ÙˆØ¯Ø© Ù…Ù†Ø®ÙØ¶Ø©: ${highQualityPercent}% ÙÙ‚Ø· Ù…Ø¤ÙƒØ¯Ø©`);
            }
        }

        function saveMatchingResults(matches) {
            try {
                const resultsData = {
                    timestamp: new Date().toISOString(),
                    totalMatches: matches.length,
                    sourceRequests: requests.length,
                    sourceOffers: offers.length,
                    matches: matches,
                    performance: performanceMonitor.getReport()
                };
                
                localStorage.setItem('smart_matching_results', JSON.stringify(resultsData));
                logToSearch('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©', 'success');
                
            } catch (error) {
                logToSearch(`âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${error.message}`, 'error');
            }
        }

        function displaySuggestions() {
            const container = document.getElementById('matches-container');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; background: rgba(245, 158, 11, 0.1); border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 16px;">
                    <h3>ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                    <div style="text-align: right; margin-top: 20px;">
                        <p>ğŸ” <strong>Ø§Ø¨Ø­Ø« ÙÙŠ Ù…Ø¬Ù„Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</strong> Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…ÙŠÙ‚ Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª Ø£ÙƒØ«Ø±</p>
                        <p>ğŸ“± <strong>ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©:</strong> WhatsApp, Telegram Ù‚Ø¯ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù‚Ø§Ø±ÙŠØ©</p>
                        <p>ğŸ“„ <strong>Ø£Ø¶Ù Ù…Ù„ÙØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹:</strong> Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ø±ÙˆØ¶ ÙˆØ·Ù„Ø¨Ø§Øª</p>
                        <p>ğŸ¤– <strong>Ø­Ø³Ù† Ø§Ù„Ù€ prompt:</strong> ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn primary" onclick="deepScanSystem()">ğŸ”¬ ÙØ­Øµ Ø¹Ù…ÙŠÙ‚</button>
                        <button class="btn success" onclick="aiAutoDiscover()">ğŸ¤– Ø§ÙƒØªØ´Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                    </div>
                </div>
            `;
        }

        function displayDiagnosticInfo(error) {
            logToSearch('ğŸ”§ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ´Ø®ÙŠØµÙŠØ©:', 'info');
            logToSearch(`- Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£: ${error.name}`, 'info');
            logToSearch(`- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£: ${error.message}`, 'error');
            logToSearch(`- Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${requests.length}`, 'info');
            logToSearch(`- Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶: ${offers.length}`, 'info');
            logToSearch(`- Ø­Ø§Ù„Ø© Ù…ÙØªØ§Ø­ API: ${getApiKey() ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'Ù…ÙÙ‚ÙˆØ¯'}`, getApiKey() ? 'success' : 'error');
            
            if (error.message.includes('API')) {
                logToSearch('ğŸ’¡ Ø¬Ø±Ø¨ Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙØªØ§Ø­ OpenAI Ø£ÙˆÙ„Ø§Ù‹', 'warning');
            }
        }

        function createSmartMatchingPrompt(requestsBatch, offersBatch) {
            return `Ø£Ù†Øª Ù…Ø­Ù„Ù„ Ø¹Ù‚Ø§Ø±ÙŠ Ø°ÙƒÙŠ. Ù…Ù‡Ù…ØªÙƒ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ© ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.

Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©:

Ø§Ù„Ø·Ù„Ø¨Ø§Øª:
${requestsBatch.map((req, i) => `${i + 1}. ${req.text}`).join('\n')}

Ø§Ù„Ø¹Ø±ÙˆØ¶:
${offersBatch.map((offer, i) => `${i + 1}. ${offer.text}`).join('\n')}

ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù…Ù‡Ù…Ø©:
- Ø£Ø±Ø¬Ø¹ Ù…ØµÙÙˆÙØ© JSON ÙÙ‚Ø·
- Ù„Ø§ ØªØ¶Ø¹ Ø£ÙŠ Ù†Øµ Ù‚Ø¨Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯ JSON
- Ø§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù€ [
- ÙƒÙ„ Ù…Ø·Ø§Ø¨Ù‚Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙ‚Ø·:

[
{
  "quality": "Ù…Ø¤ÙƒØ¯Ø©",
  "property_type": "Ø´Ù‚Ø©",
  "area": "Ø§Ù„Ø±ÙŠØ§Ø¶",
  "requested_price": "300 Ø£Ù„Ù",
  "offered_price": "280 Ø£Ù„Ù",
  "reason": "Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©",
  "request_text": "Ù†Øµ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„",
  "offer_text": "Ù†Øµ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„",
  "urgency_score": 8,
  "source_files": "Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ØµØ¯Ø±"
}
]`;
        }

        async function callOpenAI(prompt, apiKey) {
            const response = await fetch(OPENAI_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: OPENAI_MODEL,
                    messages: [{
                        role: 'system',
                        content: 'Ø£Ø±Ø¬Ø¹ JSON ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ Ø£Ùˆ Ø´Ø±Ø­. Ø§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù€ [ ÙˆØ§Ù†ØªÙ‡ Ø¨Ù€ ]'
                    }, {
                        role: 'user',
                        content: prompt
                    }],
                    temperature: 0.3,
                    max_tokens: 4000
                })
            });

            if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.status}`);
            }

            const data = await response.json();
            let content = data.choices[0].message.content;
            
            try {
                // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù†Øµ Ù‚Ø¨Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯ JSON
                content = content.replace(/```json|```/g, '').trim();
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨Ø¯Ø§ÙŠØ© JSON
                const jsonStart = content.indexOf('[');
                const jsonEnd = content.lastIndexOf(']');
                
                if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
                    content = content.substring(jsonStart, jsonEnd + 1);
                }
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù„ÙŠÙ„ JSON
                const parsed = JSON.parse(content);
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…ØµÙÙˆÙØ©
                if (Array.isArray(parsed)) {
                    logToSearch(`âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ ${parsed.length} Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ù† OpenAI`, 'success');
                    return parsed;
                } else {
                    logToSearch('âš ï¸ OpenAI Ù„Ù… ÙŠØ±Ø¬Ø¹ Ù…ØµÙÙˆÙØ© ØµØ§Ù„Ø­Ø©', 'warning');
                    return [];
                }
                
            } catch (e) {
                console.error('Failed to parse OpenAI response:', content);
                logToSearch(`âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© OpenAI: ${e.message}`, 'error');
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø© - Ø§Ø³ØªØ®Ø±Ø§Ø¬ JSON Ù…Ù† Ø§Ù„Ù†Øµ
                try {
                    const regex = /\[[\s\S]*\]/;
                    const match = content.match(regex);
                    if (match) {
                        const extracted = JSON.parse(match[0]);
                        if (Array.isArray(extracted)) {
                            logToSearch(`âœ… ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${extracted.length} Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                            return extracted;
                        }
                    }
                } catch (e2) {
                    console.error('Final parsing attempt failed:', e2);
                }
                
                return [];
            }
        }

        function displayMatches(matches) {
            const container = document.getElementById('matches-container');
            const noResults = document.getElementById('no-results');
            
            container.innerHTML = '';
            noResults.style.display = 'none';

            if (!matches || matches.length === 0) {
                noResults.style.display = 'block';
                return;
            }

            allMatches = matches;
            filteredMatches = matches;

            matches.forEach((match, index) => {
                const card = document.createElement('div');
                card.className = 'match-card';
                card.innerHTML = `
                    <div class="match-header">
                        <h3>ğŸ  Ù…Ø·Ø§Ø¨Ù‚Ø© ${match.property_type || 'Ø¹Ù‚Ø§Ø±ÙŠØ©'}</h3>
                        <span class="match-quality ${match.quality}">${match.quality}</span>
                    </div>
                    <div><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${match.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                    <div><strong>Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨:</strong> ${match.requested_price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                    <div><strong>Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶:</strong> ${match.offered_price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                    <div><strong>Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØµØ¯Ø±:</strong> ${match.source_files || 'Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØªØ´ÙØ©'}</div>
                    <div><strong>ğŸ’¡ Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:</strong> ${match.reason}</div>
                    <div style="margin-top: 12px;">
                        <h4>ğŸ“ Ù†Øµ Ø§Ù„Ø·Ù„Ø¨:</h4>
                        <p style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px;">${match.request_text}</p>
                    </div>
                    <div style="margin-top: 12px;">
                        <h4>ğŸ  Ù†Øµ Ø§Ù„Ø¹Ø±Ø¶:</h4>
                        <p style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px;">${match.offer_text}</p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ===================== Utility Functions =====================
        function showMessage(type, message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = type;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function applyFilters() {
            // Implement filtering logic for discovered matches
            showMessage('info', 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ÙƒØªØ´ÙØ©...');
        }

        // ===================== Initialize System =====================
        document.addEventListener('DOMContentLoaded', () => {
            logToSearch('ğŸš€ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„', 'success');
            logToSearch('ğŸ“± Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯', 'info');
            logToSearch('ğŸ¤– AI Ù…Ø­Ù„Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙÙØ¹Ù„', 'success');
            showMessage('success', 'ğŸ§  Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ Ø¬Ø§Ù‡Ø²! Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ù„ÙØ§Øª');
        });
        
        // ===================== Advanced File Processing =====================
        async function processFile(filePath) {
            showMessage('info', `ğŸ“‹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: ${filePath}`);
            
            const file = discoveredFiles.find(f => f.path === filePath);
            if (!file) {
                showMessage('error', 'âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            try {
                const analysis = await smartAnalyzer.analyzeFile(file);
                
                // Save to system database
                const processedFile = {
                    id: Date.now().toString(),
                    name: file.name,
                    path: file.path,
                    content: file.content,
                    type: file.type,
                    size: file.size,
                    uploadTime: new Date().toLocaleString('ar-SA'),
                    timestamp: Date.now(),
                    analysisData: analysis
                };

                // Add to allTextFiles for matching
                allTextFiles.push(processedFile);
                
                // Extract requests and offers
                if (analysis.requests) {
                    requests.push(...analysis.requests.map(req => ({
                        text: req.text,
                        source: file.name,
                        phones: req.phones || [],
                        prices: req.prices || []
                    })));
                }

                if (analysis.offers) {
                    offers.push(...analysis.offers.map(offer => ({
                        text: offer.text,
                        source: file.name,
                        phones: offer.phones || [],
                        prices: offer.prices || []
                    })));
                }

                // Update stats
                document.getElementById('total-docs').textContent = allTextFiles.length;
                document.getElementById('request-count').textContent = requests.length;
                document.getElementById('offer-count').textContent = offers.length;

                showMessage('success', `âœ… ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${file.name} - ${analysis.requests?.length || 0} Ø·Ù„Ø¨ØŒ ${analysis.offers?.length || 0} Ø¹Ø±Ø¶`);
                
            } catch (error) {
                showMessage('error', `âŒ ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: ${error.message}`);
                logToSearch(`ğŸ’¥ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ${file.name}: ${error.message}`, 'error');
            }
        }

        async function analyzeFile(filePath) {
            showMessage('info', `ğŸ¤– ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${filePath}`);
            
            const file = discoveredFiles.find(f => f.path === filePath);
            if (!file) {
                showMessage('error', 'âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            try {
                updateAIProgress(0);
                const analysis = await smartAnalyzer.analyzeFile(file);
                updateAIProgress(100);
                
                // Display analysis results
                displayAnalysisResults(file, analysis);
                showMessage('success', `ğŸ¯ ØªÙ… ØªØ­Ù„ÙŠÙ„ ${file.name} Ø¨Ù†Ø¬Ø§Ø­`);
                
            } catch (error) {
                showMessage('error', `âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${error.message}`);
            }
        }

        function displayAnalysisResults(file, analysis) {
            const resultsContainer = document.getElementById('analysis-results');
            if (!resultsContainer) return;

            const resultCard = document.createElement('div');
            resultCard.className = 'analytics-card';
            resultCard.innerHTML = `
                <h4>ğŸ“Š ØªØ­Ù„ÙŠÙ„: ${file.name}</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px;">
                    <div class="stat-item">
                        <div class="stat-number">${analysis.requests?.length || 0}</div>
                        <div class="stat-label">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${analysis.offers?.length || 0}</div>
                        <div class="stat-label">Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${analysis.phones?.length || 0}</div>
                        <div class="stat-label">Ø£Ø±Ù‚Ø§Ù… Ù‡ÙˆØ§ØªÙ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${analysis.prices?.length || 0}</div>
                        <div class="stat-label">Ø£Ø³Ø¹Ø§Ø±</div>
                    </div>
                </div>
                
                ${analysis.requests?.length > 0 ? `
                    <h5>ğŸ“ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©:</h5>
                    <div style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        ${analysis.requests.map((req, i) => `
                            <div style="margin-bottom: 8px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 4px;">
                                <strong>Ø·Ù„Ø¨ ${i + 1}:</strong> ${req.text.substring(0, 100)}${req.text.length > 100 ? '...' : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${analysis.offers?.length > 0 ? `
                    <h5>ğŸ  Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ÙƒØªØ´ÙØ©:</h5>
                    <div style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        ${analysis.offers.map((offer, i) => `
                            <div style="margin-bottom: 8px; padding: 8px; background: rgba(34, 197, 94, 0.1); border-radius: 4px;">
                                <strong>Ø¹Ø±Ø¶ ${i + 1}:</strong> ${offer.text.substring(0, 100)}${offer.text.length > 100 ? '...' : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div style="margin-top: 16px;">
                    <button class="btn primary" onclick="processFile('${file.path}')">âœ… Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù†Ø¸Ø§Ù…</button>
                    <button class="btn success" onclick="exportAnalysis('${file.name}')">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
                </div>
            `;
            
            resultsContainer.appendChild(resultCard);
        }

        // ===================== Display Functions for Requests, Offers & Results =====================
        
        function updateTabCounters() {
            document.getElementById('requests-tab-count').textContent = requests.length;
            document.getElementById('offers-tab-count').textContent = offers.length;
            document.getElementById('results-tab-count').textContent = allMatches.length;
        }

        function displayRequests() {
            const container = document.getElementById('requests-container');
            if (!container) return;

            if (requests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--muted);">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div>
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªØ´ÙØ©</h3>
                        <p>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª</p>
                        <button class="btn primary" onclick="startSmartSearch()">ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«</button>
                    </div>
                `;
                return;
            }

            const requestsHTML = requests.map((request, index) => `
                <div class="discovered-file-item" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);">
                    <div class="file-info" style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="background: var(--accent-2); color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                Ø·Ù„Ø¨ ${index + 1}
                            </span>
                            <span style="color: var(--muted); font-size: 12px;">
                                Ø§Ù„Ù…ØµØ¯Ø±: ${request.source || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                            </span>
                        </div>
                        <div style="font-weight: 500; margin-bottom: 8px; line-height: 1.4;">
                            ${request.text}
                        </div>
                        ${request.phones && request.phones.length > 0 ? `
                            <div style="font-size: 12px; color: var(--accent); margin-bottom: 4px;">
                                ğŸ“ ${request.phones.join(', ')}
                            </div>
                        ` : ''}
                        ${request.prices && request.prices.length > 0 ? `
                            <div style="font-size: 12px; color: var(--accent-3); margin-bottom: 4px;">
                                ğŸ’° ${request.prices.join(', ')}
                            </div>
                        ` : ''}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <button class="btn btn-small" onclick="findMatchesForRequest(${index})" title="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø·Ø§Ø¨Ù‚Ø§Øª">ğŸ”</button>
                        <button class="btn btn-small success" onclick="copyRequestText(${index})" title="Ù†Ø³Ø® Ø§Ù„Ù†Øµ">ğŸ“‹</button>
                        <button class="btn btn-small warning" onclick="editRequest(${index})" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = requestsHTML;
        }

        function displayOffers() {
            const container = document.getElementById('offers-container');
            if (!container) return;

            if (offers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--muted);">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ </div>
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…ÙƒØªØ´ÙØ©</h3>
                        <p>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª</p>
                        <button class="btn primary" onclick="startSmartSearch()">ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«</button>
                    </div>
                `;
                return;
            }

            const offersHTML = offers.map((offer, index) => `
                <div class="discovered-file-item" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3);">
                    <div class="file-info" style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                Ø¹Ø±Ø¶ ${index + 1}
                            </span>
                            <span style="color: var(--muted); font-size: 12px;">
                                Ø§Ù„Ù…ØµØ¯Ø±: ${offer.source || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                            </span>
                        </div>
                        <div style="font-weight: 500; margin-bottom: 8px; line-height: 1.4;">
                            ${offer.text}
                        </div>
                        ${offer.phones && offer.phones.length > 0 ? `
                            <div style="font-size: 12px; color: var(--accent); margin-bottom: 4px;">
                                ğŸ“ ${offer.phones.join(', ')}
                            </div>
                        ` : ''}
                        ${offer.prices && offer.prices.length > 0 ? `
                            <div style="font-size: 12px; color: var(--accent-3); margin-bottom: 4px;">
                                ğŸ’° ${offer.prices.join(', ')}
                            </div>
                        ` : ''}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <button class="btn btn-small" onclick="findMatchesForOffer(${index})" title="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø·Ø§Ø¨Ù‚Ø§Øª">ğŸ”</button>
                        <button class="btn btn-small success" onclick="copyOfferText(${index})" title="Ù†Ø³Ø® Ø§Ù„Ù†Øµ">ğŸ“‹</button>
                        <button class="btn btn-small warning" onclick="editOffer(${index})" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = offersHTML;
        }

        function displayResults() {
            const container = document.getElementById('results-container');
            if (!container) return;

            if (!allMatches || allMatches.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--muted);">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¯</div>
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</h3>
                        <p>Ù‚Ù… Ø¨Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</p>
                        <button class="btn primary" onclick="runSmartMatching()">ğŸ§  Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</button>
                    </div>
                `;
                return;
            }

            // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            updateResultsStats();

            const resultsHTML = allMatches.map((match, index) => `
                <div class="match-card" style="margin-bottom: 16px;">
                    <div class="match-header">
                        <h3>ğŸ  Ù…Ø·Ø§Ø¨Ù‚Ø© ${index + 1}: ${match.property_type || 'Ø¹Ù‚Ø§Ø±ÙŠØ©'}</h3>
                        <span class="match-quality ${match.quality}">${match.quality}</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <div><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${match.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div><strong>Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨:</strong> ${match.requested_price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div><strong>Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶:</strong> ${match.offered_price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div><strong>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¥Ù„Ø­Ø§Ø­:</strong> ${match.urgency_score || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}/10</div>
                        <div><strong>Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØµØ¯Ø±:</strong> ${match.source_files || 'Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØªØ´ÙØ©'}</div>
                    </div>
                    
                    <div style="background: rgba(139, 92, 246, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <strong>ğŸ’¡ Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:</strong> ${match.reason}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <h4 style="margin: 0 0 8px; color: var(--accent-2);">ğŸ“ Ù†Øµ Ø§Ù„Ø·Ù„Ø¨:</h4>
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                                ${match.request_text}
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 8px; color: var(--accent);">ğŸ  Ù†Øµ Ø§Ù„Ø¹Ø±Ø¶:</h4>
                            <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                                ${match.offer_text}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn success" onclick="exportMatch(${index})" title="ØªØµØ¯ÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©">ğŸ“¤ ØªØµØ¯ÙŠØ±</button>
                        <button class="btn primary" onclick="shareMatch(${index})" title="Ù…Ø´Ø§Ø±ÙƒØ©">ğŸ“± Ù…Ø´Ø§Ø±ÙƒØ©</button>
                        <button class="btn warning" onclick="editMatch(${index})" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn" onclick="duplicateMatch(${index})" title="ØªÙƒØ±Ø§Ø±">ğŸ“‹ ØªÙƒØ±Ø§Ø±</button>
                        <button class="btn" style="background: var(--danger);" onclick="deleteMatch(${index})" title="Ø­Ø°Ù">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = resultsHTML;
        }

        function updateResultsStats() {
            if (!allMatches || allMatches.length === 0) {
                document.getElementById('results-total').textContent = '0';
                document.getElementById('results-confirmed').textContent = '0';
                document.getElementById('results-potential').textContent = '0';
                document.getElementById('results-success-rate').textContent = '0%';
                return;
            }

            const total = allMatches.length;
            const confirmed = allMatches.filter(m => m.quality === 'Ù…Ø¤ÙƒØ¯Ø©').length;
            const potential = allMatches.filter(m => m.quality === 'Ù…Ø­ØªÙ…Ù„Ø©').length;
            const successRate = total > 0 ? Math.round((confirmed / total) * 100) : 0;

            document.getElementById('results-total').textContent = total;
            document.getElementById('results-confirmed').textContent = confirmed;
            document.getElementById('results-potential').textContent = potential;
            document.getElementById('results-success-rate').textContent = successRate + '%';
        }

        // ===================== Export Functions =====================
        
        function exportRequests() {
            if (requests.length === 0) {
                showMessage('warning', 'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                type: 'Ø·Ù„Ø¨Ø§Øª Ø¹Ù‚Ø§Ø±ÙŠØ©',
                count: requests.length,
                data: requests
            };

            downloadJSON(exportData, `Ø§Ù„Ø·Ù„Ø¨Ø§Øª_Ø§Ù„Ù…ÙƒØªØ´ÙØ©_${Date.now()}.json`);
            showMessage('success', `ğŸ“¤ ØªÙ… ØªØµØ¯ÙŠØ± ${requests.length} Ø·Ù„Ø¨`);
        }

        function exportOffers() {
            if (offers.length === 0) {
                showMessage('warning', 'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                type: 'Ø¹Ø±ÙˆØ¶ Ø¹Ù‚Ø§Ø±ÙŠØ©',
                count: offers.length,
                data: offers
            };

            downloadJSON(exportData, `Ø§Ù„Ø¹Ø±ÙˆØ¶_Ø§Ù„Ù…ÙƒØªØ´ÙØ©_${Date.now()}.json`);
            showMessage('success', `ğŸ“¤ ØªÙ… ØªØµØ¯ÙŠØ± ${offers.length} Ø¹Ø±Ø¶`);
        }

        function exportResults() {
            if (!allMatches || allMatches.length === 0) {
                showMessage('warning', 'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                type: 'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©',
                stats: {
                    total: allMatches.length,
                    confirmed: allMatches.filter(m => m.quality === 'Ù…Ø¤ÙƒØ¯Ø©').length,
                    potential: allMatches.filter(m => m.quality === 'Ù…Ø­ØªÙ…Ù„Ø©').length,
                    possible: allMatches.filter(m => m.quality === 'Ù…Ù…ÙƒÙ†Ø©').length
                },
                data: allMatches
            };

            downloadJSON(exportData, `Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©_${Date.now()}.json`);
            showMessage('success', `ğŸ“¤ ØªÙ… ØªØµØ¯ÙŠØ± ${allMatches.length} Ù†ØªÙŠØ¬Ø©`);
        }

        // ===================== Interactive Functions =====================
        
        function findMatchesForRequest(requestIndex) {
            const request = requests[requestIndex];
            if (!request) return;

            showMessage('info', `ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù„Ù„Ø·Ù„Ø¨: ${request.text.substring(0, 50)}...`);
            
            // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨
            const relatedMatches = allMatches.filter(match => 
                match.request_text && match.request_text.includes(request.text.substring(0, 30))
            );

            if (relatedMatches.length > 0) {
                switchTab('results');
                highlightMatches(relatedMatches);
                showMessage('success', `âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${relatedMatches.length} Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨`);
            } else {
                showMessage('warning', 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨');
            }
        }

        function findMatchesForOffer(offerIndex) {
            const offer = offers[offerIndex];
            if (!offer) return;

            showMessage('info', `ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù„Ù„Ø¹Ø±Ø¶: ${offer.text.substring(0, 50)}...`);
            
            const relatedMatches = allMatches.filter(match => 
                match.offer_text && match.offer_text.includes(offer.text.substring(0, 30))
            );

            if (relatedMatches.length > 0) {
                switchTab('results');
                highlightMatches(relatedMatches);
                showMessage('success', `âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${relatedMatches.length} Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶`);
            } else {
                showMessage('warning', 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶');
            }
        }

        function highlightMatches(matches) {
            // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            setTimeout(() => {
                const matchCards = document.querySelectorAll('.match-card');
                matchCards.forEach((card, index) => {
                    if (matches.some(m => allMatches[index] === m)) {
                        card.style.border = '3px solid var(--accent)';
                        card.style.boxShadow = '0 0 20px rgba(34, 197, 94, 0.3)';
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }, 500);
        }

        function copyRequestText(index) {
            const request = requests[index];
            if (request) {
                navigator.clipboard.writeText(request.text);
                showMessage('success', 'ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ù†Øµ Ø§Ù„Ø·Ù„Ø¨');
            }
        }

        function copyOfferText(index) {
            const offer = offers[index];
            if (offer) {
                navigator.clipboard.writeText(offer.text);
                showMessage('success', 'ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ù†Øµ Ø§Ù„Ø¹Ø±Ø¶');
            }
        }

        function editRequest(index) {
            const request = requests[index];
            if (!request) return;

            const newText = prompt('ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø§Ù„Ø·Ù„Ø¨:', request.text);
            if (newText && newText.trim()) {
                requests[index].text = newText.trim();
                displayRequests();
                updateTabCounters();
                showMessage('success', 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨');
                
                // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                saveDataToStorage();
            }
        }

        function editOffer(index) {
            const offer = offers[index];
            if (!offer) return;

            const newText = prompt('ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø§Ù„Ø¹Ø±Ø¶:', offer.text);
            if (newText && newText.trim()) {
                offers[index].text = newText.trim();
                displayOffers();
                updateTabCounters();
                showMessage('success', 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶');
                
                // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                saveDataToStorage();
            }
        }

        function exportMatch(index) {
            const match = allMatches[index];
            if (!match) return;

            const exportData = {
                exportDate: new Date().toISOString(),
                matchNumber: index + 1,
                match: match
            };

            downloadJSON(exportData, `Ù…Ø·Ø§Ø¨Ù‚Ø©_${index + 1}_${Date.now()}.json`);
            showMessage('success', `ğŸ“¤ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ${index + 1}`);
        }

        function shareMatch(index) {
            const match = allMatches[index];
            if (!match) return;

            const shareText = `ğŸ  Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¹Ù‚Ø§Ø±ÙŠØ© ${match.quality}

ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${match.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨: ${match.requested_price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶: ${match.offered_price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}

ğŸ“ Ø§Ù„Ø·Ù„Ø¨: ${match.request_text}
ğŸ  Ø§Ù„Ø¹Ø±Ø¶: ${match.offer_text}

ğŸ’¡ Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: ${match.reason}`;

            if (navigator.share) {
                navigator.share({
                    title: 'Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¹Ù‚Ø§Ø±ÙŠØ©',
                    text: shareText
                });
            } else {
                navigator.clipboard.writeText(shareText);
                showMessage('success', 'ğŸ“‹ ØªÙ… Ù†Ø³Ø® ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
            }
        }

        function deleteMatch(index) {
            if (confirm(`ğŸ—‘ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ${index + 1}ØŸ`)) {
                allMatches.splice(index, 1);
                displayResults();
                updateTabCounters();
                showMessage('success', 'âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©');
                
                // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                saveMatchingResults(allMatches);
            }
        }

        function duplicateMatch(index) {
            const match = allMatches[index];
            if (!match) return;

            const duplicated = { ...match };
            duplicated.reason = duplicated.reason + ' (Ù†Ø³Ø®Ø©)';
            
            allMatches.push(duplicated);
            displayResults();
            updateTabCounters();
            showMessage('success', 'âœ… ØªÙ… ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©');
            
            // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            saveMatchingResults(allMatches);
        }

        function clearAllResults() {
            if (confirm('ğŸ—‘ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) {
                allMatches = [];
                displayResults();
                updateTabCounters();
                showMessage('success', 'âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬');
                
                // Ù…Ø³Ø­ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
                localStorage.removeItem('smart_matching_results');
            }
        }

        // ===================== Advanced Analysis Functions =====================
        
        function analyzeRequestsPatterns() {
            if (requests.length === 0) {
                showMessage('warning', 'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ­Ù„ÙŠÙ„');
                return;
            }

            showMessage('info', 'ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª...');

            const patterns = {
                propertyTypes: {},
                priceRanges: {},
                locations: {},
                totalWithPrices: 0,
                totalWithPhones: 0
            };

            requests.forEach(request => {
                const text = request.text.toLowerCase();
                
                // ØªØ­Ù„ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                if (text.includes('Ø´Ù‚Ø©')) patterns.propertyTypes['Ø´Ù‚Ø©'] = (patterns.propertyTypes['Ø´Ù‚Ø©'] || 0) + 1;
                if (text.includes('ÙÙŠÙ„Ø§')) patterns.propertyTypes['ÙÙŠÙ„Ø§'] = (patterns.propertyTypes['ÙÙŠÙ„Ø§'] || 0) + 1;
                if (text.includes('Ø£Ø±Ø¶')) patterns.propertyTypes['Ø£Ø±Ø¶'] = (patterns.propertyTypes['Ø£Ø±Ø¶'] || 0) + 1;
                if (text.includes('Ù…Ø­Ù„')) patterns.propertyTypes['Ù…Ø­Ù„'] = (patterns.propertyTypes['Ù…Ø­Ù„'] || 0) + 1;
                
                // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
                if (text.includes('Ø±ÙŠØ§Ø¶')) patterns.locations['Ø§Ù„Ø±ÙŠØ§Ø¶'] = (patterns.locations['Ø§Ù„Ø±ÙŠØ§Ø¶'] || 0) + 1;
                if (text.includes('Ø¬Ø¯Ø©')) patterns.locations['Ø¬Ø¯Ø©'] = (patterns.locations['Ø¬Ø¯Ø©'] || 0) + 1;
                if (text.includes('Ø¯Ù…Ø§Ù…')) patterns.locations['Ø§Ù„Ø¯Ù…Ø§Ù…'] = (patterns.locations['Ø§Ù„Ø¯Ù…Ø§Ù…'] || 0) + 1;
                if (text.includes('Ù…ÙƒØ©')) patterns.locations['Ù…ÙƒØ©'] = (patterns.locations['Ù…ÙƒØ©'] || 0) + 1;
                
                // Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø³Ø¹Ø§Ø± ÙˆÙ‡ÙˆØ§ØªÙ
                if (request.prices && request.prices.length > 0) patterns.totalWithPrices++;
                if (request.phones && request.phones.length > 0) patterns.totalWithPhones++;
            });

            displayPatternsAnalysis('Ø§Ù„Ø·Ù„Ø¨Ø§Øª', patterns, requests.length);
        }

        function analyzeOffersPatterns() {
            if (offers.length === 0) {
                showMessage('warning', 'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù„Ù„ØªØ­Ù„ÙŠÙ„');
                return;
            }

            showMessage('info', 'ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ø±ÙˆØ¶...');

            const patterns = {
                propertyTypes: {},
                priceRanges: {},
                locations: {},
                totalWithPrices: 0,
                totalWithPhones: 0
            };

            offers.forEach(offer => {
                const text = offer.text.toLowerCase();
                
                // ØªØ­Ù„ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
                if (text.includes('Ø´Ù‚Ø©')) patterns.propertyTypes['Ø´Ù‚Ø©'] = (patterns.propertyTypes['Ø´Ù‚Ø©'] || 0) + 1;
                if (text.includes('ÙÙŠÙ„Ø§')) patterns.propertyTypes['ÙÙŠÙ„Ø§'] = (patterns.propertyTypes['ÙÙŠÙ„Ø§'] || 0) + 1;
                if (text.includes('Ø£Ø±Ø¶')) patterns.propertyTypes['Ø£Ø±Ø¶'] = (patterns.propertyTypes['Ø£Ø±Ø¶'] || 0) + 1;
                if (text.includes('Ù…Ø­Ù„')) patterns.propertyTypes['Ù…Ø­Ù„'] = (patterns.propertyTypes['Ù…Ø­Ù„'] || 0) + 1;
                
                // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
                if (text.includes('Ø±ÙŠØ§Ø¶')) patterns.locations['Ø§Ù„Ø±ÙŠØ§Ø¶'] = (patterns.locations['Ø§Ù„Ø±ÙŠØ§Ø¶'] || 0) + 1;
                if (text.includes('Ø¬Ø¯Ø©')) patterns.locations['Ø¬Ø¯Ø©'] = (patterns.locations['Ø¬Ø¯Ø©'] || 0) + 1;
                if (text.includes('Ø¯Ù…Ø§Ù…')) patterns.locations['Ø§Ù„Ø¯Ù…Ø§Ù…'] = (patterns.locations['Ø§Ù„Ø¯Ù…Ø§Ù…'] || 0) + 1;
                if (text.includes('Ù…ÙƒØ©')) patterns.locations['Ù…ÙƒØ©'] = (patterns.locations['Ù…ÙƒØ©'] || 0) + 1;
                
                // Ø¹Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø³Ø¹Ø§Ø± ÙˆÙ‡ÙˆØ§ØªÙ
                if (offer.prices && offer.prices.length > 0) patterns.totalWithPrices++;
                if (offer.phones && offer.phones.length > 0) patterns.totalWithPhones++;
            });

            displayPatternsAnalysis('Ø§Ù„Ø¹Ø±ÙˆØ¶', patterns, offers.length);
        }

        function displayPatternsAnalysis(type, patterns, total) {
            const analysisDiv = document.getElementById('analysis-results');
            if (!analysisDiv) return;

            const analysisHTML = `
                <div class="analytics-card" style="margin-bottom: 20px;">
                    <h4>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø£Ù†Ù…Ø§Ø· ${type}</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="stat-item">
                            <div class="stat-number">${total}</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${type}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${patterns.totalWithPrices}</div>
                            <div class="stat-label">ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø³Ø¹Ø§Ø±</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${patterns.totalWithPhones}</div>
                            <div class="stat-label">ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‡ÙˆØ§ØªÙ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${Math.round((patterns.totalWithPrices / total) * 100)}%</div>
                            <div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h5>ğŸ  Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:</h5>
                            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                ${Object.entries(patterns.propertyTypes).map(([type, count]) => 
                                    `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span>${type}</span>
                                        <span style="font-weight: bold; color: var(--accent);">${count}</span>
                                    </div>`
                                ).join('') || '<div style="color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>'}
                            </div>
                        </div>
                        
                        <div>
                            <h5>ğŸ“ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹:</h5>
                            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                ${Object.entries(patterns.locations).map(([location, count]) => 
                                    `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span>${location}</span>
                                        <span style="font-weight: bold; color: var(--accent-2);">${count}</span>
                                    </div>`
                                ).join('') || '<div style="color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            analysisDiv.innerHTML = analysisHTML;
            switchTab('analysis');
            showMessage('success', `âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø£Ù†Ù…Ø§Ø· ${type}`);
        }

        // ===================== Data Management =====================
        
        function saveDataToStorage() {
            try {
                const data = {
                    requests: requests,
                    offers: offers,
                    timestamp: Date.now()
                };
                localStorage.setItem('smart_extracted_data', JSON.stringify(data));
                logToSearch('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©', 'success');
            } catch (error) {
                logToSearch(`âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
            }
        }

        function loadDataFromStorage() {
            try {
                const stored = localStorage.getItem('smart_extracted_data');
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data.requests) requests.push(...data.requests);
                    if (data.offers) offers.push(...data.offers);
                    
                    updateTabCounters();
                    updateSystemStats();
                    logToSearch(`ğŸ“š ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©`, 'success');
                }
            } catch (error) {
                logToSearch(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
            }
        }

        function refreshRequestsView() {
            displayRequests();
            showMessage('info', 'ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
        }

        function refreshOffersView() {
            displayOffers();
            showMessage('info', 'ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±ÙˆØ¶');
        }

        function refreshResultsView() {
            displayResults();
            showMessage('info', 'ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬');
        }
        async function saveToSystemDatabase(fileData) {
            try {
                // Simulate saving to IndexedDB or localStorage
                const savedFiles = JSON.parse(localStorage.getItem('smart_discovered_files') || '[]');
                savedFiles.push(fileData);
                localStorage.setItem('smart_discovered_files', JSON.stringify(savedFiles));
                
                logToSearch(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ ${fileData.name} ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`, 'success');
                return true;
            } catch (error) {
                logToSearch(`âŒ ÙØ´Ù„ Ø­ÙØ¸ ${fileData.name}: ${error.message}`, 'error');
                return false;
            }
        }

        async function loadFromSystemDatabase() {
            try {
                const savedFiles = JSON.parse(localStorage.getItem('smart_discovered_files') || '[]');
                
                if (savedFiles.length > 0) {
                    allTextFiles.push(...savedFiles);
                    
                    // Extract requests and offers from saved files
                    savedFiles.forEach(file => {
                        if (file.analysisData) {
                            if (file.analysisData.requests) {
                                requests.push(...file.analysisData.requests.map(req => ({
                                    text: req.text,
                                    source: file.name,
                                    phones: req.phones || [],
                                    prices: req.prices || []
                                })));
                            }
                            if (file.analysisData.offers) {
                                offers.push(...file.analysisData.offers.map(offer => ({
                                    text: offer.text,
                                    source: file.name,
                                    phones: offer.phones || [],
                                    prices: offer.prices || []
                                })));
                            }
                        }
                    });
                    
                    updateSystemStats();
                    logToSearch(`ğŸ“š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${savedFiles.length} Ù…Ù„Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`, 'success');
                }
            } catch (error) {
                logToSearch(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: ${error.message}`, 'error');
            }
        }

        function updateSystemStats() {
            document.getElementById('total-docs').textContent = allTextFiles.length;
            document.getElementById('request-count').textContent = requests.length;
            document.getElementById('offer-count').textContent = offers.length;
        }

        // ===================== Export and Backup Functions =====================
        function exportAnalysis(fileName) {
            const file = discoveredFiles.find(f => f.name === fileName);
            if (!file) return;

            const exportData = {
                fileName: file.name,
                filePath: file.path,
                analysisDate: new Date().toISOString(),
                fileSize: file.size,
                analysis: smartAnalyzer.analysisCache.get(`${file.path}_${file.lastModified}`)
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ØªØ­Ù„ÙŠÙ„_${fileName}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showMessage('success', `ğŸ“¤ ØªÙ… ØªØµØ¯ÙŠØ± ØªØ­Ù„ÙŠÙ„ ${fileName}`);
        }

        function exportDiscoveredData() {
            if (discoveredFiles.length === 0) {
                showMessage('warning', 'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØªØ´ÙØ© Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                systemInfo: {
                    totalFiles: discoveredFiles.length,
                    totalRequests: requests.length,
                    totalOffers: offers.length,
                    scanPaths: ANDROID_SEARCH_PATHS
                },
                discoveredFiles: discoveredFiles.map(file => ({
                    name: file.name,
                    path: file.path,
                    size: file.size,
                    type: file.type,
                    lastModified: file.lastModified,
                    analysisData: smartAnalyzer.analysisCache.get(`${file.path}_${file.lastModified}`)
                })),
                extractedRequests: requests,
                extractedOffers: offers
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ù…ÙƒØªØ´ÙØ©_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showMessage('success', `ğŸ“¦ ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©`);
        }

        // ===================== Performance Monitoring =====================
        class PerformanceMonitor {
            constructor() {
                this.metrics = {
                    filesScanned: 0,
                    scanTime: 0,
                    analysisTime: 0,
                    matchingTime: 0,
                    memoryUsage: 0
                };
            }

            startTimer(operation) {
                this[`${operation}StartTime`] = performance.now();
            }

            endTimer(operation) {
                const duration = performance.now() - this[`${operation}StartTime`];
                this.metrics[`${operation}Time`] = duration;
                logToSearch(`â±ï¸ ${operation}: ${Math.round(duration)}ms`, 'info');
            }

            updateFileCount(count) {
                this.metrics.filesScanned = count;
            }

            getReport() {
                return {
                    ...this.metrics,
                    memoryUsage: this.getMemoryUsage()
                };
            }

            getMemoryUsage() {
                if (performance.memory) {
                    return Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + ' MB';
                }
                return 'ØºÙŠØ± Ù…ØªØ§Ø­';
            }
        }

        const performanceMonitor = new PerformanceMonitor();

        // ===================== Advanced Settings Panel =====================
        function initializeDiscoverySettings() {
            const settingsContainer = document.getElementById('discovery-settings');
            if (!settingsContainer) return;

            settingsContainer.innerHTML = `
                <div class="analytics-card">
                    <h4>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h4>
                    
                    <div style="margin-bottom: 16px;">
                        <label>Ø¹Ù…Ù‚ Ø§Ù„Ø¨Ø­Ø«:</label>
                        <select id="search-depth">
                            <option value="1">Ø³Ø·Ø­ÙŠ (Ù…Ø¬Ù„Ø¯ ÙˆØ§Ø­Ø¯)</option>
                            <option value="3" selected>Ù…ØªÙˆØ³Ø· (3 Ù…Ø³ØªÙˆÙŠØ§Øª)</option>
                            <option value="5">Ø¹Ù…ÙŠÙ‚ (5 Ù…Ø³ØªÙˆÙŠØ§Øª)</option>
                            <option value="-1">Ø´Ø§Ù…Ù„ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª)</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label>Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª:</label>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;">
                            <label><input type="checkbox" checked> .txt</label>
                            <label><input type="checkbox" checked> .json</label>
                            <label><input type="checkbox"> .csv</label>
                            <label><input type="checkbox"> .log</label>
                            <label><input type="checkbox"> .md</label>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label>Ø­Ø¯ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù:</label>
                        <select id="file-size-limit">
                            <option value="1">1 MB</option>
                            <option value="5" selected>5 MB</option>
                            <option value="10">10 MB</option>
                            <option value="50">50 MB</option>
                            <option value="-1">Ø¨Ù„Ø§ Ø­Ø¯</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label><input type="checkbox" id="skip-hidden" checked> ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®ÙÙŠØ©</label>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label><input type="checkbox" id="auto-analyze" checked> ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§ÙƒØªØ´Ø§Ù</label>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn primary" onclick="applyAdvancedSettings()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                        <button class="btn" onclick="resetSettings()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                        <button class="btn success" onclick="exportDiscoveredData()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>

                    <div style="margin-top: 20px; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <h5>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</h5>
                        <div id="performance-stats"></div>
                    </div>
                </div>
            `;
        }

        function applyAdvancedSettings() {
            showMessage('info', 'âš™ï¸ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©...');
            
            const settings = {
                searchDepth: document.getElementById('search-depth')?.value || 3,
                fileSizeLimit: document.getElementById('file-size-limit')?.value || 5,
                skipHidden: document.getElementById('skip-hidden')?.checked || true,
                autoAnalyze: document.getElementById('auto-analyze')?.checked || true
            };

            localStorage.setItem('smart_search_settings', JSON.stringify(settings));
            logToSearch('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©', 'success');
            showMessage('success', 'âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        }

        function resetSettings() {
            localStorage.removeItem('smart_search_settings');
            initializeDiscoverySettings();
            showMessage('info', 'ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        }

        function updatePerformanceStats() {
            const statsContainer = document.getElementById('performance-stats');
            if (!statsContainer) return;

            const report = performanceMonitor.getReport();
            statsContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                    <div><strong>Ù…Ù„ÙØ§Øª Ù…ÙØ­ÙˆØµØ©:</strong> ${report.filesScanned}</div>
                    <div><strong>ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ø­:</strong> ${Math.round(report.scanTime)}ms</div>
                    <div><strong>ÙˆÙ‚Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„:</strong> ${Math.round(report.analysisTime)}ms</div>
                    <div><strong>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©:</strong> ${report.memoryUsage}</div>
                </div>
            `;
        }

        // ===================== Initialize Enhanced System =====================
        document.addEventListener('DOMContentLoaded', async () => {
            logToSearch('ğŸš€ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø·ÙˆØ± Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„', 'success');
            logToSearch('ğŸ“± Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯', 'info');
            logToSearch('ğŸ¤– AI Ù…Ø­Ù„Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙÙØ¹Ù„', 'success');
            
            // Initialize settings panel
            initializeDiscoverySettings();
            
            // Load saved data
            await loadFromSystemDatabase();
            await loadDataFromStorage();
            
            // Load saved matching results
            try {
                const savedResults = localStorage.getItem('smart_matching_results');
                if (savedResults) {
                    const resultsData = JSON.parse(savedResults);
                    if (resultsData.matches && Array.isArray(resultsData.matches)) {
                        allMatches = resultsData.matches;
                        logToSearch(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allMatches.length} Ù†ØªÙŠØ¬Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø­ÙÙˆØ¸Ø©`, 'success');
                    }
                }
            } catch (error) {
                logToSearch(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: ${error.message}`, 'error');
            }
            
            // Update all counters and displays
            updateTabCounters();
            updateSystemStats();
            
            // Update performance monitor
            setInterval(updatePerformanceStats, 5000);
            
            // Auto-refresh data every 30 seconds
            setInterval(() => {
                updateTabCounters();
                updateSystemStats();
            }, 30000);
            
            showMessage('success', 'ğŸ§  Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø·ÙˆØ± Ø¬Ø§Ù‡Ø²! Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ù„ÙØ§Øª');
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø§Ø¹Ø±Ø¶Ù‡Ø§
            if (requests.length > 0 || offers.length > 0) {
                showMessage('info', `ğŸ“š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©: ${requests.length} Ø·Ù„Ø¨ØŒ ${offers.length} Ø¹Ø±Ø¶`);
            }
        });

        // ===================== Enhanced Error Handling =====================
        window.addEventListener('error', (event) => {
            logToSearch(`ğŸ’¥ Ø®Ø·Ø£ Ù†Ø¸Ø§Ù…: ${event.error?.message || event.message}`, 'error');
            console.error('System error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            logToSearch(`ğŸ’¥ Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø­Ù…ÙŠ: ${event.reason}`, 'error');
            console.error('Unhandled rejection:', event.reason);
        });
    </script>
</body>

</html>