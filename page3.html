<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù†Ø¸Ø§Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± - Ù„Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ† Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠÙŠÙ†</title>
    <style>
        /* ===================== CSS Variables and Global Styles ===================== */
        :root {
            --bg: #0f172a;
            --card: #111827;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #22c55e;
            --accent-2: #3b82f6;
            --accent-3: #f59e0b;
            --accent-4: #8b5cf6;
            --btn-bg: #1f2937;
            --btn-hover: #374151;
            --shadow: 0 10px 25px rgba(0, 0, 0, .35);
            --radius: 18px;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", Arial, sans-serif;
            line-height: 1.6;
        }

        /* ===================== Layout and Card Styles ===================== */
        .wrap {
            min-height: 100vh;
            display: grid;
            place-items: center;
            padding: 24px;
        }

        .card {
            width: min(1400px, 96vw);
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .01));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: var(--radius);
            padding: 28px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(6px);
        }

        h1 {
            margin: 0 0 10px;
            font-size: clamp(26px, 3.5vw, 40px);
            letter-spacing: .2px;
        }

        p.lead {
            margin: 0 0 26px;
            color: var(--muted);
        }

        /* ===================== Tabs Navigation ===================== */
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            padding-bottom: 16px;
        }

        .tab-btn {
            padding: 12px 20px;
            background: var(--btn-bg);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            cursor: pointer;
            transition: all .2s ease;
            font-size: 14px;
        }

        .tab-btn:hover {
            background: var(--btn-hover);
        }

        .tab-btn.active {
            background: var(--accent-2);
            border-color: var(--accent-2);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===================== Buttons and Links ===================== */
        button.btn,
        a.btn {
            display: inline-block;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            background: var(--btn-bg);
            color: var(--text);
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .08);
            transition: transform .12s ease, background .12s ease, border-color .12s ease;
            box-shadow: 0 6px 14px rgba(0, 0, 0, .25);
            font-family: inherit;
            font-size: inherit;
            margin: 4px;
        }

        button.btn:hover,
        a.btn:hover {
            background: var(--btn-hover);
            transform: translateY(-1px);
        }

        button.btn.primary {
            background: var(--accent-2);
            border-color: transparent;
            color: #fff;
        }

        button.btn.success {
            background: var(--accent);
            border-color: transparent;
            color: #fff;
        }

        button.btn.warning {
            background: var(--warning);
            border-color: transparent;
            color: #fff;
        }

        button.btn.purple {
            background: var(--accent-4);
            border-color: transparent;
            color: #fff;
        }

        button.btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ===================== Sections and Status ===================== */
        .status-section,
        .controls-section,
        .results-section,
        .analytics-section,
        .crm-section {
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            text-align: center;
        }

        .stat-item .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-2);
        }

        .stat-item .stat-label {
            font-size: 12px;
            color: var(--muted);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 16px;
        }

        .analytics-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: 12px;
            padding: 16px;
        }

        .analytics-card h4 {
            margin: 0 0 12px;
            color: var(--accent-2);
        }

        /* ===================== Filter Controls ===================== */
        .filter-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            align-items: end;
        }

        .filter-item label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            color: var(--muted);
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 8px 12px;
            background: var(--btn-bg);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
        }

        /* ===================== CRM Features ===================== */
        .client-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .client-status {
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: bold;
        }

        .client-status.Ø¬Ø¯ÙŠØ¯ {
            background: var(--accent-2);
            color: white;
        }

        .client-status.Ù…ØªØ§Ø¨Ø¹ {
            background: var(--warning);
            color: white;
        }

        .client-status.Ù…Ù‡ØªÙ… {
            background: var(--accent);
            color: white;
        }

        .client-status.ØºÙŠØ±-Ù…Ù‡ØªÙ… {
            background: var(--danger);
            color: white;
        }

        /* ===================== Match Results Enhancement ===================== */
        #status-message {
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            display: none;
            margin-bottom: 16px;
        }

        #status-message.info {
            background: rgba(59, 130, 246, .1);
            color: var(--accent-2);
            border: 1px solid rgba(59, 130, 246, .2);
        }

        #status-message.success {
            background: rgba(34, 197, 94, .1);
            color: var(--accent);
            border: 1px solid rgba(34, 197, 94, .2);
        }

        #status-message.error {
            background: rgba(239, 68, 68, .1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, .2);
        }

        .loader {
            border: 4px solid var(--btn-bg);
            border-top: 4px solid var(--accent-2);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .matches-container {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        .match-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: var(--radius);
            padding: 20px;
            position: relative;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            padding-bottom: 12px;
        }

        .match-quality {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .match-quality.Ù…Ø¤ÙƒØ¯Ø© {
            background: #10b981;
            color: #fff;
        }

        .match-quality.Ù…Ø­ØªÙ…Ù„Ø© {
            background: #f59e0b;
            color: #fff;
        }

        .match-quality.Ù…Ù…ÙƒÙ†Ø© {
            background: #3b82f6;
            color: #fff;
        }

        .match-actions {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 8px;
            background: var(--btn-bg);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 6px;
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            transition: all .2s ease;
        }

        .action-btn:hover {
            background: var(--btn-hover);
        }

        .priority-badge {
            position: absolute;
            top: -8px;
            right: 16px;
            background: var(--danger);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        /* ===================== Analytics Visualizations ===================== */
        .chart-container {
            height: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            margin-top: 12px;
        }

        /* ===================== Responsive Design ===================== */
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            .tab-nav {
                flex-wrap: wrap;
            }
        }

        /* ===================== WhatsApp Integration ===================== */
        .whatsapp-btn {
            background: #25d366;
            border-color: #25d366;
            color: white;
        }

        .whatsapp-btn:hover {
            background: #128c7e;
        }

        /* ===================== Report Generation ===================== */
        .report-section {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .export-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h1><span style="font-size: 24px;">ğŸ </span> Ù†Ø¸Ø§Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ±</h1>
            <p class="lead">Ù†Ø¸Ø§Ù… Ø´Ø§Ù…Ù„ Ù„Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ† Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠÙŠÙ† - Ù…Ø·Ø§Ø¨Ù‚Ø© Ø°ÙƒÙŠØ©ØŒ Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù…Ù„Ø§Ø¡ØŒ ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©ØŒ ÙˆØ£Ø¯ÙˆØ§Øª ØªØ³ÙˆÙŠÙ‚ÙŠØ©</p>

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('matching')">ğŸ¤– Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</button>
                <button class="tab-btn" onclick="switchTab('crm')">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                <button class="tab-btn" onclick="switchTab('analytics')">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</button>
                <button class="tab-btn" onclick="switchTab('marketing')">ğŸ“¢ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚</button>
                <button class="tab-btn" onclick="switchTab('reports')">ğŸ“‹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            </div>

            <!-- Matching Tab (Original + Enhanced) -->
            <div id="matching-tab" class="tab-content active">
                <!-- Status Section -->
                <div class="status-section">
                    <h2>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                    <div id="status-message"></div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="total-docs">0</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="request-count">0</div>
                            <div class="stat-label">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="offer-count">0</div>
                            <div class="stat-label">Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="matches-count">0</div>
                            <div class="stat-label">Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Filter Section -->
                <div class="filter-section">
                    <h3>ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                    <div class="filter-grid">
                        <div class="filter-item">
                            <label>Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</label>
                            <select id="quality-filter">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</option>
                                <option value="Ù…Ø¤ÙƒØ¯Ø©">Ù…Ø¤ÙƒØ¯Ø©</option>
                                <option value="Ù…Ø­ØªÙ…Ù„Ø©">Ù…Ø­ØªÙ…Ù„Ø©</option>
                                <option value="Ù…Ù…ÙƒÙ†Ø©">Ù…Ù…ÙƒÙ†Ø©</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±</label>
                            <select id="property-type-filter">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                                <option value="Ø´Ù‚Ø©">Ø´Ù‚Ø©</option>
                                <option value="ÙÙŠÙ„Ø§">ÙÙŠÙ„Ø§</option>
                                <option value="Ø£Ø±Ø¶">Ø£Ø±Ø¶</option>
                                <option value="Ù…Ø­Ù„">Ù…Ø­Ù„ ØªØ¬Ø§Ø±ÙŠ</option>
                                <option value="Ù…ÙƒØªØ¨">Ù…ÙƒØªØ¨</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Ù…Ù†)</label>
                            <input type="number" id="price-min" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰">
                        </div>
                        <div class="filter-item">
                            <label>Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Ø¥Ù„Ù‰)</label>
                            <input type="number" id="price-max" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰">
                        </div>
                        <div class="filter-item">
                            <button class="btn primary" onclick="applyFilters()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©</button>
                        </div>
                    </div>
                </div>

                <!-- Controls Section -->
                <div class="controls-section" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                    <button class="btn success" id="start-matching-btn" onclick="runMatching()">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©</button>
                    <button class="btn" onclick="promptAndSaveApiKey()">ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ OpenAI</button>
                    <button class="btn" onclick="testApiKey()">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙØªØ§Ø­</button>
                    <button class="btn warning" onclick="generateMarketingMessages()">ğŸ“± Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ ØªØ³ÙˆÙŠÙ‚ÙŠØ©</button>
                    <button class="btn purple" onclick="prioritizeMatches()">â­ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</button>
                </div>

                <!-- Results Section -->
                <div class="results-section">
                    <h2>ğŸ’¡ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©</h2>
                    <div id="loader" class="loader"></div>
                    <div id="matches-container" class="matches-container"></div>
                    <p id="no-results" style="color: var(--muted); text-align: center; display: block;">Ù„Ù… ÙŠØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©" Ù„Ù„Ø¨Ø¯Ø¡.</p>
                </div>
            </div>

            <!-- CRM Tab -->
            <div id="crm-tab" class="tab-content">
                <div class="crm-section">
                    <h2>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="total-leads">0</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="hot-leads">0</div>
                            <div class="stat-label">Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù‡ØªÙ…ÙˆÙ†</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="follow-up-leads">0</div>
                            <div class="stat-label">ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="conversion-rate">0%</div>
                            <div class="stat-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙˆÙ† Ù…Ù† Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</h3>
                        <div id="clients-list"></div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>ğŸ“Š ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h4>ğŸ“ˆ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</h4>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-number" id="match-success-rate">0%</div>
                                    <div class="stat-label">Ù†Ø³Ø¨Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number" id="avg-response-time">0</div>
                                    <div class="stat-label">ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© (Ø«Ø§Ù†ÙŠØ©)</div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <span>Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</span>
                            </div>
                        </div>

                        <div class="analytics-card">
                            <h4>ğŸ  ØªØ­Ù„ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</h4>
                            <div id="property-types-analysis"></div>
                            <div class="chart-container">
                                <span>ØªÙˆØ²ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</span>
                            </div>
                        </div>

                        <div class="analytics-card">
                            <h4>ğŸ’° ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h4>
                            <div id="price-analysis"></div>
                            <div class="chart-container">
                                <span>Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</span>
                            </div>
                        </div>

                        <div class="analytics-card">
                            <h4>ğŸ“ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©</h4>
                            <div id="location-analysis"></div>
                            <div class="chart-container">
                                <span>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marketing Tab -->
            <div id="marketing-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>ğŸ“¢ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø°ÙƒÙŠØ©</h2>
                    
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h4>ğŸ“± Ø±Ø³Ø§Ø¦Ù„ WhatsApp Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h4>
                            <p>Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø®ØµØµØ© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†</p>
                            <button class="btn whatsapp-btn" onclick="generateWhatsAppMessages()">Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨</button>
                        </div>

                        <div class="analytics-card">
                            <h4>ğŸ“§ Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h4>
                            <p>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø§Øª ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ù…Ø³ØªÙ‡Ø¯ÙØ©</p>
                            <button class="btn primary" onclick="createEmailCampaign()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø¥ÙŠÙ…ÙŠÙ„</button>
                        </div>

                        <div class="analytics-card">
                            <h4>ğŸ“¸ Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„</h4>
                            <p>Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©</p>
                            <button class="btn purple" onclick="generateSocialPosts()">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±Ø§Øª</button>
                        </div>

                        <div class="analytics-card">
                            <h4>ğŸ¯ Ø§Ø³ØªÙ‡Ø¯Ø§Ù Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4>
                            <p>ØªØ­Ù„ÙŠÙ„ ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†</p>
                            <button class="btn warning" onclick="analyzeTargetCustomers()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                        </div>
                    </div>

                    <div id="marketing-content" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>ğŸ“‹ ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ø§Ù…Ù„Ø©</h2>
                    
                    <div class="report-section">
                        <h3>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                        <p>Ù…Ù„Ø®Øµ Ø´Ø§Ù…Ù„ Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                        <div class="export-options">
                            <button class="btn primary" onclick="generateDailyReport()">Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</button>
                            <button class="btn" onclick="exportToPDF()">ØªØµØ¯ÙŠØ± PDF</button>
                            <button class="btn" onclick="exportToExcel()">ØªØµØ¯ÙŠØ± Excel</button>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h3>
                        <p>ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù„Ù„Ø³ÙˆÙ‚ ÙˆØ§Ù„ÙØ±Øµ</p>
                        <div class="export-options">
                            <button class="btn success" onclick="generateWeeklyReport()">Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
                            <button class="btn" onclick="scheduleReport()">Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>ğŸ’¼ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                        <p>Ù‚Ø§Ø¦Ù…Ø© ØªÙØµÙŠÙ„ÙŠØ© Ø¨Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ­Ø§Ù„Ø© ÙƒÙ„ Ù…Ù†Ù‡Ù…</p>
                        <div class="export-options">
                            <button class="btn warning" onclick="generateClientReport()">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                            <button class="btn" onclick="emailReport()">Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</button>
                        </div>
                    </div>

                    <div id="report-content" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =================================================================================
        // ENHANCED SCRIPT WITH NEW FEATURES
        // =================================================================================

        // ===================== Original Code Base =====================
        const DB_NAME = 'FilesStorage';
        const DB_VERSION = 1;
        const STORE_NAME = 'files';
        let db;

        const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
        const OPENAI_MODEL = 'gpt-4o-mini';
        const API_KEY_STORAGE_KEY = 'OPENAI_API_KEY';

        let allTextFiles = [];
        let requests = [];
        let offers = [];
        let allMatches = [];
        let filteredMatches = [];
        let clientsDatabase = [];

        // ===================== Tab Management =====================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Load tab-specific data
            if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'crm') {
                updateCRMData();
            }
        }

        // ===================== Enhanced Initialization =====================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                showMessage('info', 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø². Ø§Ø¶Ø¨Ø· Ù…ÙØªØ§Ø­ OpenAI ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©.');
                await loadDataForMatching();
                await classifyAndSeparateFiles();
                loadClientsFromStorage();
            } catch (error) {
                console.error("Initialization failed:", error);
                showMessage('error', `âŒ Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ${error.message}`);
            }
        });

        // ===================== Original Core Functions (Keep as is) =====================
        function getApiKey() {
            return localStorage.getItem(API_KEY_STORAGE_KEY) || '';
        }

        function saveApiKey(key) {
            if (!key || !key.trim()) return false;
            localStorage.setItem(API_KEY_STORAGE_KEY, key.trim());
            return true;
        }

        function promptAndSaveApiKey() {
            const currentKey = getApiKey();
            const newKey = prompt('Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ OpenAI (ÙŠÙØ®Ø²Ù† Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ù…ØªØµÙØ­Ùƒ):', currentKey);
            if (newKey !== null) {
                if (saveApiKey(newKey)) {
                    showMessage('success', 'âœ… ØªÙ… Ø­ÙØ¸ Ù…ÙØªØ§Ø­ OpenAI Ù…Ø­Ù„ÙŠØ§Ù‹.');
                } else {
                    showMessage('error', 'âŒ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­. ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ ØºÙŠØ± ÙØ§Ø±Øº.');
                }
            }
        }

        async function ensureApiKeyOrFail() {
            const key = getApiKey();
            if (!key) {
                showMessage('error', 'âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ OpenAI. Ø§Ø¶ØºØ· "Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ OpenAI" Ù„Ø¥Ø¯Ø®Ø§Ù„Ù‡.');
                throw new Error('API key is missing');
            }
            return key;
        }

        async function testApiKey() {
            const startBtn = document.getElementById('start-matching-btn');
            const loader = document.getElementById('loader');
            try {
                const key = await ensureApiKeyOrFail();
                showMessage('info', 'ğŸ§ª Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙØªØ§Ø­...');
                startBtn.disabled = true;
                loader.style.display = 'block';

                const res = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: [{
                            role: 'system',
                            content: 'You are a JSON-only responder.'
                        }, {
                            role: 'user',
                            content: 'Return exactly this JSON: {"ok":true}'
                        }],
                        temperature: 0,
                        max_tokens: 50
                    })
                });

                if (!res.ok) {
                    const errorBody = await res.text();
                    console.error('OpenAI test error:', errorBody);
                    throw new Error(`ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                const content = data?.choices?.[0]?.message?.content ?? '';
                if (content.includes('"ok":true')) {
                    showMessage('success', 'âœ… Ø§Ù„Ù…ÙØªØ§Ø­ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.');
                } else {
                    showMessage('error', 'âš ï¸ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.');
                }
            } catch (error) {
                console.error("API Key test failed:", error);
                showMessage('error', `âŒ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙØªØ§Ø­ ÙØ´Ù„: ${error.message}`);
            } finally {
                startBtn.disabled = false;
                loader.style.display = 'none';
            }
        }

        function showMessage(type, message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = type;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (type !== 'error') {
                setTimeout(() => {
                    if (statusDiv.textContent === message) {
                        statusDiv.style.display = 'none';
                    }
                }, 5000);
            }
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, {
                            keyPath: 'id'
                        });
                        store.createIndex('name', 'name', {
                            unique: false
                        });
                        store.createIndex('uploadTime', 'uploadTime', {
                            unique: false
                        });
                    }
                };
            });
        }

        async function loadDataForMatching() {
            showMessage('info', 'ğŸ“‚ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            return new Promise((resolve, reject) => {
                if (!db) return reject("Database not initialized");
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    const allFiles = request.result;
                    console.log(`ğŸ“‹ Total files in DB: ${allFiles.length}`);

                    allTextFiles = allFiles.filter(file =>
                        (file.type && (file.type.includes('text') || file.type.includes('json'))) ||
                        (file.name && (file.name.endsWith('.txt') || file.name.endsWith('.json')))
                    );

                    console.log(`âœ… Filtered ${allTextFiles.length} text/json files.`);

                    if (allTextFiles.length === 0) {
                        showMessage('error', 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª Ù†ØµÙŠØ© Ø£Ùˆ JSON ØµØ§Ù„Ø­Ø© Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©.');
                        resolve();
                        return;
                    }

                    showMessage('success', `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allTextFiles.length} Ù…Ø³ØªÙ†Ø¯ Ø¨Ù†Ø¬Ø§Ø­.`);
                    document.getElementById('total-docs').textContent = allTextFiles.length;
                    resolve();
                };

                request.onerror = () => {
                    console.error('âŒ Error reading from DB:', request.error);
                    showMessage('error', 'âŒ ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                    reject(request.error);
                };
            });
        }

        function classifyMessageType(text) {
            if (!text) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const textLower = text.toLowerCase();
            const requestKeywords = ['Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ø¨Ø­Ø« Ø¹Ù†', 'Ø£Ø±ÙŠØ¯', 'Ù†Ø±ÙŠØ¯', 'Ù…Ø­ØªØ§Ø¬', 'Ø¨Ø­Ø« Ø¹Ù†', 'Ø¹Ø§ÙˆØ²', 'Ø¹Ø§ÙŠØ²', 'Ø§Ø¯ÙˆØ± Ø¹Ù„Ù‰', 'Ø£Ø¯ÙˆØ± Ø¹Ù„Ù‰', 'Ù†Ø¨Ø­Ø« Ø¹Ù†', 'wanted', 'looking for', 'need', 'require'];
            const offerKeywords = ['Ù„Ù„Ø¨ÙŠØ¹', 'Ù„Ù„Ø§ÙŠØ¬Ø§Ø±', 'Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±', 'Ù…Ø¹Ø±ÙˆØ¶', 'Ù…ØªÙˆÙØ±', 'ÙŠÙˆØ¬Ø¯', 'Ø¹Ù†Ø¯ÙŠ', 'Ù„Ø¯ÙŠ', 'Ù…ØªØ§Ø­', 'Ù„Ù„ØªÙ†Ø§Ø²Ù„', 'Ø£Ø¹Ø±Ø¶', 'for sale', 'for rent', 'available', 'offering'];

            const requestCount = requestKeywords.reduce((sum, keyword) => sum + (textLower.includes(keyword) ? 1 : 0), 0);
            const offerCount = offerKeywords.reduce((sum, keyword) => sum + (textLower.includes(keyword) ? 1 : 0), 0);

            if (requestCount > offerCount) return 'Ù…Ø·Ù„ÙˆØ¨';
            if (offerCount > requestCount) return 'Ù…Ø¹Ø±ÙˆØ¶';
            return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        async function classifyAndSeparateFiles() {
            showMessage('info', 'ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¥Ù„Ù‰ Ø·Ù„Ø¨Ø§Øª ÙˆØ¹Ø±ÙˆØ¶...');
            requests = [];
            offers = [];

            for (const file of allTextFiles) {
                try {
                    let textContent = '';
                    if (file.data && file.data.includes(',')) {
                        const base64 = file.data.split(',')[1];
                        if (base64) {
                            textContent = decodeURIComponent(escape(atob(base64)));
                        }
                    }
                    if (!textContent) continue;

                    if (file.name.toLowerCase().endsWith('.json')) {
                        const json = JSON.parse(textContent);
                        if (json.messages && Array.isArray(json.messages)) {
                            json.messages.forEach(message => {
                                const messageText = message.original_text || '';
                                if (messageText.trim()) {
                                    const type = classifyMessageType(messageText);
                                    if (type !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                                        const info = {
                                            text: messageText,
                                            source: file.name,
                                            phones: message.phones || [],
                                            prices: message.prices || []
                                        };
                                        if (type === 'Ù…Ø·Ù„ÙˆØ¨') requests.push(info);
                                        else if (type === 'Ù…Ø¹Ø±ÙˆØ¶') offers.push(info);
                                    }
                                }
                            });
                        }
                    } else {
                        const type = classifyMessageType(textContent);
                        if (type !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                            const info = {
                                text: textContent,
                                source: file.name
                            };
                            if (type === 'Ù…Ø·Ù„ÙˆØ¨') requests.push(info);
                            else if (type === 'Ù…Ø¹Ø±ÙˆØ¶') offers.push(info);
                        }
                    }
                } catch (e) {
                    console.error(`âŒ Failed to process file ${file.name}:`, e);
                }
            }

            document.getElementById('request-count').textContent = requests.length;
            document.getElementById('offer-count').textContent = offers.length;
            console.log(`ğŸ“Š Classification complete: ${requests.length} requests, ${offers.length} offers.`);
            showMessage('success', `âœ… ØªÙ… Ø§Ù„ØªØµÙ†ÙŠÙ: ${requests.length} Ø·Ù„Ø¨ØŒ ${offers.length} Ø¹Ø±Ø¶.`);
        }

        function createMatchingPrompt(requestsBatch, offersBatch) {
            let prompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ø¹Ù‚Ø§Ø±ÙŠ Ø°ÙƒÙŠ ÙˆÙ…Ø­Ù„Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„ØªÙ†Ù‚ÙŠØ¨ Ø¹Ù† Ø§Ù„ÙØ±Øµ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ØªØ­Ù„ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© "Ø§Ù„Ø·Ù„Ø¨Ø§Øª" ÙˆÙ‚Ø§Ø¦Ù…Ø© "Ø§Ù„Ø¹Ø±ÙˆØ¶" Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø¹Ù…Ù‚ØŒ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ù…ÙƒÙ†Ø©ØŒ Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ØªÙƒÙ† Ù…ØªØ·Ø§Ø¨Ù‚Ø© 100%.

### ÙÙ„Ø³ÙØ© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§):
- **ÙƒÙ† Ù…Ø±Ù†Ù‹Ø§**: Ø§ÙÙ‡Ù… Ø£Ù† Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙŠØ³ØªØ®Ø¯Ù…ÙˆÙ† ØªØ¹Ø§Ø¨ÙŠØ± Ù…Ø®ØªÙ„ÙØ©. "Ø¨ÙŠØª" Ù‚Ø¯ ÙŠØ¹Ù†ÙŠ "ÙÙŠÙ„Ø§"ØŒ Ùˆ "Ø£Ø±Ø¶ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©" Ù‚Ø¯ ØªÙ†Ø§Ø³Ø¨ Ø·Ù„Ø¨ "Ø£Ø±Ø¶ ØªØ¬Ø§Ø±ÙŠØ©".
- **Ø§Ù„Ø³Ø¹Ø± Ù„ÙŠØ³ Ù…Ø·Ù„Ù‚Ù‹Ø§**: Ø§Ø¹ØªØ¨Ø± Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø§Ø±Ø¨Ø© ÙØ±ØµØ© Ù…Ø­ØªÙ…Ù„Ø©. Ø·Ù„Ø¨ Ø¨Ù€ 500 Ø£Ù„Ù Ù‚Ø¯ ÙŠÙ†Ø§Ø³Ø¨Ù‡ Ø¹Ø±Ø¶ Ø¨Ù€ 550 Ø£Ù„Ù.
- **Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ**: Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ ØªØ·Ø§Ø¨Ù‚Ù‹Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­ÙŠØŒ Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ Ø§Ù„Ù…Ø¬Ø§ÙˆØ±Ø© ÙˆØ§Ù„Ù‚Ø±ÙŠØ¨Ø©.
- **Ø§Ù‚Ø±Ø£ Ù…Ø§ Ø¨ÙŠÙ† Ø§Ù„Ø³Ø·ÙˆØ±**: Ø­Ù„Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ù‚Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø¯Ù‚ÙŠÙ‚Ø© (Ù…Ø«Ù„ "Ù…ÙˆÙ‚Ø¹ Ù‡Ø§Ø¯Ø¦"ØŒ "Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø§Øª") ØªØ²ÙŠØ¯ Ù…Ù† Ù‚ÙˆØ© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©.

### Ù…Ø³ØªÙˆÙŠØ§Øª Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Quality Levels):
Ø¹Ù„ÙŠÙƒ ØªØµÙ†ÙŠÙ ÙƒÙ„ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¥Ù„Ù‰ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø«Ù„Ø§Ø«Ø© Ù…Ø³ØªÙˆÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¯Ù‰ Ù‚ÙˆØ© Ø§Ù„ÙØ±ØµØ©:
1.  **"Ù…Ø¤ÙƒØ¯Ø©"**: ØªØ·Ø§Ø¨Ù‚ Ø´Ø¨Ù‡ ÙƒØ§Ù…Ù„ ÙÙŠ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±ØŒ ÙˆØ§Ù„Ø­ÙŠØŒ ÙˆØ§Ù„Ø³Ø¹Ø± Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ø¶ÙŠÙ‚ Ø¬Ø¯Ù‹Ø§ (Â±5%). Ù‡Ø°Ù‡ ÙØ±ØµØ© Ù‚ÙˆÙŠØ© Ø¬Ø¯Ù‹Ø§.
2.  **"Ù…Ø­ØªÙ…Ù„Ø©"**: ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±ØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©) Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø§Ø®ØªÙ„Ø§Ù Ù…Ù‚Ø¨ÙˆÙ„ ÙÙŠ Ø§Ù„Ø³Ø¹Ø± (Â±15%) Ø£Ùˆ ÙÙŠ Ø­ÙŠ Ù…Ø¬Ø§ÙˆØ±. Ù‡Ø°Ù‡ ÙØ±ØµØ© Ø¬ÙŠØ¯Ø© ØªØ³ØªØ­Ù‚ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.
3.  **"Ù…Ù…ÙƒÙ†Ø©"**: ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø© (Ù…Ø«Ù„Ø§Ù‹ØŒ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±) Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø£ÙƒØ¨Ø± ÙÙŠ Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ù„ÙƒÙ† Ø³ÙŠØ§Ù‚ Ø§Ù„Ù†Øµ ÙŠÙˆØ­ÙŠ Ø¨ÙˆØ¬ÙˆØ¯ ÙØ±ØµØ© ÙƒØ§Ù…Ù†Ø©. (Ù…Ø«Ø§Ù„: Ø·Ù„Ø¨ "Ø£Ø±Ø¶ Ø³ÙƒÙ†ÙŠØ©" ÙˆØ¹Ø±Ø¶ "Ø£Ø±Ø¶ ØªØ¬Ø§Ø±ÙŠØ©" ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù‚Ø¯ ÙŠÙƒÙˆÙ† ÙØ±ØµØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´ØªØ±ÙŠ Ù…Ø³ØªØ«Ù…Ø±Ù‹Ø§).

### ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ (JSON ÙÙ‚Ø·):
Ø£Ø±Ø¬Ø¹ **Ù…ØµÙÙˆÙØ© JSON ÙÙ‚Ø·** Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ. ÙƒÙ„ Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ…Ø«Ù„ ØµÙÙ‚Ø© Ù…Ø­ØªÙ…Ù„Ø© Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªØ§Ù„ÙŠØ©:
{
  "quality": "Ù…Ø¤ÙƒØ¯Ø© Ø£Ùˆ Ù…Ø­ØªÙ…Ù„Ø© Ø£Ùˆ Ù…Ù…ÙƒÙ†Ø©",
  "property_type": "Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨/Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶",
  "area": "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ø­ÙŠ",
  "requested_price": "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø°ÙƒÙˆØ± ÙÙŠ Ø§Ù„Ø·Ù„Ø¨ (Ø¥Ù† ÙˆØ¬Ø¯)",
  "offered_price": "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø°ÙƒÙˆØ± ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ (Ø¥Ù† ÙˆØ¬Ø¯)",
  "requester_phone": "Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ø³ØªØ®Ø±Ø¬Ù‡ Ù…Ù† Ø§Ù„Ù†Øµ Ø¥Ù† Ø£Ù…ÙƒÙ†)",
  "offerer_phone": "Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ø§Ø±Ø¶ (Ø§Ø³ØªØ®Ø±Ø¬Ù‡ Ù…Ù† Ø§Ù„Ù†Øµ Ø¥Ù† Ø£Ù…ÙƒÙ†)",
  "reason": "Ø´Ø±Ø­ Ù…ÙØµÙ„ ÙˆØ°ÙƒÙŠ Ù„Ø³Ø¨Ø¨ Ø§Ø¹ØªØ¨Ø§Ø±Ù‡Ø§ ÙØ±ØµØ©. ÙˆØ¶Ø­ Ù†Ù‚Ø§Ø· Ø§Ù„ØªÙˆØ§ÙÙ‚ ÙˆØ§Ù„Ø§Ø®ØªÙ„Ø§Ù ÙˆÙ„Ù…Ø§Ø°Ø§ ØµÙ†ÙØªÙ‡Ø§ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰.",
  "request_text": "Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø·Ù„Ø¨",
  "offer_text": "Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¹Ø±Ø¶",
  "urgency_score": "Ø¯Ø±Ø¬Ø© Ù…Ù† 1-10 ØªØ´ÙŠØ± Ù„Ù…Ø¯Ù‰ Ø¥Ù„Ø­Ø§Ø­ Ù‡Ø°Ù‡ Ø§Ù„ÙØ±ØµØ©",
  "commission_potential": "ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ø¨Ø§Ù„Ø±ÙŠØ§Ù„"
}
Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ Ø£ÙŠ ÙØ±ØµØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ØŒ Ø£Ø±Ø¬Ø¹ Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ© [].

---
### Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ØªØ­Ù„ÙŠÙ„Ù‡Ø§:
`;
            requestsBatch.forEach((req, i) => {
                prompt += `\n--- Ø·Ù„Ø¨ ${i + 1} ---\n${req.text}\n`;
            });
            prompt += `\n---\n### Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù„Ù…Ø·Ø§Ø¨Ù‚ØªÙ‡Ø§: \n`;
            offersBatch.forEach((off, i) => {
                prompt += `\n--- Ø¹Ø±Ø¶ ${i + 1} ---\n${off.text}\n`;
            });
            prompt += `\n---\nØ§Ù„Ø¢Ù†ØŒ Ù‚Ù… Ø¨Ø§Ù„ØªÙ†Ù‚ÙŠØ¨ Ø¹Ù† Ø§Ù„ÙØ±Øµ ÙˆØ£Ø¹Ø¯ Ù…ØµÙÙˆÙØ© JSON ÙÙ‚Ø·.`;
            return prompt;
        }

        async function callOpenAI(prompt) {
            const key = await ensureApiKeyOrFail();
            console.log(`\nğŸ¤– Calling OpenAI with prompt length: ${prompt.length}`);
            showMessage('info', 'â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ OpenAI... Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª.');

            try {
                const res = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        temperature: 0.3,
                        max_tokens: 4000,
                        messages: [{
                            role: 'system',
                            content: 'Ø£Ø¹Ø¯ Ø§Ø³ØªØ¬Ø§Ø¨Ø© JSON ÙÙ‚Ø· ÙˆØ¨Ø¯ÙˆÙ† Ø£ÙŠ Ù…Ù‚Ø¯Ù…Ø© Ø£Ùˆ Ø´Ø±Ø­.'
                        }, {
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!res.ok) {
                    const errorBody = await res.text();
                    console.error("âŒ OpenAI Error:", {
                        status: res.status,
                        body: errorBody
                    });
                    if (res.status === 401) throw new Error('Ù…ÙØªØ§Ø­ OpenAI ØºÙŠØ± ØµØ­ÙŠØ­.');
                    if (res.status === 429) throw new Error('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø¹Ø¯Ù„/Ø§Ù„ÙƒÙˆØªØ§ (Rate Limit).');
                    throw new Error(`Ø®Ø·Ø£ Ù…Ù† OpenAI: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                let content = data?.choices?.[0]?.message?.content || '[]';
                console.log(`ğŸ“ OpenAI raw response:`, content);

                content = content.replace(/```json|```/g, '').trim();
                return JSON.parse(content);

            } catch (error) {
                console.error('âŒ Error during OpenAI call or parsing:', error);
                showMessage('error', `âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† OpenAI: ${error.message}`);
                return null;
            }
        }

        // ===================== Enhanced Display Functions =====================
        function displayMatches(matches) {
            const container = document.getElementById('matches-container');
            const noResultsP = document.getElementById('no-results');
            container.innerHTML = '';

            if (!matches || matches.length === 0) {
                noResultsP.textContent = 'âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„. Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù‚ÙˆÙŠØ©.';
                noResultsP.style.display = 'block';
                return;
            }

            noResultsP.style.display = 'none';
            allMatches = matches;
            filteredMatches = matches;

            document.getElementById('matches-count').textContent = matches.length;

            matches.forEach((match, index) => {
                const card = document.createElement('div');
                card.className = 'match-card';
                card.setAttribute('data-index', index);
                
                // Add priority badge for high urgency
                const priorityBadge = match.urgency_score >= 8 ? '<div class="priority-badge">Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©</div>' : '';
                
                card.innerHTML = `
                    ${priorityBadge}
                    <div class="match-actions">
                        <button class="action-btn" onclick="addToClients('${index}')" title="Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡">ğŸ‘¥</button>
                        <button class="action-btn whatsapp-btn" onclick="sendWhatsApp('${match.requester_phone || match.offerer_phone}')" title="ÙˆØ§ØªØ³Ø§Ø¨">ğŸ“±</button>
                        <button class="action-btn" onclick="markAsContacted('${index}')" title="ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„">âœ…</button>
                    </div>
                    <div class="match-header">
                        <h3>Ù…Ø·Ø§Ø¨Ù‚Ø© ${match.property_type || 'Ø¹Ù‚Ø§Ø±ÙŠØ©'}</h3>
                        <span class="match-quality ${match.quality || ''}">${match.quality || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                    <div class="match-details">
                        <div class="detail-item"><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${match.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div class="detail-item"><strong>Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨:</strong> ${match.requested_price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div class="detail-item"><strong>Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶:</strong> ${match.offered_price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div class="detail-item"><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> ${match.requester_phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</div>
                        <div class="detail-item"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ø±Ø¶:</strong> ${match.offerer_phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</div>
                        <div class="detail-item"><strong>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¥Ù„Ø­Ø§Ø­:</strong> ${match.urgency_score || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}/10</div>
                        <div class="detail-item"><strong>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©:</strong> ${match.commission_potential || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                    </div>
                    <div class="match-reason"><strong>ğŸ’¡ Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:</strong> ${match.reason || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¨Ø¨ Ù…Ø­Ø¯Ø¯.'}</div>
                    <div class="match-texts">
                        <div class="text-box"><h4>ğŸ“ Ù†Øµ Ø§Ù„Ø·Ù„Ø¨</h4><p>${match.request_text || ''}</p></div>
                        <div class="text-box"><h4>ğŸ  Ù†Øµ Ø§Ù„Ø¹Ø±Ø¶</h4><p>${match.offer_text || ''}</p></div>
                    </div>`;
                container.appendChild(card);
            });

            // Auto-extract potential clients
            extractPotentialClients(matches);
        }

        // ===================== New Enhanced Features =====================

        // Filter functionality
        function applyFilters() {
            const qualityFilter = document.getElementById('quality-filter').value;
            const propertyTypeFilter = document.getElementById('property-type-filter').value;
            const priceMin = document.getElementById('price-min').value;
            const priceMax = document.getElementById('price-max').value;

            filteredMatches = allMatches.filter(match => {
                if (qualityFilter && match.quality !== qualityFilter) return false;
                if (propertyTypeFilter && !match.property_type?.includes(propertyTypeFilter)) return false;
                
                if (priceMin || priceMax) {
                    const price = extractPriceFromString(match.offered_price || match.requested_price || '0');
                    if (priceMin && price < parseInt(priceMin)) return false;
                    if (priceMax && price > parseInt(priceMax)) return false;
                }
                
                return true;
            });

            displayMatches(filteredMatches);
            showMessage('success', `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©. ${filteredMatches.length} Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ù† Ø£ØµÙ„ ${allMatches.length}`);
        }

        function extractPriceFromString(str) {
            const numbers = str.match(/\d+/g);
            return numbers ? parseInt(numbers.join('')) : 0;
        }

        // Priority sorting
        function prioritizeMatches() {
            if (!allMatches.length) {
                showMessage('error', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù„Ù„ØªØ±ØªÙŠØ¨');
                return;
            }

            const prioritized = [...allMatches].sort((a, b) => {
                // Sort by urgency score first, then by quality
                const urgencyDiff = (b.urgency_score || 0) - (a.urgency_score || 0);
                if (urgencyDiff !== 0) return urgencyDiff;

                const qualityOrder = { 'Ù…Ø¤ÙƒØ¯Ø©': 3, 'Ù…Ø­ØªÙ…Ù„Ø©': 2, 'Ù…Ù…ÙƒÙ†Ø©': 1 };
                return (qualityOrder[b.quality] || 0) - (qualityOrder[a.quality] || 0);
            });

            displayMatches(prioritized);
            showMessage('success', 'ØªÙ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© ÙˆØ§Ù„Ø¥Ù„Ø­Ø§Ø­');
        }

        // CRM Features
        function extractPotentialClients(matches) {
            matches.forEach((match, index) => {
                // Extract requester
                if (match.requester_phone) {
                    addClientIfNotExists({
                        id: 'req_' + index,
                        name: 'Ø¹Ù…ÙŠÙ„ Ù…Ø­ØªÙ…Ù„ - Ø·Ø§Ù„Ø¨',
                        phone: match.requester_phone,
                        type: 'Ø·Ø§Ù„Ø¨',
                        interest: match.property_type,
                        budget: match.requested_price,
                        status: 'Ø¬Ø¯ÙŠØ¯',
                        urgency: match.urgency_score || 5,
                        source: 'Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©',
                        lastContact: null,
                        notes: match.request_text
                    });
                }

                // Extract offerer
                if (match.offerer_phone) {
                    addClientIfNotExists({
                        id: 'off_' + index,
                        name: 'Ø¹Ù…ÙŠÙ„ Ù…Ø­ØªÙ…Ù„ - Ø¹Ø§Ø±Ø¶',
                        phone: match.offerer_phone,
                        type: 'Ø¹Ø§Ø±Ø¶',
                        interest: match.property_type,
                        budget: match.offered_price,
                        status: 'Ø¬Ø¯ÙŠØ¯',
                        urgency: match.urgency_score || 5,
                        source: 'Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©',
                        lastContact: null,
                        notes: match.offer_text
                    });
                }
            });

            saveClientsToStorage();
            updateCRMData();
        }

        function addClientIfNotExists(client) {
            const exists = clientsDatabase.some(c => c.phone === client.phone);
            if (!exists) {
                clientsDatabase.push(client);
            }
        }

        function addToClients(matchIndex) {
            const match = allMatches[matchIndex];
            const clientName = prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:', 'Ø¹Ù…ÙŠÙ„ Ù…Ø­ØªÙ…Ù„');
            if (!clientName) return;

            const client = {
                id: Date.now().toString(),
                name: clientName,
                phone: match.requester_phone || match.offerer_phone || '',
                type: match.requester_phone ? 'Ø·Ø§Ù„Ø¨' : 'Ø¹Ø§Ø±Ø¶',
                interest: match.property_type,
                budget: match.requested_price || match.offered_price,
                status: 'Ø¬Ø¯ÙŠØ¯',
                urgency: match.urgency_score || 5,
                source: 'Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ©',
                lastContact: new Date().toISOString(),
                notes: `Ù…Ù† Ù…Ø·Ø§Ø¨Ù‚Ø©: ${match.reason}`
            };

            clientsDatabase.push(client);
            saveClientsToStorage();
            updateCRMData();
            showMessage('success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        }

        function markAsContacted(matchIndex) {
            const card = document.querySelector(`[data-index="${matchIndex}"]`);
            if (card) {
                card.style.opacity = '0.7';
                card.style.border = '2px solid var(--accent)';
                showMessage('success', 'ØªÙ… ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© "ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„"');
            }
        }

        function sendWhatsApp(phone) {
            if (!phone) {
                showMessage('error', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ØªÙˆÙØ±');
                return;
            }
            const message = encodeURIComponent('Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø§ Ù…Ø³ÙˆÙ‚ Ø¹Ù‚Ø§Ø±ÙŠ ÙˆÙ„Ø¯ÙŠ Ø¹Ø±Ø¶ Ù‚Ø¯ ÙŠÙ‡Ù…Ùƒ...');
            window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
        }

        // Storage functions
        function saveClientsToStorage() {
            localStorage.setItem('real_estate_clients', JSON.stringify(clientsDatabase));
        }

        function loadClientsFromStorage() {
            const stored = localStorage.getItem('real_estate_clients');
            if (stored) {
                clientsDatabase = JSON.parse(stored);
            }
        }

        function updateCRMData() {
            const totalLeads = clientsDatabase.length;
            const hotLeads = clientsDatabase.filter(c => c.urgency >= 8).length;
            const followUpLeads = clientsDatabase.filter(c => c.status === 'Ù…ØªØ§Ø¨Ø¹').length;
            const conversionRate = totalLeads > 0 ? Math.round((hotLeads / totalLeads) * 100) : 0;

            document.getElementById('total-leads').textContent = totalLeads;
            document.getElementById('hot-leads').textContent = hotLeads;
            document.getElementById('follow-up-leads').textContent = followUpLeads;
            document.getElementById('conversion-rate').textContent = conversionRate + '%';

            displayClientsList();
        }

        function displayClientsList() {
            const container = document.getElementById('clients-list');
            if (!container) return;

            container.innerHTML = '';

            if (clientsDatabase.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø­ØªÙ…Ù„ÙˆÙ† Ø¨Ø¹Ø¯</p>';
                return;
            }

            clientsDatabase.forEach(client => {
                const card = document.createElement('div');
                card.className = 'client-card';
                card.innerHTML = `
                    <div class="client-header">
                        <h4>${client.name}</h4>
                        <span class="client-status ${client.status}">${client.status}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px;">
                        <div><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${client.phone}</div>
                        <div><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${client.type}</div>
                        <div><strong>Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…:</strong> ${client.interest || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div><strong>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:</strong> ${client.budget || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div><strong>Ø§Ù„Ø¥Ù„Ø­Ø§Ø­:</strong> ${client.urgency}/10</div>
                        <div><strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> ${client.source}</div>
                    </div>
                    <div style="margin-top: 12px;">
                        <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${client.notes ? client.notes.substring(0, 100) + '...' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button class="action-btn whatsapp-btn" onclick="sendWhatsApp('${client.phone}')">ÙˆØ§ØªØ³Ø§Ø¨</button>
                        <button class="action-btn" onclick="updateClientStatus('${client.id}')">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
                        <button class="action-btn" onclick="addClientNote('${client.id}')">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateClientStatus(clientId) {
            const client = clientsDatabase.find(c => c.id === clientId);
            if (!client) return;

            const newStatus = prompt('Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', client.status);
            if (newStatus) {
                client.status = newStatus;
                client.lastContact = new Date().toISOString();
                saveClientsToStorage();
                updateCRMData();
                showMessage('success', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„');
            }
        }

        function addClientNote(clientId) {
            const client = clientsDatabase.find(c => c.id === clientId);
            if (!client) return;

            const note = prompt('Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©:', '');
            if (note) {
                client.notes = (client.notes || '') + '\n' + new Date().toLocaleString() + ': ' + note;
                saveClientsToStorage();
                updateCRMData();
                showMessage('success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
            }
        }

        // Analytics Functions
        function updateAnalytics() {
            if (!allMatches.length) return;

            // Calculate success rate
            const totalMatches = allMatches.length;
            const highQualityMatches = allMatches.filter(m => m.quality === 'Ù…Ø¤ÙƒØ¯Ø©').length;
            const successRate = Math.round((highQualityMatches / totalMatches) * 100);
            document.getElementById('match-success-rate').textContent = successRate + '%';

            // Calculate average response time (simulated)
            document.getElementById('avg-response-time').textContent = '2.3';

            // Property types analysis
            const propertyTypes = {};
            allMatches.forEach(match => {
                const type = match.property_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                propertyTypes[type] = (propertyTypes[type] || 0) + 1;
            });

            const propertyAnalysisDiv = document.getElementById('property-types-analysis');
            propertyAnalysisDiv.innerHTML = Object.entries(propertyTypes)
                .map(([type, count]) => `<div><strong>${type}:</strong> ${count} Ù…Ø·Ø§Ø¨Ù‚Ø©</div>`)
                .join('');

            // Price analysis
            const prices = allMatches
                .map(m => extractPriceFromString(m.offered_price || m.requested_price || '0'))
                .filter(p => p > 0);

            if (prices.length > 0) {
                const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);

                const priceAnalysisDiv = document.getElementById('price-analysis');
                priceAnalysisDiv.innerHTML = `
                    <div><strong>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±:</strong> ${avgPrice.toLocaleString()} Ø±ÙŠØ§Ù„</div>
                    <div><strong>Ø£Ù‚Ù„ Ø³Ø¹Ø±:</strong> ${minPrice.toLocaleString()} Ø±ÙŠØ§Ù„</div>
                    <div><strong>Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±:</strong> ${maxPrice.toLocaleString()} Ø±ÙŠØ§Ù„</div>
                `;
            }

            // Location analysis
            const locations = {};
            allMatches.forEach(match => {
                const area = match.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                locations[area] = (locations[area] || 0) + 1;
            });

            const locationAnalysisDiv = document.getElementById('location-analysis');
            locationAnalysisDiv.innerHTML = Object.entries(locations)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([area, count]) => `<div><strong>${area}:</strong> ${count} Ù†Ø´Ø§Ø·</div>`)
                .join('');
        }

        // Marketing Functions
        async function generateMarketingMessages() {
            if (!allMatches.length) {
                showMessage('error', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ ØªØ³ÙˆÙŠÙ‚ÙŠØ©');
                return;
            }

            showMessage('info', 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ù…Ø®ØµØµØ©...');

            const topMatches = allMatches
                .filter(m => m.quality === 'Ù…Ø¤ÙƒØ¯Ø©' || m.quality === 'Ù…Ø­ØªÙ…Ù„Ø©')
                .slice(0, 5);

            const marketingPrompt = `Ø£Ù†Ø´Ø¦ Ø±Ø³Ø§Ø¦Ù„ ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙˆÙ…Ù‚Ù†Ø¹Ø© Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©. ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ†:
- Ù…Ø®ØµØµØ© Ù„Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„
- Ù…Ù‚Ù†Ø¹Ø© ÙˆÙ…Ø­ÙØ²Ø© Ù„Ù„Ø¹Ù…Ù„
- ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¯Ø¹ÙˆØ© ÙˆØ§Ø¶Ø­Ø© Ù„Ù„Ø¹Ù…Ù„
- Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©

Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª:
${topMatches.map((match, i) => `
Ù…Ø·Ø§Ø¨Ù‚Ø© ${i + 1}:
- Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±: ${match.property_type}
- Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${match.area}
- Ø§Ù„Ø³Ø¹Ø±: ${match.offered_price || match.requested_price}
- Ø§Ù„Ø¬ÙˆØ¯Ø©: ${match.quality}
`).join('\n')}

Ø£Ø±Ø¬Ø¹ JSON Ù…Ø¹ Ø±Ø³Ø§Ø¦Ù„ ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ù…Ø®ØµØµØ© Ù„ÙƒÙ„ Ù…Ø·Ø§Ø¨Ù‚Ø©.`;

            try {
                const messages = await callOpenAI(marketingPrompt);
                displayMarketingContent(messages, 'Ø±Ø³Ø§Ø¦Ù„ ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ù…Ø®ØµØµØ©');
            } catch (error) {
                showMessage('error', 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©');
            }
        }

        async function generateWhatsAppMessages() {
            showMessage('info', 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨...');

            const whatsappPrompt = `Ø£Ù†Ø´Ø¦ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ù‚ØµÙŠØ±Ø© ÙˆÙ…Ø¤Ø«Ø±Ø© Ù„Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ† Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠÙŠÙ†. Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ†:
- Ù‚ØµÙŠØ±Ø© (50-100 ÙƒÙ„Ù…Ø©)
- ÙˆØ¯ÙˆØ¯Ø© ÙˆÙ…Ù‡Ù†ÙŠØ©
- ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ù…Ø¶Ø§ÙØ©
- Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø«Ù‚Ø§ÙØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©

Ø£Ù†Ø´Ø¦ 5 Ø±Ø³Ø§Ø¦Ù„ Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:
1. Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ù‰ Ù„Ù„ØªØ¹Ø§Ø±Ù
2. Ø±Ø³Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¹Ù‚Ø§Ø±
3. Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ Ø¹Ù‚Ø§Ø±
4. Ø±Ø³Ø§Ù„Ø© Ù…ØªØ§Ø¨Ø¹Ø©
5. Ø±Ø³Ø§Ù„Ø© Ø´ÙƒØ± ÙˆØ¥ØºÙ„Ø§Ù‚ ØµÙÙ‚Ø©

Ø£Ø±Ø¬Ø¹ JSON Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.`;

            try {
                const messages = await callOpenAI(whatsappPrompt);
                displayMarketingContent(messages, 'Ù‚ÙˆØ§Ù„Ø¨ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨');
            } catch (error) {
                showMessage('error', 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨');
            }
        }

        async function generateSocialPosts() {
            showMessage('info', 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„...');

            const socialPrompt = `Ø£Ù†Ø´Ø¦ Ù…Ù†Ø´ÙˆØ±Ø§Øª ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ù„Ù„Ù…Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ. ÙƒÙ„ Ù…Ù†Ø´ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†:
- Ø¬Ø°Ø§Ø¨ ÙˆÙ…Ø­ÙØ²
- ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‡Ø§Ø´ØªØ§Ù‚Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø©
- Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ
- ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¯Ø¹ÙˆØ© Ù„Ù„Ø¹Ù…Ù„

Ø£Ù†Ø´Ø¦ 5 Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…Ø®ØªÙ„ÙØ©:
1. Ù…Ù†Ø´ÙˆØ± ØªØ¹Ø±ÙŠÙ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø§Øª
2. Ù…Ù†Ø´ÙˆØ± Ø¹Ø±Ø¶ Ø¹Ù‚Ø§Ø± Ù…Ù…ÙŠØ²
3. Ù…Ù†Ø´ÙˆØ± Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ†
4. Ù…Ù†Ø´ÙˆØ± Ø´Ù‡Ø§Ø¯Ø© Ø¹Ù…ÙŠÙ„
5. Ù…Ù†Ø´ÙˆØ± Ø¯Ø¹ÙˆØ© Ù„Ù„ØªÙˆØ§ØµÙ„

Ø£Ø±Ø¬Ø¹ JSON Ù…Ø¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙˆØ§Ù„Ù‡Ø§Ø´ØªØ§Ù‚Ø§Øª.`;

            try {
                const posts = await callOpenAI(socialPrompt);
                displayMarketingContent(posts, 'Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„');
            } catch (error) {
                showMessage('error', 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª');
            }
        }

        async function createEmailCampaign() {
            showMessage('info', 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø¥ÙŠÙ…ÙŠÙ„...');

            const emailPrompt = `Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ù…Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ ØªØªÙƒÙˆÙ† Ù…Ù†:
1. Ø®Ø· Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø¬Ø°Ø§Ø¨
2. Ù†Øµ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
3. Ø¯Ø¹ÙˆØ© Ù„Ù„Ø¹Ù…Ù„
4. ØªÙˆÙ‚ÙŠØ¹ Ø§Ø­ØªØ±Ø§ÙÙŠ

Ø§Ù„Ø­Ù…Ù„Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ†:
- Ù…Ù‡Ù†ÙŠØ© ÙˆÙ…ÙˆØ«ÙˆÙ‚Ø©
- ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ù…Ø¶Ø§ÙØ©
- Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠÙŠÙ†
- ØªØ­ÙØ² Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§Ø¹Ù„

Ø£Ø±Ø¬Ø¹ JSON Ù…Ø¹ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø©.`;

            try {
                const campaign = await callOpenAI(emailPrompt);
                displayMarketingContent(campaign, 'Ø­Ù…Ù„Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
            } catch (error) {
                showMessage('error', 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„');
            }
        }

        async function analyzeTargetCustomers() {
            if (!clientsDatabase.length) {
                showMessage('error', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„ØªØ­Ù„ÙŠÙ„');
                return;
            }

            showMessage('info', 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙŠÙ†...');

            const analysisPrompt = `Ø­Ù„Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠØ© ÙˆÙ‚Ø¯Ù… Ø±Ø¤Ù‰ ØªØ³ÙˆÙŠÙ‚ÙŠØ©:

Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:
${clientsDatabase.map(client => `
- Ø§Ù„Ù†ÙˆØ¹: ${client.type}
- Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…: ${client.interest}
- Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${client.budget}
- Ø§Ù„Ø¥Ù„Ø­Ø§Ø­: ${client.urgency}/10
`).join('\n')}

Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ ÙŠØ´Ù…Ù„:
1. ØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
2. Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚
3. ØªÙˆØµÙŠØ§Øª Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
4. ÙØ±Øµ Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…

Ø£Ø±Ø¬Ø¹ JSON Ù…Ø¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª.`;

            try {
                const analysis = await callOpenAI(analysisPrompt);
                displayMarketingContent(analysis, 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙŠÙ†');
            } catch (error) {
                showMessage('error', 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡');
            }
        }

        function displayMarketingContent(content, title) {
            const container = document.getElementById('marketing-content');
            if (!container) return;

            container.innerHTML = `
                <div class="analytics-card">
                    <h3>${title}</h3>
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
                        ${typeof content === 'string' ? content : JSON.stringify(content, null, 2)}
                    </div>
                    <button class="btn primary" onclick="copyToClipboard('${encodeURIComponent(JSON.stringify(content))}')">Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰</button>
                </div>
            `;
        }

        function copyToClipboard(encodedContent) {
            const content = JSON.parse(decodeURIComponent(encodedContent));
            navigator.clipboard.writeText(typeof content === 'string' ? content : JSON.stringify(content, null, 2));
            showMessage('success', 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰');
        }

        // Report Functions
        async function generateDailyReport() {
            showMessage('info', 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ...');

            const reportData = {
                date: new Date().toLocaleDateString('ar-SA'),
                totalMatches: allMatches.length,
                qualityBreakdown: {
                    confirmed: allMatches.filter(m => m.quality === 'Ù…Ø¤ÙƒØ¯Ø©').length,
                    potential: allMatches.filter(m => m.quality === 'Ù…Ø­ØªÙ…Ù„Ø©').length,
                    possible: allMatches.filter(m => m.quality === 'Ù…Ù…ÙƒÙ†Ø©').length
                },
                totalClients: clientsDatabase.length,
                hotLeads: clientsDatabase.filter(c => c.urgency >= 8).length,
                revenue: allMatches.reduce((sum, match) => {
                    const commission = extractPriceFromString(match.commission_potential || '0');
                    return sum + commission;
                }, 0)
            };

            const reportPrompt = `Ø£Ù†Ø´Ø¦ ØªÙ‚Ø±ÙŠØ±Ø§Ù‹ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø§Ø­ØªØ±Ø§ÙÙŠØ§Ù‹ Ù„Ù„Ù…Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙŠØªØ¶Ù…Ù†:

Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:
${JSON.stringify(reportData, null, 2)}

Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ´Ù…Ù„:
1. Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ
2. Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
3. Ø£Ù‡Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª
4. Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
5. Ø§Ù„ØªÙˆØµÙŠØ§Øª Ù„Ù„ØºØ¯
6. Ø§Ù„ÙØ±Øµ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©

Ø§Ø¬Ø¹Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù‡Ù†ÙŠØ§Ù‹ ÙˆÙ…ÙØµÙ„Ø§Ù‹ ÙˆÙ‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.`;

            try {
                const report = await callOpenAI(reportPrompt);
                displayReportContent(report, 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ');
            } catch (error) {
                showMessage('error', 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
            }
        }

        async function generateWeeklyReport() {
            showMessage('info', 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ...');
            // Similar implementation for weekly report
            const report = "ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù…ÙØµÙ„ (ÙŠØªØ·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ø±ÙŠØ®ÙŠØ©)";
            displayReportContent(report, 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ');
        }

        async function generateClientReport() {
            const clientsReport = `
# ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†

## Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${clientsDatabase.length}

${clientsDatabase.map(client => `
### ${client.name}
- **Ø§Ù„Ù‡Ø§ØªÙ:** ${client.phone}
- **Ø§Ù„Ù†ÙˆØ¹:** ${client.type}
- **Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…:** ${client.interest || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
- **Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:** ${client.budget || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
- **Ø§Ù„Ø­Ø§Ù„Ø©:** ${client.status}
- **Ø§Ù„Ø¥Ù„Ø­Ø§Ø­:** ${client.urgency}/10
- **Ø§Ù„Ù…ØµØ¯Ø±:** ${client.source}
- **Ø¢Ø®Ø± ØªÙˆØ§ØµÙ„:** ${client.lastContact || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„'}
- **Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:** ${client.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}

---
`).join('')}
            `;

            displayReportContent(clientsReport, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡');
        }

        function displayReportContent(content, title) {
            const container = document.getElementById('report-content');
            if (!container) return;

            container.innerHTML = `
                <div class="analytics-card">
                    <h3>${title}</h3>
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; white-space: pre-wrap; max-height: 500px; overflow-y: auto; font-family: monospace;">
                        ${typeof content === 'string' ? content : JSON.stringify(content, null, 2)}
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button class="btn primary" onclick="copyToClipboard('${encodeURIComponent(content)}')">Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                        <button class="btn success" onclick="downloadReport('${title}', '${encodeURIComponent(content)}')">ØªØ­Ù…ÙŠÙ„</button>
                        <button class="btn warning" onclick="printReport()">Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                </div>
            `;
        }

        function downloadReport(title, encodedContent) {
            const content = decodeURIComponent(encodedContent);
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title}_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function exportToPDF() {
            showMessage('info', 'ØªØµØ¯ÙŠØ± PDF ÙŠØªØ·Ù„Ø¨ Ù…ÙƒØªØ¨Ø© Ø®Ø§Ø±Ø¬ÙŠØ©');
        }

        function exportToExcel() {
            showMessage('info', 'ØªØµØ¯ÙŠØ± Excel ÙŠØªØ·Ù„Ø¨ Ù…ÙƒØªØ¨Ø© Ø®Ø§Ø±Ø¬ÙŠØ©');
        }

        function scheduleReport() {
            showMessage('info', 'Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©');
        }

        function emailReport() {
            showMessage('info', 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©');
        }

        // ===================== Main Execution Function (Enhanced) =====================
        async function runMatching() {
            const startBtn = document.getElementById('start-matching-btn');
            const loader = document.getElementById('loader');
            const matchesContainer = document.getElementById('matches-container');
            const noResults = document.getElementById('no-results');

            startBtn.disabled = true;
            startBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…...';
            loader.style.display = 'block';
            matchesContainer.innerHTML = '';
            noResults.style.display = 'none';

            try {
                await ensureApiKeyOrFail();
                await loadDataForMatching();
                await classifyAndSeparateFiles();

                if (requests.length === 0 || offers.length === 0) {
                    throw new Error('ÙŠØ¬Ø¨ ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨Ø§Øª ÙˆØ¹Ø±ÙˆØ¶ Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©.');
                }

                const prompt = createMatchingPrompt(requests, offers);
                const matches = await callOpenAI(prompt);

                if (matches) {
                    displayMatches(matches);
                    if (matches.length > 0) {
                        showMessage('success', `ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…! ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${matches.length} Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ù…ÙŠØ²Ø§Øª Ø°ÙƒÙŠØ©.`);
                        
                        // Auto-update analytics
                        setTimeout(updateAnalytics, 1000);
                    } else {
                        showMessage('info', 'âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„. Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù‚ÙˆÙŠØ©.');
                    }
                } else {
                    noResults.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù€ Console.';
                    noResults.style.display = 'block';
                }
            } catch (error) {
                console.error("Matching process failed:", error);
                showMessage('error', `ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${error.message}`);
                noResults.textContent = `ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${error.message}`;
                noResults.style.display = 'block';
            } finally {
                startBtn.disabled = false;
                startBtn.textContent = 'ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©';
                loader.style.display = 'none';
            }
        }
    </script>
</body>

</html>