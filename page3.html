<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>نظام مطابقة العقارات الذكي المطور - مع البحث المتقدم</title>
    <style>
        /* ===================== CSS Variables and Global Styles ===================== */
        :root {
            --bg: #0f172a;
            --card: #111827;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #22c55e;
            --accent-2: #3b82f6;
            --accent-3: #f59e0b;
            --accent-4: #8b5cf6;
            --btn-bg: #1f2937;
            --btn-hover: #374151;
            --shadow: 0 10px 25px rgba(0, 0, 0, .35);
            --radius: 18px;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", Arial, sans-serif;
            line-height: 1.6;
        }

        /* ===================== Layout and Card Styles ===================== */
        .wrap {
            min-height: 100vh;
            display: grid;
            place-items: center;
            padding: 24px;
        }

        .card {
            width: min(1400px, 96vw);
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .01));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: var(--radius);
            padding: 28px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(6px);
        }

        h1 {
            margin: 0 0 10px;
            font-size: clamp(26px, 3.5vw, 40px);
            letter-spacing: .2px;
        }

        p.lead {
            margin: 0 0 26px;
            color: var(--muted);
        }

        /* ===================== Smart Search Panel ===================== */
        .smart-search-panel {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1));
            border: 2px solid rgba(34, 197, 94, 0.3);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
        }

        .smart-search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .smart-search-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-paths-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .search-path-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            position: relative;
        }

        .search-path-item.active {
            border-color: var(--accent);
            background: rgba(34, 197, 94, 0.1);
        }

        .search-path-item.scanning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .path-checkbox {
            margin-left: 8px;
            width: 18px;
            height: 18px;
        }

        .path-status {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 20px;
        }

        /* ===================== AI Analysis Panel ===================== */
        .ai-analysis-panel {
            background: rgba(139, 92, 246, 0.1);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .analysis-progress {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }

        .analysis-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }

        .analysis-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ===================== Tabs Navigation ===================== */
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            padding-bottom: 16px;
        }

        .tab-btn {
            padding: 12px 20px;
            background: var(--btn-bg);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            cursor: pointer;
            transition: all .2s ease;
            font-size: 14px;
        }

        .tab-btn:hover {
            background: var(--btn-hover);
        }

        .tab-btn.active {
            background: var(--accent-2);
            border-color: var(--accent-2);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===================== Buttons and Links ===================== */
        button.btn,
        a.btn {
            display: inline-block;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            background: var(--btn-bg);
            color: var(--text);
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .08);
            transition: transform .12s ease, background .12s ease, border-color .12s ease;
            box-shadow: 0 6px 14px rgba(0, 0, 0, .25);
            font-family: inherit;
            font-size: inherit;
            margin: 4px;
        }

        button.btn:hover,
        a.btn:hover {
            background: var(--btn-hover);
            transform: translateY(-1px);
        }

        button.btn.primary {
            background: var(--accent-2);
            border-color: transparent;
            color: #fff;
        }

        button.btn.success {
            background: var(--accent);
            border-color: transparent;
            color: #fff;
        }

        button.btn.warning {
            background: var(--warning);
            border-color: transparent;
            color: #fff;
        }

        button.btn.purple {
            background: var(--accent-4);
            border-color: transparent;
            color: #fff;
        }

        button.btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ===================== File Discovery Panel ===================== */
        .discovery-panel {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .discovered-files {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .discovered-file-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            flex: 1;
        }

        .file-path {
            font-family: monospace;
            font-size: 12px;
            color: var(--muted);
            word-break: break-all;
        }

        .file-size {
            font-size: 11px;
            color: var(--accent-3);
        }

        /* ===================== Sections and Status ===================== */
        .status-section,
        .controls-section,
        .results-section,
        .analytics-section,
        .crm-section {
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            text-align: center;
        }

        .stat-item .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-2);
        }

        .stat-item .stat-label {
            font-size: 12px;
            color: var(--muted);
        }

        /* ===================== Filter Controls ===================== */
        .filter-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            align-items: end;
        }

        .filter-item label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            color: var(--muted);
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 8px 12px;
            background: var(--btn-bg);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
        }

        /* ===================== Match Results Enhancement ===================== */
        #status-message {
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            display: none;
            margin-bottom: 16px;
        }

        #status-message.info {
            background: rgba(59, 130, 246, .1);
            color: var(--accent-2);
            border: 1px solid rgba(59, 130, 246, .2);
        }

        #status-message.success {
            background: rgba(34, 197, 94, .1);
            color: var(--accent);
            border: 1px solid rgba(34, 197, 94, .2);
        }

        #status-message.error {
            background: rgba(239, 68, 68, .1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, .2);
        }

        .loader {
            border: 4px solid var(--btn-bg);
            border-top: 4px solid var(--accent-2);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .matches-container {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        .match-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: var(--radius);
            padding: 20px;
            position: relative;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            padding-bottom: 12px;
        }

        .match-quality {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .match-quality.مؤكدة {
            background: #10b981;
            color: #fff;
        }

        .match-quality.محتملة {
            background: #f59e0b;
            color: #fff;
        }

        .match-quality.ممكنة {
            background: #3b82f6;
            color: #fff;
        }

        /* ===================== Smart Search Status ===================== */
        .search-status {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-log-entry {
            margin: 4px 0;
            padding: 2px 0;
        }

        .log-success { color: var(--accent); }
        .log-error { color: var(--danger); }
        .log-warning { color: var(--warning); }
        .log-info { color: var(--accent-2); }

        /* ===================== Responsive Design ===================== */
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
            .search-paths-grid {
                grid-template-columns: 1fr;
            }
            .tab-nav {
                flex-wrap: wrap;
            }
        }

        /* ===================== Permission Request Modal ===================== */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .permission-modal-content {
            background: var(--card);
            border-radius: var(--radius);
            padding: 30px;
            max-width: 500px;
            text-align: center;
            border: 2px solid var(--accent);
        }

        .permission-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <!-- Permission Request Modal -->
    <div id="permission-modal" class="permission-modal">
        <div class="permission-modal-content">
            <div class="permission-icon">🔒</div>
            <h3>طلب صلاحيات متقدمة</h3>
            <p>يحتاج النظام الذكي للوصول إلى ملفات النظام للبحث عن البيانات العقارية</p>
            <button class="btn success" onclick="requestPermissions()">منح الصلاحيات</button>
            <button class="btn" onclick="closePermissionModal()">إلغاء</button>
        </div>
    </div>

    <div class="wrap">
        <div class="card">
            <h1><span style="font-size: 24px;">🧠</span> نظام مطابقة العقارات الذكي المطور</h1>
            <p class="lead">نظام ذكي متقدم مع البحث العميق في ملفات الأندرويد واستخلاص البيانات بالذكاء الاصطناعي</p>

            <!-- Smart Search Panel -->
            <div class="smart-search-panel">
                <div class="smart-search-header">
                    <div class="smart-search-title">
                        🔍 البحث الذكي المتقدم
                        <span id="search-status-indicator" style="font-size: 12px; color: var(--muted);">جاهز</span>
                    </div>
                    <button class="btn success" onclick="startSmartSearch()">🚀 بدء البحث الذكي</button>
                </div>

                <div class="search-paths-grid">
                    <div class="search-path-item" data-path="/storage/emulated/0/">
                        <input type="checkbox" class="path-checkbox" checked>
                        <div class="path-status">📁</div>
                        <h4>التخزين الداخلي</h4>
                        <div class="file-path">/storage/emulated/0/</div>
                        <div class="file-size">المجلدات الرئيسية</div>
                    </div>
                    
                    <div class="search-path-item" data-path="/sdcard/">
                        <input type="checkbox" class="path-checkbox" checked>
                        <div class="path-status">💾</div>
                        <h4>بطاقة الذاكرة</h4>
                        <div class="file-path">/sdcard/</div>
                        <div class="file-size">الملفات الخارجية</div>
                    </div>

                    <div class="search-path-item" data-path="/storage/">
                        <input type="checkbox" class="path-checkbox" checked>
                        <div class="path-status">🗂️</div>
                        <h4>جذر التخزين</h4>
                        <div class="file-path">/storage/</div>
                        <div class="file-size">جميع وحدات التخزين</div>
                    </div>

                    <div class="search-path-item" data-path="/data/">
                        <input type="checkbox" class="path-checkbox">
                        <div class="path-status">⚠️</div>
                        <h4>بيانات التطبيقات</h4>
                        <div class="file-path">/data/</div>
                        <div class="file-size">يتطلب صلاحيات خاصة</div>
                    </div>

                    <div class="search-path-item" data-path="Downloads">
                        <input type="checkbox" class="path-checkbox" checked>
                        <div class="path-status">⬇️</div>
                        <h4>مجلد التحميلات</h4>
                        <div class="file-path">Downloads/</div>
                        <div class="file-size">الملفات المحملة</div>
                    </div>

                    <div class="search-path-item" data-path="Documents">
                        <input type="checkbox" class="path-checkbox" checked>
                        <div class="path-status">📄</div>
                        <h4>المستندات</h4>
                        <div class="file-path">Documents/</div>
                        <div class="file-size">الملفات النصية</div>
                    </div>
                </div>

                <div class="search-status" id="search-log">
                    <div class="search-log-entry log-info">📡 نظام البحث الذكي جاهز للعمل...</div>
                    <div class="search-log-entry log-info">🔍 يمكن البحث في ملفات TXT و JSON تلقائياً</div>
                    <div class="search-log-entry log-info">🤖 AI جاهز لتحليل العروض والطلبات العقارية</div>
                </div>
            </div>

            <!-- AI Analysis Panel -->
            <div class="ai-analysis-panel">
                <h3>🤖 تحليل الذكاء الاصطناعي المتقدم</h3>
                <div class="analysis-progress">
                    <div class="analysis-progress-bar" id="ai-progress"></div>
                </div>
                <div id="ai-status">جاهز لتحليل الملفات المكتشفة بالذكاء الاصطناعي</div>
            </div>

            <!-- File Discovery Panel -->
            <div class="discovery-panel">
                <h3>📂 الملفات المكتشفة (<span id="discovered-count">0</span>)</h3>
                <div class="discovered-files" id="discovered-files"></div>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('matching')">🤖 المطابقة الذكية</button>
                <button class="tab-btn" onclick="switchTab('analysis')">📊 التحليل المتقدم</button>
                <button class="tab-btn" onclick="switchTab('discovery')">🔍 اكتشاف الملفات</button>
            </div>

            <!-- Matching Tab -->
            <div id="matching-tab" class="tab-content active">
                <!-- Status Section -->
                <div class="status-section">
                    <h2>📊 حالة البيانات المكتشفة</h2>
                    <div id="status-message"></div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="total-docs">0</div>
                            <div class="stat-label">إجمالي المستندات</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="request-count">0</div>
                            <div class="stat-label">الطلبات</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="offer-count">0</div>
                            <div class="stat-label">العروض</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="matches-count">0</div>
                            <div class="stat-label">المطابقات المكتشفة</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Filter Section -->
                <div class="filter-section">
                    <h3>🔍 تصفية النتائج</h3>
                    <div class="filter-grid">
                        <div class="filter-item">
                            <label>جودة المطابقة</label>
                            <select id="quality-filter">
                                <option value="">جميع المستويات</option>
                                <option value="مؤكدة">مؤكدة</option>
                                <option value="محتملة">محتملة</option>
                                <option value="ممكنة">ممكنة</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>نوع العقار</label>
                            <select id="property-type-filter">
                                <option value="">جميع الأنواع</option>
                                <option value="شقة">شقة</option>
                                <option value="فيلا">فيلا</option>
                                <option value="أرض">أرض</option>
                                <option value="محل">محل تجاري</option>
                                <option value="مكتب">مكتب</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>نطاق السعر (من)</label>
                            <input type="number" id="price-min" placeholder="الحد الأدنى">
                        </div>
                        <div class="filter-item">
                            <label>نطاق السعر (إلى)</label>
                            <input type="number" id="price-max" placeholder="الحد الأعلى">
                        </div>
                        <div class="filter-item">
                            <button class="btn primary" onclick="applyFilters()">تطبيق التصفية</button>
                        </div>
                    </div>
                </div>

                <!-- Controls Section -->
                <div class="controls-section" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                    <button class="btn success" id="start-matching-btn" onclick="runSmartMatching()">🧠 بدء المطابقة الذكية</button>
                    <button class="btn" onclick="promptAndSaveApiKey()">🔑 إعداد مفتاح OpenAI</button>
                    <button class="btn" onclick="testApiKey()">🧪 اختبار المفتاح</button>
                    <button class="btn warning" onclick="deepScanSystem()">🔬 فحص عميق للنظام</button>
                    <button class="btn purple" onclick="aiAutoDiscover()">🤖 اكتشاف تلقائي بالـ AI</button>
                </div>

                <!-- Results Section -->
                <div class="results-section">
                    <h2>💡 نتائج المطابقة الذكية</h2>
                    <div id="loader" class="loader"></div>
                    <div id="matches-container" class="matches-container"></div>
                    <p id="no-results" style="color: var(--muted); text-align: center; display: block;">ابدأ البحث الذكي لاكتشاف الملفات وتحليل المطابقات تلقائياً</p>
                </div>
            </div>

            <!-- Analysis Tab -->
            <div id="analysis-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>📊 تحليل البيانات المكتشفة</h2>
                    <div id="analysis-results"></div>
                </div>
            </div>

            <!-- Discovery Tab -->
            <div id="discovery-tab" class="tab-content">
                <div class="analytics-section">
                    <h2>🔍 إعدادات اكتشاف الملفات</h2>
                    <div id="discovery-settings"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =================================================================================
        // SUPER SMART FILE DISCOVERY AND AI ANALYSIS SYSTEM
        // =================================================================================

        // ===================== Core Variables =====================
        const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
        const OPENAI_MODEL = 'gpt-4o-mini';
        const API_KEY_STORAGE_KEY = 'OPENAI_API_KEY';

        let discoveredFiles = [];
        let allTextFiles = [];
        let requests = [];
        let offers = [];
        let allMatches = [];
        let filteredMatches = [];
        let searchProgress = 0;

        // ===================== Android File System Paths =====================
        const ANDROID_SEARCH_PATHS = [
            '/storage/emulated/0/',
            '/sdcard/',
            '/storage/',
            '/data/data/',
            '/data/media/',
            '/mnt/sdcard/',
            '/storage/sdcard0/',
            '/storage/extSdCard/',
            'Downloads/',
            'Documents/',
            'WhatsApp/Media/',
            'Telegram/',
            'Pictures/',
            'DCIM/',
            'Android/data/',
            'Android/obb/'
        ];

        const PRIORITY_FOLDERS = [
            'Downloads',
            'Documents', 
            'WhatsApp',
            'Telegram',
            'Real Estate',
            'Properties',
            'عقارات',
            'ملفات',
            'مستندات'
        ];

        // ===================== File Access APIs (Simulated) =====================
        class SmartFileDiscovery {
            constructor() {
                this.foundFiles = [];
                this.scanProgress = 0;
                this.isScanning = false;
            }

            async requestPermissions() {
                // Simulate permission request
                return new Promise((resolve) => {
                    logToSearch('🔐 طلب صلاحيات الوصول للملفات...', 'info');
                    setTimeout(() => {
                        logToSearch('✅ تم منح الصلاحيات بنجاح', 'success');
                        resolve(true);
                    }, 1000);
                });
            }

            async scanPath(path) {
                const selectedPaths = Array.from(document.querySelectorAll('.path-checkbox:checked'))
                    .map(cb => cb.closest('.search-path-item').dataset.path);

                if (!selectedPaths.includes(path)) return [];

                logToSearch(`🔍 فحص المسار: ${path}`, 'info');
                
                // Simulate file discovery with realistic Android paths
                const simulatedFiles = await this.simulateFileDiscovery(path);
                
                return simulatedFiles;
            }

            async simulateFileDiscovery(basePath) {
                const files = [];
                const fileTypes = ['.txt', '.json'];
                const commonNames = [
                    'real_estate_data',
                    'properties',
                    'listings',
                    'chat_export',
                    'telegram_export',
                    'whatsapp_chat',
                    'عقارات',
                    'بيانات_عقارية',
                    'قوائم_العقارات',
                    'محادثات',
                    'backup',
                    'export',
                    'data'
                ];

                // Simulate realistic file discovery
                for (let i = 0; i < Math.random() * 10 + 5; i++) {
                    const name = commonNames[Math.floor(Math.random() * commonNames.length)];
                    const ext = fileTypes[Math.floor(Math.random() * fileTypes.length)];
                    const fileName = `${name}_${Date.now() + i}${ext}`;
                    const fullPath = `${basePath}${fileName}`;
                    
                    // Simulate file content generation
                    const content = await this.generateRealisticContent(ext);
                    
                    files.push({
                        name: fileName,
                        path: fullPath,
                        size: content.length,
                        type: ext === '.json' ? 'application/json' : 'text/plain',
                        content: content,
                        lastModified: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000)
                    });

                    // Add delay to simulate real scanning
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                return files;
            }

            async generateRealisticContent(fileType) {
                if (fileType === '.json') {
                    // Generate realistic JSON chat export
                    const messages = [];
                    const sampleTexts = [
                        "مطلوب شقة في الرياض حي النخيل ميزانية 300 ألف",
                        "للبيع فيلا في جدة حي الروضة 450 ألف ريال",
                        "ابحث عن أرض في الدمام للاستثمار",
                        "معروض شقق للإيجار في مكة أسعار مناسبة",
                        "مطلوب محل تجاري في وسط البلد",
                        "للبيع عمارة في الطائف عائد ممتاز",
                        "أرض للبيع في القصيم موقع مميز",
                        "شقة مفروشة للإيجار في الخبر",
                        "فيلا دوبلكس للبيع في أبها",
                        "مطلوب مكتب للإيجار في برج تجاري"
                    ];

                    for (let i = 0; i < Math.random() * 20 + 10; i++) {
                        const text = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
                        messages.push({
                            id: i + 1,
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
                            original_text: text,
                            phones: Math.random() > 0.7 ? [`05${Math.floor(Math.random() * 99999999).toString().padStart(8, '0')}`] : [],
                            prices: Math.random() > 0.6 ? [`${Math.floor(Math.random() * 500 + 100)} ألف ريال`] : []
                        });
                    }

                    return JSON.stringify({
                        export_date: new Date().toISOString(),
                        messages: messages,
                        source: "chat_export"
                    }, null, 2);
                } else {
                    // Generate realistic text content
                    const textSamples = [
                        "قائمة العقارات المتاحة:\n\n",
                        "للبيع شقة في الرياض 280 ألف\n",
                        "مطلوب فيلا في جدة ميزانية 500 ألف\n",
                        "أرض تجارية للبيع في الدمام\n",
                        "شقق للإيجار أسعار تنافسية\n",
                        "عقارات استثمارية عوائد عالية\n"
                    ];
                    return textSamples.join('\n');
                }
            }

            async deepScan() {
                this.isScanning = true;
                this.foundFiles = [];
                this.scanProgress = 0;

                logToSearch('🚀 بدء الفحص العميق للنظام...', 'info');
                
                const totalPaths = ANDROID_SEARCH_PATHS.length;
                let scannedPaths = 0;

                for (const path of ANDROID_SEARCH_PATHS) {
                    try {
                        const pathFiles = await this.scanPath(path);
                        this.foundFiles.push(...pathFiles);
                        
                        scannedPaths++;
                        this.scanProgress = (scannedPaths / totalPaths) * 100;
                        
                        updateSearchProgress(this.scanProgress);
                        logToSearch(`📁 تم فحص ${path} - عثر على ${pathFiles.length} ملف`, 'success');
                        
                        // Update UI with discovered files
                        displayDiscoveredFiles(pathFiles);
                        
                    } catch (error) {
                        logToSearch(`❌ خطأ في فحص ${path}: ${error.message}`, 'error');
                    }
                }

                this.isScanning = false;
                logToSearch(`🎉 اكتمل الفحص! تم العثور على ${this.foundFiles.length} ملف`, 'success');
                
                return this.foundFiles;
            }
        }

        // ===================== Smart AI Analysis =====================
        class SmartAIAnalyzer {
            constructor() {
                this.analysisCache = new Map();
            }

            async analyzeFiles(files) {
                logToSearch('🤖 بدء التحليل بالذكاء الاصطناعي...', 'info');
                
                const results = {
                    totalFiles: files.length,
                    textFiles: 0,
                    jsonFiles: 0,
                    totalRequests: 0,
                    totalOffers: 0,
                    extractedData: []
                };

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateAIProgress((i / files.length) * 100);
                    
                    try {
                        const analysis = await this.analyzeFile(file);
                        results.extractedData.push({
                            file: file.name,
                            path: file.path,
                            ...analysis
                        });

                        if (file.name.endsWith('.txt')) results.textFiles++;
                        if (file.name.endsWith('.json')) results.jsonFiles++;
                        
                        results.totalRequests += analysis.requests?.length || 0;
                        results.totalOffers += analysis.offers?.length || 0;

                        logToSearch(`✅ تحليل ${file.name} - ${analysis.requests?.length || 0} طلب، ${analysis.offers?.length || 0} عرض`, 'success');
                        
                    } catch (error) {
                        logToSearch(`❌ فشل تحليل ${file.name}: ${error.message}`, 'error');
                    }
                }

                updateAIProgress(100);
                logToSearch(`🎯 انتهى التحليل: ${results.totalRequests} طلب، ${results.totalOffers} عرض`, 'success');
                
                return results;
            }

            async analyzeFile(file) {
                const cacheKey = `${file.path}_${file.lastModified}`;
                if (this.analysisCache.has(cacheKey)) {
                    return this.analysisCache.get(cacheKey);
                }

                const analysis = {
                    requests: [],
                    offers: [],
                    phones: [],
                    prices: [],
                    metadata: {
                        fileType: file.type,
                        size: file.size,
                        processed: new Date().toISOString()
                    }
                };

                try {
                    if (file.name.endsWith('.json')) {
                        const jsonData = JSON.parse(file.content);
                        if (jsonData.messages && Array.isArray(jsonData.messages)) {
                            jsonData.messages.forEach(message => {
                                const classified = this.classifyMessage(message.original_text || '');
                                if (classified.type === 'request') {
                                    analysis.requests.push({
                                        text: message.original_text,
                                        timestamp: message.timestamp,
                                        phones: message.phones || [],
                                        prices: message.prices || []
                                    });
                                } else if (classified.type === 'offer') {
                                    analysis.offers.push({
                                        text: message.original_text,
                                        timestamp: message.timestamp,
                                        phones: message.phones || [],
                                        prices: message.prices || []
                                    });
                                }
                                
                                analysis.phones.push(...(message.phones || []));
                                analysis.prices.push(...(message.prices || []));
                            });
                        }
                    } else {
                        // Text file analysis
                        const lines = file.content.split('\n').filter(line => line.trim());
                        lines.forEach(line => {
                            const classified = this.classifyMessage(line);
                            if (classified.type === 'request') {
                                analysis.requests.push({ text: line });
                            } else if (classified.type === 'offer') {
                                analysis.offers.push({ text: line });
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error analyzing file:', error);
                }

                this.analysisCache.set(cacheKey, analysis);
                return analysis;
            }

            classifyMessage(text) {
                if (!text) return { type: 'unknown', confidence: 0 };

                const textLower = text.toLowerCase();
                
                // Request keywords
                const requestKeywords = [
                    'مطلوب', 'ابحث عن', 'أريد', 'نريد', 'محتاج', 'بحاجة',
                    'عاوز', 'عايز', 'ادور على', 'أدور على', 'نبحث عن',
                    'wanted', 'looking for', 'need', 'require', 'searching'
                ];

                // Offer keywords  
                const offerKeywords = [
                    'للبيع', 'للايجار', 'للإيجار', 'معروض', 'متوفر', 'يوجد',
                    'عندي', 'لدي', 'متاح', 'للتنازل', 'أعرض', 'نعرض',
                    'for sale', 'for rent', 'available', 'offering'
                ];

                let requestScore = 0;
                let offerScore = 0;

                requestKeywords.forEach(keyword => {
                    if (textLower.includes(keyword)) requestScore++;
                });

                offerKeywords.forEach(keyword => {
                    if (textLower.includes(keyword)) offerScore++;
                });

                if (requestScore > offerScore) {
                    return { type: 'request', confidence: requestScore / requestKeywords.length };
                } else if (offerScore > requestScore) {
                    return { type: 'offer', confidence: offerScore / offerKeywords.length };
                }

                return { type: 'unknown', confidence: 0 };
            }
        }

        // ===================== Initialize Smart Systems =====================
        const smartDiscovery = new SmartFileDiscovery();
        const smartAnalyzer = new SmartAIAnalyzer();

        // ===================== UI Functions =====================
        function logToSearch(message, type = 'info') {
            const log = document.getElementById('search-log');
            const entry = document.createElement('div');
            entry.className = `search-log-entry log-${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateSearchProgress(percentage) {
            const indicator = document.getElementById('search-status-indicator');
            indicator.textContent = `جاري المسح ${Math.round(percentage)}%`;
            
            if (percentage >= 100) {
                indicator.textContent = 'اكتمل المسح';
            }
        }

        function updateAIProgress(percentage) {
            const progressBar = document.getElementById('ai-progress');
            const status = document.getElementById('ai-status');
            
            progressBar.style.width = percentage + '%';
            status.textContent = `جاري التحليل... ${Math.round(percentage)}%`;
            
            if (percentage >= 100) {
                status.textContent = 'اكتمل التحليل بالذكاء الاصطناعي';
            }
        }

        function displayDiscoveredFiles(files) {
            const container = document.getElementById('discovered-files');
            const counter = document.getElementById('discovered-count');
            
            discoveredFiles.push(...files);
            counter.textContent = discoveredFiles.length;

            files.forEach(file => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'discovered-file-item';
                fileDiv.innerHTML = `
                    <div class="file-info">
                        <strong>${file.name}</strong>
                        <div class="file-path">${file.path}</div>
                        <div class="file-size">${formatFileSize(file.size)} - ${file.lastModified.toLocaleDateString('ar-SA')}</div>
                    </div>
                    <div>
                        <button class="btn btn-small" onclick="processFile('${file.path}')">📋 معالجة</button>
                        <button class="btn btn-small success" onclick="analyzeFile('${file.path}')">🤖 تحليل</button>
                    </div>
                `;
                container.appendChild(fileDiv);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ===================== Core Functions =====================
        async function startSmartSearch() {
            showMessage('info', '🚀 بدء البحث الذكي المتقدم...');
            
            try {
                // Reset progress
                updateSearchProgress(0);
                updateAIProgress(0);
                
                // Start discovery
                const files = await smartDiscovery.deepScan();
                
                if (files.length > 0) {
                    showMessage('success', `🎉 تم اكتشاف ${files.length} ملف بنجاح!`);
                    
                    // Auto-analyze discovered files
                    const analysisResults = await smartAnalyzer.analyzeFiles(files);
                    
                    // Update global variables for matching
                    allTextFiles = files;
                    updateStatsFromAnalysis(analysisResults);
                    
                    showMessage('success', `🤖 تم تحليل البيانات: ${analysisResults.totalRequests} طلب، ${analysisResults.totalOffers} عرض`);
                } else {
                    showMessage('warning', '⚠️ لم يتم العثور على ملفات. جرب البحث العميق.');
                }
                
            } catch (error) {
                showMessage('error', `❌ خطأ في البحث الذكي: ${error.message}`);
                logToSearch(`💥 خطأ نظام: ${error.message}`, 'error');
            }
        }

        async function deepScanSystem() {
            showMessage('info', '🔬 بدء الفحص العميق للنظام...');
            
            // Request enhanced permissions
            document.getElementById('permission-modal').style.display = 'flex';
        }

        async function aiAutoDiscover() {
            showMessage('info', '🤖 تفعيل الاكتشاف التلقائي بالذكاء الاصطناعي...');
            
            // Enhanced AI discovery with pattern recognition
            logToSearch('🧠 تحليل أنماط الملفات...', 'info');
            logToSearch('🔍 البحث في المجلدات المخفية...', 'warning');
            logToSearch('📱 فحص بيانات التطبيقات...', 'info');
            
            // Simulate intelligent discovery
            setTimeout(async () => {
                await startSmartSearch();
                logToSearch('🎯 اكتمل الاكتشاف الذكي!', 'success');
            }, 2000);
        }

        function updateStatsFromAnalysis(analysis) {
            document.getElementById('total-docs').textContent = analysis.totalFiles;
            document.getElementById('request-count').textContent = analysis.totalRequests;
            document.getElementById('offer-count').textContent = analysis.totalOffers;
            
            // Prepare data for matching
            requests = [];
            offers = [];
            
            analysis.extractedData.forEach(fileData => {
                if (fileData.requests) {
                    requests.push(...fileData.requests.map(req => ({
                        text: req.text,
                        source: fileData.file,
                        phones: req.phones || [],
                        prices: req.prices || []
                    })));
                }
                if (fileData.offers) {
                    offers.push(...fileData.offers.map(offer => ({
                        text: offer.text,
                        source: fileData.file,
                        phones: offer.phones || [],
                        prices: offer.prices || []
                    })));
                }
            });
        }

        // ===================== Permission Handling =====================
        async function requestPermissions() {
            try {
                await smartDiscovery.requestPermissions();
                closePermissionModal();
                showMessage('success', '✅ تم منح الصلاحيات. يمكن الآن الوصول لجميع الملفات');
                
                // Start enhanced deep scan
                setTimeout(startSmartSearch, 1000);
                
            } catch (error) {
                showMessage('error', '❌ فشل في الحصول على الصلاحيات');
            }
        }

        function closePermissionModal() {
            document.getElementById('permission-modal').style.display = 'none';
        }

        // ===================== Tab Management =====================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // ===================== OpenAI Integration =====================
        function getApiKey() {
            return localStorage.getItem(API_KEY_STORAGE_KEY) || '';
        }

        function saveApiKey(key) {
            if (!key || !key.trim()) return false;
            localStorage.setItem(API_KEY_STORAGE_KEY, key.trim());
            return true;
        }

        function promptAndSaveApiKey() {
            const currentKey = getApiKey();
            const newKey = prompt('أدخل مفتاح OpenAI (يُخزن محلياً في متصفحك):', currentKey);
            if (newKey !== null) {
                if (saveApiKey(newKey)) {
                    showMessage('success', '✅ تم حفظ مفتاح OpenAI محلياً.');
                } else {
                    showMessage('error', '❌ لم يتم حفظ المفتاح. تأكد أنه غير فارغ.');
                }
            }
        }

        async function testApiKey() {
            try {
                const key = getApiKey();
                if (!key) {
                    showMessage('error', '❌ لا يوجد مفتاح OpenAI. اضغط "إعداد مفتاح OpenAI" لإدخاله.');
                    return;
                }

                showMessage('info', '🧪 جاري اختبار المفتاح...');

                const res = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: [{
                            role: 'user',
                            content: 'Test message'
                        }],
                        max_tokens: 10
                    })
                });

                if (res.ok) {
                    showMessage('success', '✅ المفتاح يعمل بشكل صحيح.');
                } else {
                    showMessage('error', '❌ المفتاح غير صالح.');
                }
            } catch (error) {
                showMessage('error', `❌ خطأ في اختبار المفتاح: ${error.message}`);
            }
        }

        // ===================== Smart Matching with Discovered Data =====================
        async function runSmartMatching() {
            if (requests.length === 0 || offers.length === 0) {
                showMessage('warning', '⚠️ ابدأ البحث الذكي أولاً لاكتشاف البيانات');
                return;
            }

            showMessage('info', '🧠 بدء المطابقة الذكية مع البيانات المكتشفة...');
            
            try {
                const key = getApiKey();
                if (!key) {
                    showMessage('error', '❌ مطلوب مفتاح OpenAI للمطابقة الذكية');
                    return;
                }

                const prompt = createSmartMatchingPrompt(requests, offers);
                const matches = await callOpenAI(prompt, key);

                if (matches && matches.length > 0) {
                    displayMatches(matches);
                    showMessage('success', `🎉 تم العثور على ${matches.length} مطابقة ذكية!`);
                    document.getElementById('matches-count').textContent = matches.length;
                } else {
                    showMessage('info', '📋 لم يتم العثور على مطابقات قوية في البيانات المكتشفة');
                }

            } catch (error) {
                showMessage('error', `❌ خطأ في المطابقة الذكية: ${error.message}`);
            }
        }

        function createSmartMatchingPrompt(requestsBatch, offersBatch) {
            return `أنت خبير عقاري ذكي متخصص في تحليل البيانات المكتشفة من ملفات الأندرويد.
            
تم اكتشاف البيانات التالية من فحص الملفات:

الطلبات المكتشفة:
${requestsBatch.map((req, i) => `${i + 1}. ${req.text} (المصدر: ${req.source})`).join('\n')}

العروض المكتشفة:
${offersBatch.map((offer, i) => `${i + 1}. ${offer.text} (المصدر: ${offer.source})`).join('\n')}

قم بتحليل ذكي ومطابقة العروض مع الطلبات. أرجع JSON مع المطابقات بالصيغة:
[{
  "quality": "مؤكدة/محتملة/ممكنة",
  "property_type": "نوع العقار",
  "area": "المنطقة",
  "requested_price": "سعر الطلب",
  "offered_price": "سعر العرض",
  "reason": "سبب المطابقة",
  "request_text": "نص الطلب",
  "offer_text": "نص العرض",
  "urgency_score": "1-10",
  "source_files": "ملفات المصدر"
}]`;
        }

        async function callOpenAI(prompt, apiKey) {
            const response = await fetch(OPENAI_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: OPENAI_MODEL,
                    messages: [{
                        role: 'system',
                        content: 'أرجع JSON فقط بدون أي نص إضافي أو شرح. ابدأ مباشرة بـ [ وانته بـ ]'
                    }, {
                        role: 'user',
                        content: prompt
                    }],
                    temperature: 0.3,
                    max_tokens: 4000
                })
            });

            if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.status}`);
            }

            const data = await response.json();
            let content = data.choices[0].message.content;
            
            try {
                // إزالة أي نص قبل أو بعد JSON
                content = content.replace(/```json|```/g, '').trim();
                
                // البحث عن بداية JSON
                const jsonStart = content.indexOf('[');
                const jsonEnd = content.lastIndexOf(']');
                
                if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
                    content = content.substring(jsonStart, jsonEnd + 1);
                }
                
                // محاولة تحليل JSON
                const parsed = JSON.parse(content);
                
                // التأكد من أن النتيجة مصفوفة
                if (Array.isArray(parsed)) {
                    logToSearch(`✅ تم تحليل ${parsed.length} مطابقة من OpenAI`, 'success');
                    return parsed;
                } else {
                    logToSearch('⚠️ OpenAI لم يرجع مصفوفة صالحة', 'warning');
                    return [];
                }
                
            } catch (e) {
                console.error('Failed to parse OpenAI response:', content);
                logToSearch(`❌ فشل تحليل استجابة OpenAI: ${e.message}`, 'error');
                
                // محاولة أخيرة - استخراج JSON من النص
                try {
                    const regex = /\[[\s\S]*\]/;
                    const match = content.match(regex);
                    if (match) {
                        const extracted = JSON.parse(match[0]);
                        if (Array.isArray(extracted)) {
                            logToSearch(`✅ تم استخراج ${extracted.length} مطابقة بنجاح`, 'success');
                            return extracted;
                        }
                    }
                } catch (e2) {
                    console.error('Final parsing attempt failed:', e2);
                }
                
                return [];
            }
        }

        function displayMatches(matches) {
            const container = document.getElementById('matches-container');
            const noResults = document.getElementById('no-results');
            
            container.innerHTML = '';
            noResults.style.display = 'none';

            if (!matches || matches.length === 0) {
                noResults.style.display = 'block';
                return;
            }

            allMatches = matches;
            filteredMatches = matches;

            matches.forEach((match, index) => {
                const card = document.createElement('div');
                card.className = 'match-card';
                card.innerHTML = `
                    <div class="match-header">
                        <h3>🏠 مطابقة ${match.property_type || 'عقارية'}</h3>
                        <span class="match-quality ${match.quality}">${match.quality}</span>
                    </div>
                    <div><strong>المنطقة:</strong> ${match.area || 'غير محدد'}</div>
                    <div><strong>سعر الطلب:</strong> ${match.requested_price || 'غير محدد'}</div>
                    <div><strong>سعر العرض:</strong> ${match.offered_price || 'غير محدد'}</div>
                    <div><strong>ملفات المصدر:</strong> ${match.source_files || 'بيانات مكتشفة'}</div>
                    <div><strong>💡 سبب المطابقة:</strong> ${match.reason}</div>
                    <div style="margin-top: 12px;">
                        <h4>📝 نص الطلب:</h4>
                        <p style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px;">${match.request_text}</p>
                    </div>
                    <div style="margin-top: 12px;">
                        <h4>🏠 نص العرض:</h4>
                        <p style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px;">${match.offer_text}</p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ===================== Utility Functions =====================
        function showMessage(type, message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = type;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function applyFilters() {
            // Implement filtering logic for discovered matches
            showMessage('info', 'تطبيق التصفية على النتائج المكتشفة...');
        }

        // ===================== Initialize System =====================
        document.addEventListener('DOMContentLoaded', () => {
            logToSearch('🚀 نظام البحث الذكي جاهز للعمل', 'success');
            logToSearch('📱 جاهز للبحث في ملفات الأندرويد', 'info');
            logToSearch('🤖 AI محلل البيانات مُفعل', 'success');
            showMessage('success', '🧠 النظام الذكي جاهز! ابدأ البحث لاكتشاف الملفات');
        });
        
        // ===================== Advanced File Processing =====================
        async function processFile(filePath) {
            showMessage('info', `📋 معالجة الملف: ${filePath}`);
            
            const file = discoveredFiles.find(f => f.path === filePath);
            if (!file) {
                showMessage('error', '❌ الملف غير موجود');
                return;
            }

            try {
                const analysis = await smartAnalyzer.analyzeFile(file);
                
                // Save to system database
                const processedFile = {
                    id: Date.now().toString(),
                    name: file.name,
                    path: file.path,
                    content: file.content,
                    type: file.type,
                    size: file.size,
                    uploadTime: new Date().toLocaleString('ar-SA'),
                    timestamp: Date.now(),
                    analysisData: analysis
                };

                // Add to allTextFiles for matching
                allTextFiles.push(processedFile);
                
                // Extract requests and offers
                if (analysis.requests) {
                    requests.push(...analysis.requests.map(req => ({
                        text: req.text,
                        source: file.name,
                        phones: req.phones || [],
                        prices: req.prices || []
                    })));
                }

                if (analysis.offers) {
                    offers.push(...analysis.offers.map(offer => ({
                        text: offer.text,
                        source: file.name,
                        phones: offer.phones || [],
                        prices: offer.prices || []
                    })));
                }

                // Update stats
                document.getElementById('total-docs').textContent = allTextFiles.length;
                document.getElementById('request-count').textContent = requests.length;
                document.getElementById('offer-count').textContent = offers.length;

                showMessage('success', `✅ تم معالجة ${file.name} - ${analysis.requests?.length || 0} طلب، ${analysis.offers?.length || 0} عرض`);
                
            } catch (error) {
                showMessage('error', `❌ فشل معالجة الملف: ${error.message}`);
                logToSearch(`💥 خطأ في معالجة ${file.name}: ${error.message}`, 'error');
            }
        }

        async function analyzeFile(filePath) {
            showMessage('info', `🤖 تحليل الملف: ${filePath}`);
            
            const file = discoveredFiles.find(f => f.path === filePath);
            if (!file) {
                showMessage('error', '❌ الملف غير موجود');
                return;
            }

            try {
                updateAIProgress(0);
                const analysis = await smartAnalyzer.analyzeFile(file);
                updateAIProgress(100);
                
                // Display analysis results
                displayAnalysisResults(file, analysis);
                showMessage('success', `🎯 تم تحليل ${file.name} بنجاح`);
                
            } catch (error) {
                showMessage('error', `❌ فشل تحليل الملف: ${error.message}`);
            }
        }

        function displayAnalysisResults(file, analysis) {
            const resultsContainer = document.getElementById('analysis-results');
            if (!resultsContainer) return;

            const resultCard = document.createElement('div');
            resultCard.className = 'analytics-card';
            resultCard.innerHTML = `
                <h4>📊 تحليل: ${file.name}</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px;">
                    <div class="stat-item">
                        <div class="stat-number">${analysis.requests?.length || 0}</div>
                        <div class="stat-label">الطلبات</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${analysis.offers?.length || 0}</div>
                        <div class="stat-label">العروض</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${analysis.phones?.length || 0}</div>
                        <div class="stat-label">أرقام هواتف</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${analysis.prices?.length || 0}</div>
                        <div class="stat-label">أسعار</div>
                    </div>
                </div>
                
                ${analysis.requests?.length > 0 ? `
                    <h5>📝 الطلبات المكتشفة:</h5>
                    <div style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        ${analysis.requests.map((req, i) => `
                            <div style="margin-bottom: 8px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 4px;">
                                <strong>طلب ${i + 1}:</strong> ${req.text.substring(0, 100)}${req.text.length > 100 ? '...' : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${analysis.offers?.length > 0 ? `
                    <h5>🏠 العروض المكتشفة:</h5>
                    <div style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        ${analysis.offers.map((offer, i) => `
                            <div style="margin-bottom: 8px; padding: 8px; background: rgba(34, 197, 94, 0.1); border-radius: 4px;">
                                <strong>عرض ${i + 1}:</strong> ${offer.text.substring(0, 100)}${offer.text.length > 100 ? '...' : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div style="margin-top: 16px;">
                    <button class="btn primary" onclick="processFile('${file.path}')">✅ إضافة للنظام</button>
                    <button class="btn success" onclick="exportAnalysis('${file.name}')">📤 تصدير التحليل</button>
                </div>
            `;
            
            resultsContainer.appendChild(resultCard);
        }

        // ===================== Enhanced System Integration =====================
        async function saveToSystemDatabase(fileData) {
            try {
                // Simulate saving to IndexedDB or localStorage
                const savedFiles = JSON.parse(localStorage.getItem('smart_discovered_files') || '[]');
                savedFiles.push(fileData);
                localStorage.setItem('smart_discovered_files', JSON.stringify(savedFiles));
                
                logToSearch(`💾 تم حفظ ${fileData.name} في قاعدة البيانات`, 'success');
                return true;
            } catch (error) {
                logToSearch(`❌ فشل حفظ ${fileData.name}: ${error.message}`, 'error');
                return false;
            }
        }

        async function loadFromSystemDatabase() {
            try {
                const savedFiles = JSON.parse(localStorage.getItem('smart_discovered_files') || '[]');
                
                if (savedFiles.length > 0) {
                    allTextFiles.push(...savedFiles);
                    
                    // Extract requests and offers from saved files
                    savedFiles.forEach(file => {
                        if (file.analysisData) {
                            if (file.analysisData.requests) {
                                requests.push(...file.analysisData.requests.map(req => ({
                                    text: req.text,
                                    source: file.name,
                                    phones: req.phones || [],
                                    prices: req.prices || []
                                })));
                            }
                            if (file.analysisData.offers) {
                                offers.push(...file.analysisData.offers.map(offer => ({
                                    text: offer.text,
                                    source: file.name,
                                    phones: offer.phones || [],
                                    prices: offer.prices || []
                                })));
                            }
                        }
                    });
                    
                    updateSystemStats();
                    logToSearch(`📚 تم تحميل ${savedFiles.length} ملف من قاعدة البيانات`, 'success');
                }
            } catch (error) {
                logToSearch(`❌ فشل تحميل البيانات المحفوظة: ${error.message}`, 'error');
            }
        }

        function updateSystemStats() {
            document.getElementById('total-docs').textContent = allTextFiles.length;
            document.getElementById('request-count').textContent = requests.length;
            document.getElementById('offer-count').textContent = offers.length;
        }

        // ===================== Export and Backup Functions =====================
        function exportAnalysis(fileName) {
            const file = discoveredFiles.find(f => f.name === fileName);
            if (!file) return;

            const exportData = {
                fileName: file.name,
                filePath: file.path,
                analysisDate: new Date().toISOString(),
                fileSize: file.size,
                analysis: smartAnalyzer.analysisCache.get(`${file.path}_${file.lastModified}`)
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `تحليل_${fileName}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showMessage('success', `📤 تم تصدير تحليل ${fileName}`);
        }

        function exportDiscoveredData() {
            if (discoveredFiles.length === 0) {
                showMessage('warning', '⚠️ لا توجد بيانات مكتشفة للتصدير');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                systemInfo: {
                    totalFiles: discoveredFiles.length,
                    totalRequests: requests.length,
                    totalOffers: offers.length,
                    scanPaths: ANDROID_SEARCH_PATHS
                },
                discoveredFiles: discoveredFiles.map(file => ({
                    name: file.name,
                    path: file.path,
                    size: file.size,
                    type: file.type,
                    lastModified: file.lastModified,
                    analysisData: smartAnalyzer.analysisCache.get(`${file.path}_${file.lastModified}`)
                })),
                extractedRequests: requests,
                extractedOffers: offers
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `البيانات_المكتشفة_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showMessage('success', `📦 تم تصدير جميع البيانات المكتشفة`);
        }

        // ===================== Performance Monitoring =====================
        class PerformanceMonitor {
            constructor() {
                this.metrics = {
                    filesScanned: 0,
                    scanTime: 0,
                    analysisTime: 0,
                    matchingTime: 0,
                    memoryUsage: 0
                };
            }

            startTimer(operation) {
                this[`${operation}StartTime`] = performance.now();
            }

            endTimer(operation) {
                const duration = performance.now() - this[`${operation}StartTime`];
                this.metrics[`${operation}Time`] = duration;
                logToSearch(`⏱️ ${operation}: ${Math.round(duration)}ms`, 'info');
            }

            updateFileCount(count) {
                this.metrics.filesScanned = count;
            }

            getReport() {
                return {
                    ...this.metrics,
                    memoryUsage: this.getMemoryUsage()
                };
            }

            getMemoryUsage() {
                if (performance.memory) {
                    return Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + ' MB';
                }
                return 'غير متاح';
            }
        }

        const performanceMonitor = new PerformanceMonitor();

        // ===================== Advanced Settings Panel =====================
        function initializeDiscoverySettings() {
            const settingsContainer = document.getElementById('discovery-settings');
            if (!settingsContainer) return;

            settingsContainer.innerHTML = `
                <div class="analytics-card">
                    <h4>⚙️ إعدادات البحث المتقدم</h4>
                    
                    <div style="margin-bottom: 16px;">
                        <label>عمق البحث:</label>
                        <select id="search-depth">
                            <option value="1">سطحي (مجلد واحد)</option>
                            <option value="3" selected>متوسط (3 مستويات)</option>
                            <option value="5">عميق (5 مستويات)</option>
                            <option value="-1">شامل (جميع المستويات)</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label>أنواع الملفات:</label>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;">
                            <label><input type="checkbox" checked> .txt</label>
                            <label><input type="checkbox" checked> .json</label>
                            <label><input type="checkbox"> .csv</label>
                            <label><input type="checkbox"> .log</label>
                            <label><input type="checkbox"> .md</label>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label>حد حجم الملف:</label>
                        <select id="file-size-limit">
                            <option value="1">1 MB</option>
                            <option value="5" selected>5 MB</option>
                            <option value="10">10 MB</option>
                            <option value="50">50 MB</option>
                            <option value="-1">بلا حد</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label><input type="checkbox" id="skip-hidden" checked> تجاهل الملفات المخفية</label>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label><input type="checkbox" id="auto-analyze" checked> تحليل تلقائي عند الاكتشاف</label>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn primary" onclick="applyAdvancedSettings()">تطبيق الإعدادات</button>
                        <button class="btn" onclick="resetSettings()">إعادة تعيين</button>
                        <button class="btn success" onclick="exportDiscoveredData()">📤 تصدير البيانات</button>
                    </div>

                    <div style="margin-top: 20px; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <h5>📊 إحصائيات الأداء</h5>
                        <div id="performance-stats"></div>
                    </div>
                </div>
            `;
        }

        function applyAdvancedSettings() {
            showMessage('info', '⚙️ تطبيق الإعدادات المتقدمة...');
            
            const settings = {
                searchDepth: document.getElementById('search-depth')?.value || 3,
                fileSizeLimit: document.getElementById('file-size-limit')?.value || 5,
                skipHidden: document.getElementById('skip-hidden')?.checked || true,
                autoAnalyze: document.getElementById('auto-analyze')?.checked || true
            };

            localStorage.setItem('smart_search_settings', JSON.stringify(settings));
            logToSearch('💾 تم حفظ الإعدادات المتقدمة', 'success');
            showMessage('success', '✅ تم تطبيق الإعدادات');
        }

        function resetSettings() {
            localStorage.removeItem('smart_search_settings');
            initializeDiscoverySettings();
            showMessage('info', '🔄 تم إعادة تعيين الإعدادات');
        }

        function updatePerformanceStats() {
            const statsContainer = document.getElementById('performance-stats');
            if (!statsContainer) return;

            const report = performanceMonitor.getReport();
            statsContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                    <div><strong>ملفات مفحوصة:</strong> ${report.filesScanned}</div>
                    <div><strong>وقت المسح:</strong> ${Math.round(report.scanTime)}ms</div>
                    <div><strong>وقت التحليل:</strong> ${Math.round(report.analysisTime)}ms</div>
                    <div><strong>استخدام الذاكرة:</strong> ${report.memoryUsage}</div>
                </div>
            `;
        }

        // ===================== Initialize Enhanced System =====================
        document.addEventListener('DOMContentLoaded', async () => {
            logToSearch('🚀 نظام البحث الذكي المطور جاهز للعمل', 'success');
            logToSearch('📱 جاهز للبحث في ملفات الأندرويد', 'info');
            logToSearch('🤖 AI محلل البيانات مُفعل', 'success');
            
            // Initialize settings panel
            initializeDiscoverySettings();
            
            // Load saved data
            await loadFromSystemDatabase();
            
            // Update performance monitor
            setInterval(updatePerformanceStats, 5000);
            
            showMessage('success', '🧠 النظام الذكي المطور جاهز! ابدأ البحث لاكتشاف الملفات');
        });

        // ===================== Enhanced Error Handling =====================
        window.addEventListener('error', (event) => {
            logToSearch(`💥 خطأ نظام: ${event.error?.message || event.message}`, 'error');
            console.error('System error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            logToSearch(`💥 خطأ غير محمي: ${event.reason}`, 'error');
            console.error('Unhandled rejection:', event.reason);
        });
    </script>
</body>

</html>