<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</title>
<style>
  :root {
    --bg: #0f172a;
    --card: #111827;
    --text: #e5e7eb;
    --muted: #9ca3af;
    --accent: #22c55e;
    --accent-2: #3b82f6;
    --accent-3: #f59e0b;
    --accent-4: #8b5cf6;
    --btn-bg: #1f2937;
    --btn-hover: #374151;
    --shadow: 0 10px 25px rgba(0,0,0,.35);
    --radius: 18px;
    --danger: #ef4444;
    --danger-hover: #dc2626;
    --warning: #f59e0b;
  }
  * { box-sizing: border-box; }
  html, body {
    margin: 0; padding: 0; background: var(--bg); color: var(--text);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", Arial, sans-serif;
    line-height: 1.6;
  }
  .wrap { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
  .card {
    width: min(1200px, 96vw); background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    border: 1px solid rgba(255,255,255,.08);
    border-radius: var(--radius); padding: 28px; box-shadow: var(--shadow);
    backdrop-filter: blur(6px);
  }
  h1 { margin: 0 0 10px; font-size: clamp(26px, 3.5vw, 40px); letter-spacing: .2px; }
  p.lead { margin: 0 0 26px; color: var(--muted); }
  
  a.btn, button.btn {
    display: inline-block; text-decoration: none; text-align: center; cursor: pointer;
    background: var(--btn-bg); color: var(--text); padding: 14px 16px;
    border-radius: 14px; border: 1px solid rgba(255,255,255,.08);
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
    box-shadow: 0 6px 14px rgba(0,0,0,.25);
    font-family: inherit; font-size: inherit; margin: 4px;
  }
  a.btn:hover, button.btn:hover { background: var(--btn-hover); transform: translateY(-1px); }
  a.btn.primary, button.btn.primary { background: var(--accent-2); border-color: transparent; color: #fff; }
  .btn.success { background: var(--accent); border-color: transparent; color: #fff; }
  .btn.danger { background: var(--danger); border-color: transparent; color: #fff; }
  .btn.danger:hover { background: var(--danger-hover); }
  .btn.warning { background: var(--warning); border-color: transparent; color: #fff; }
  .btn.purple { background: var(--accent-4); border-color: transparent; color: #fff; }
  
  .files-section { margin: 24px 0; }
  
  .stats-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
    padding: 20px;
    background: rgba(255,255,255,.02);
    border-radius: var(--radius);
  }
  
  .stat-item {
    text-align: center;
    padding: 12px;
    background: rgba(255,255,255,.02);
    border-radius: 12px;
  }
  
  .stat-number {
    font-size: 28px;
    font-weight: bold;
    color: var(--accent-2);
    margin-bottom: 4px;
  }
  
  .stat-label {
    font-size: 12px;
    color: var(--muted);
  }
  
  .search-bar {
    margin-bottom: 20px;
    position: relative;
  }
  
  .search-input {
    width: 100%;
    padding: 14px 20px 14px 50px;
    background: var(--btn-bg);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 12px;
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
  }
  
  .search-input:focus {
    outline: none;
    border-color: var(--accent-2);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, .1);
  }

  .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 16px;
  }
  
  .filter-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .filter-tab {
    padding: 10px 16px;
    background: var(--btn-bg);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 20px;
    cursor: pointer;
    transition: all .2s ease;
    font-size: 13px;
    font-weight: 500;
  }
  
  .filter-tab.active {
    background: var(--accent-2);
    border-color: var(--accent-2);
    color: #fff;
  }
  
  .filter-tab:hover {
    background: var(--btn-hover);
  }
  
  .files-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 18px;
  }
  
  .file-card {
    background: rgba(255,255,255,.02);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: var(--radius);
    padding: 18px;
    transition: all .2s ease;
  }
  
  .file-card:hover {
    background: rgba(255,255,255,.04);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }
  
  .file-card.highlighted {
    border: 2px solid var(--accent);
    background: rgba(34, 197, 94, .05);
  }

  .file-card.processing {
    border: 2px solid var(--warning);
    background: rgba(245, 158, 11, .05);
  }
  
  .file-header {
    display: flex;
    align-items: center;
    margin-bottom: 14px;
  }
  
  .file-icon {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-left: 14px;
    flex-shrink: 0;
  }
  
  .file-icon.image { background: linear-gradient(45deg, #10b981, #059669); }
  .file-icon.document { background: linear-gradient(45deg, #3b82f6, #1d4ed8); }
  .file-icon.text { background: linear-gradient(45deg, #22c55e, #16a34a); }
  .file-icon.json { background: linear-gradient(45deg, #f59e0b, #d97706); }
  .file-icon.audio { background: linear-gradient(45deg, #8b5cf6, #7c3aed); }
  .file-icon.video { background: linear-gradient(45deg, #ef4444, #dc2626); }
  .file-icon.archive { background: linear-gradient(45deg, #f59e0b, #d97706); }
  .file-icon.other { background: linear-gradient(45deg, #6b7280, #4b5563); }
  
  .file-info {
    flex: 1;
    min-width: 0;
  }
  
  .file-name {
    font-weight: 600;
    color: var(--text);
    margin-bottom: 6px;
    word-break: break-word;
    line-height: 1.3;
  }
  
  .file-meta {
    font-size: 12px;
    color: var(--muted);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .file-type-badge {
    display: inline-block;
    padding: 2px 6px;
    background: rgba(59, 130, 246, .2);
    color: var(--accent-2);
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .ready-badge {
    background: rgba(34, 197, 94, .2);
    color: var(--accent);
  }

  .processing-badge {
    background: rgba(245, 158, 11, .2);
    color: var(--warning);
  }
  
  .file-preview {
    margin: 14px 0;
    text-align: center;
  }
  
  .file-preview img {
    max-width: 100%;
    max-height: 120px;
    border-radius: 8px;
    object-fit: cover;
  }

  .content-preview {
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
    padding: 12px;
    margin: 12px 0;
    font-family: 'Courier New', monospace;
    font-size: 11px;
    max-height: 100px;
    overflow-y: auto;
    color: var(--muted);
    white-space: pre-wrap;
    word-break: break-word;
  }

  .messages-count {
    background: var(--accent);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    margin-top: 8px;
    display: inline-block;
  }
  
  .file-actions {
    display: flex;
    gap: 8px;
    margin-top: 14px;
    flex-wrap: wrap;
  }
  
  .btn-small {
    padding: 8px 12px;
    font-size: 12px;
    flex: 1;
    min-width: 80px;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  
  .empty-icon {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.5;
  }
  
  .status-message {
    margin: 16px 0;
    padding: 14px 18px;
    border-radius: 12px;
    text-align: center;
    font-weight: 500;
  }
  
  .status-success {
    background: rgba(34, 197, 94, .1);
    color: var(--accent);
    border: 1px solid rgba(34, 197, 94, .2);
  }
  
  .status-error {
    background: rgba(239, 68, 68, .1);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, .2);
  }
  
  .status-info {
    background: rgba(59, 130, 246, .1);
    color: var(--accent-2);
    border: 1px solid rgba(59, 130, 246, .2);
  }

  .status-warning {
    background: rgba(245, 158, 11, .1);
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, .2);
  }
  
  .hidden { display: none; }
  
  footer { 
    margin-top: 24px; 
    color: var(--muted); 
    font-size: 13px; 
    text-align: center;
    padding: 16px;
    background: rgba(255,255,255,.02);
    border-radius: var(--radius);
  }

  .progress-bar {
    width: 100%;
    height: 6px;
    background: rgba(255,255,255,.1);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 8px;
  }

  .progress-fill {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.3s ease;
  }

  .bulk-actions {
    background: rgba(255,255,255,.02);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
  }

  .action-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  @media (max-width: 768px) {
    .stats-bar {
      grid-template-columns: repeat(2, 1fr);
    }
    .file-actions {
      flex-direction: column;
    }
    .bulk-actions {
      flex-direction: column;
      align-items: stretch;
    }
  }
</style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1><span style="font-size: 24px;">ğŸ“</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h1>
      <p class="lead">Ù†Ø¸Ø§Ù… Ù…Ø­Ø³Ù† Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© - Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</p>
      
      <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø³Ù† -->
      <div class="stats-bar">
        <div class="stat-item">
          <div class="stat-number" id="total-files">0</div>
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="total-size">0</div>
          <div class="stat-label">Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="ready-files">0</div>
          <div class="stat-label">Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="messages-count">0</div>
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="requests-count">0</div>
          <div class="stat-label">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="offers-count">0</div>
          <div class="stat-label">Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ÙƒØªØ´ÙØ©</div>
        </div>
      </div>
      
      <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„Ø© -->
      <div id="status-message" class="hidden"></div>
      
      <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù† -->
      <div class="search-bar">
        <div class="search-icon">ğŸ”</div>
        <input 
          type="text" 
          class="search-input" 
          id="search-input" 
          placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø­ØªÙˆÙ‰..."
          oninput="searchFiles()"
        />
      </div>
      
      <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø­Ø³Ù†Ø© -->
      <div class="filter-tabs">
        <div class="filter-tab active" onclick="filterFiles('all', this)">ğŸ“‚ Ø§Ù„ÙƒÙ„</div>
        <div class="filter-tab" onclick="filterFiles('ready', this)">âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</div>
        <div class="filter-tab" onclick="filterFiles('json', this)">ğŸ“‹ Ù…Ù„ÙØ§Øª JSON</div>
        <div class="filter-tab" onclick="filterFiles('text', this)">ğŸ“„ Ù…Ù„ÙØ§Øª Ù†ØµÙŠØ©</div>
        <div class="filter-tab" onclick="filterFiles('archive', this)">ğŸ“¦ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</div>
        <div class="filter-tab" onclick="filterFiles('image', this)">ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ±</div>
        <div class="filter-tab" onclick="filterFiles('other', this)">ğŸ“ Ø£Ø®Ø±Ù‰</div>
      </div>
      
      <!-- Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© -->
      <div class="bulk-actions">
        <h3 style="margin: 0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
        <div class="action-group">
          <button class="btn btn-small" onclick="refreshFiles()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
          <button class="btn success btn-small" onclick="selectAll()">âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
          <button class="btn warning btn-small" onclick="processAllArchives()">ğŸ“¦ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
          <button class="btn success btn-small" onclick="saveAllExtracted()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬</button>
          <button class="btn purple btn-small" onclick="analyzeAllFiles()">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„</button>
          <button class="btn danger btn-small" onclick="deleteSelected()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        </div>
      </div>
      
      <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ù„ÙØ§Øª -->
      <div class="files-section">
        <div id="files-container" class="files-grid">
          <!-- Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ -->
        </div>
      </div>
      
      <a class="btn primary" href="page3.html">ğŸš€ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</a>
      <a class="btn" href="index.html">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      
      <footer>
        <p><strong>ğŸ¯ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…:</strong> ØªÙ… ØªØ­Ø³ÙŠÙ†Ù‡ Ù„Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</p>
        <p><strong>ğŸ“Š Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:</strong> ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ â€¢ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ â€¢ ØªØµÙ†ÙŠÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶ â€¢ ØªØ­Ø³ÙŠÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
      </footer>
    </div>
  </div>

  <script>
    // ===============================================================================
    // ENHANCED FILE MANAGEMENT SYSTEM - OPTIMIZED FOR REAL ESTATE MATCHING
    // ===============================================================================

    // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù…Ø­Ø³Ù†Ø©
    const DB_NAME = 'FilesStorage';
    const DB_VERSION = 1;
    const STORE_NAME = 'files';
    
    let db;
    let allFiles = [];
    let filteredFiles = [];
    let currentFilter = 'all';
    let selectedFiles = new Set();
    let extractedFilesCache = {}; // Cache Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©
    let analysisResults = {}; // Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„

    // ===============================================================================
    // DATABASE INITIALIZATION - SAME AS FINAL SYSTEM
    // ===============================================================================
    
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            store.createIndex('name', 'name', { unique: false });
            store.createIndex('uploadTime', 'uploadTime', { unique: false });
          }
        };
      });
    }
    
    // ===============================================================================
    // FILE OPERATIONS - ENHANCED FOR REAL ESTATE DATA
    // ===============================================================================
    
    function getAllFiles() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    function saveFile(fileData) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.put(fileData);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }
    
    function deleteFile(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // ===============================================================================
    // ENHANCED FILE TYPE DETECTION FOR REAL ESTATE SYSTEM
    // ===============================================================================
    
    function getFileType(mimeType, fileName) {
      const lowerFileName = fileName ? fileName.toLowerCase() : '';
      
      // ØªØ­Ø¯ÙŠØ¯ Ø£Ù†ÙˆØ§Ø¹ Ù…Ø­Ø³Ù† Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ
      if (lowerFileName.endsWith('.json')) return 'json';
      if (lowerFileName.endsWith('.txt')) return 'text';
      
      const archiveExtensions = ['.zip', '.rar', '.7z', '.tar', '.gz', '.bz2'];
      if (archiveExtensions.some(ext => lowerFileName.endsWith(ext))) {
        return 'archive';
      }
      
      if (mimeType) {
        if (mimeType.startsWith('image/')) return 'image';
        if (mimeType.startsWith('video/')) return 'video';
        if (mimeType.startsWith('audio/')) return 'audio';
        if (mimeType.includes('json')) return 'json';
        if (mimeType.includes('text')) return 'text';
        if (mimeType.includes('pdf') || mimeType.includes('document') || mimeType.includes('sheet') || mimeType.includes('presentation')) return 'document';
        if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('archive') || mimeType.includes('compressed')) return 'archive';
      }
      
      return 'other';
    }
    
    function getFileIcon(type) {
      const icons = {
        json: 'ğŸ“‹',
        text: 'ğŸ“„',
        image: 'ğŸ–¼ï¸',
        video: 'ğŸ¬',
        audio: 'ğŸµ',
        document: 'ğŸ“„',
        archive: 'ğŸ“¦',
        other: 'ğŸ“'
      };
      return icons[type] || 'ğŸ“';
    }

    // ===============================================================================
    // CONTENT ANALYSIS - KEY FOR REAL ESTATE MATCHING
    // ===============================================================================

    async function analyzeFileContent(file) {
      try {
        if (!file.data) return null;

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        let textContent = '';
        if (file.data.includes(',')) {
          const base64 = file.data.split(',')[1];
          if (base64) {
            textContent = decodeURIComponent(escape(atob(base64)));
          }
        }

        if (!textContent) return null;

        const analysis = {
          hasContent: true,
          contentLength: textContent.length,
          messagesCount: 0,
          requestsCount: 0,
          offersCount: 0,
          phonesCount: 0,
          pricesCount: 0,
          isReadyForMatching: false,
          contentPreview: textContent.substring(0, 200),
          extractedData: null
        };

        // ØªØ­Ù„ÙŠÙ„ Ù…Ù„ÙØ§Øª JSON
        if (file.name.toLowerCase().endsWith('.json')) {
          try {
            const jsonData = JSON.parse(textContent);
            
            if (jsonData.messages && Array.isArray(jsonData.messages)) {
              analysis.messagesCount = jsonData.messages.length;
              analysis.extractedData = jsonData;
              
              // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
              jsonData.messages.forEach(message => {
                if (message.original_text) {
                  const messageText = message.original_text.toLowerCase();
                  
                  // ÙƒØ´Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                  const requestKeywords = ['Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ø¨Ø­Ø« Ø¹Ù†', 'Ø£Ø±ÙŠØ¯', 'Ù†Ø±ÙŠØ¯', 'Ù…Ø­ØªØ§Ø¬', 'Ø¨Ø­Ø« Ø¹Ù†', 'Ø¹Ø§ÙˆØ²', 'Ø¹Ø§ÙŠØ²', 'Ø§Ø¯ÙˆØ± Ø¹Ù„Ù‰', 'Ø£Ø¯ÙˆØ± Ø¹Ù„Ù‰', 'Ù†Ø¨Ø­Ø« Ø¹Ù†', 'wanted', 'looking for', 'need', 'require'];
                  if (requestKeywords.some(keyword => messageText.includes(keyword))) {
                    analysis.requestsCount++;
                  }
                  
                  // ÙƒØ´Ù Ø§Ù„Ø¹Ø±ÙˆØ¶
                  const offerKeywords = ['Ù„Ù„Ø¨ÙŠØ¹', 'Ù„Ù„Ø§ÙŠØ¬Ø§Ø±', 'Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±', 'Ù…Ø¹Ø±ÙˆØ¶', 'Ù…ØªÙˆÙØ±', 'ÙŠÙˆØ¬Ø¯', 'Ø¹Ù†Ø¯ÙŠ', 'Ù„Ø¯ÙŠ', 'Ù…ØªØ§Ø­', 'Ù„Ù„ØªÙ†Ø§Ø²Ù„', 'Ø£Ø¹Ø±Ø¶', 'for sale', 'for rent', 'available', 'offering'];
                  if (offerKeywords.some(keyword => messageText.includes(keyword))) {
                    analysis.offersCount++;
                  }
                }

                // Ø¹Ø¯ Ø§Ù„Ù‡ÙˆØ§ØªÙ ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±
                if (message.phones && Array.isArray(message.phones)) {
                  analysis.phonesCount += message.phones.length;
                }
                if (message.prices && Array.isArray(message.prices)) {
                  analysis.pricesCount += message.prices.length;
                }
              });

              // ØªØ­Ø¯ÙŠØ¯ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
              analysis.isReadyForMatching = analysis.messagesCount > 0 && (analysis.requestsCount > 0 || analysis.offersCount > 0);
            }
          } catch (e) {
            console.warn('ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ JSON:', e);
          }
        } 
        // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†ØµÙŠØ©
        else if (file.name.toLowerCase().endsWith('.txt')) {
          // ØªØµÙ†ÙŠÙ Ø¨Ø³ÙŠØ· Ù„Ù„Ù†ØµÙˆØµ
          const textLower = textContent.toLowerCase();
          const requestKeywords = ['Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ø¨Ø­Ø« Ø¹Ù†', 'Ø£Ø±ÙŠØ¯', 'Ù†Ø±ÙŠØ¯', 'Ù…Ø­ØªØ§Ø¬'];
          const offerKeywords = ['Ù„Ù„Ø¨ÙŠØ¹', 'Ù„Ù„Ø§ÙŠØ¬Ø§Ø±', 'Ù…Ø¹Ø±ÙˆØ¶', 'Ù…ØªÙˆÙØ±', 'ÙŠÙˆØ¬Ø¯'];
          
          if (requestKeywords.some(keyword => textLower.includes(keyword))) {
            analysis.requestsCount = 1;
          }
          if (offerKeywords.some(keyword => textLower.includes(keyword))) {
            analysis.offersCount = 1;
          }
          
          // ÙƒØ´Ù Ø§Ù„Ù‡ÙˆØ§ØªÙ ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨Ø³ÙŠØ·
          const phoneMatches = textContent.match(/\d{10,}/g);
          const priceMatches = textContent.match(/\d+[\d,\s]*\s*(Ø±ÙŠØ§Ù„|Ø±Ø³|SR|SAR)/gi);
          
          analysis.phonesCount = phoneMatches ? phoneMatches.length : 0;
          analysis.pricesCount = priceMatches ? priceMatches.length : 0;
          analysis.isReadyForMatching = analysis.requestsCount > 0 || analysis.offersCount > 0;
        }

        return analysis;

      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰:', error);
        return null;
      }
    }

    // ===============================================================================
    // ARCHIVE PROCESSING - ENHANCED
    // ===============================================================================
    
    async function loadJSZip() {
      return new Promise((resolve, reject) => {
        if (typeof JSZip !== 'undefined') {
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        script.onload = () => {
          console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ JSZip Ø¨Ù†Ø¬Ø§Ø­');
          resolve();
        };
        script.onerror = () => {
          console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ JSZip');
          reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© ÙÙƒ Ø§Ù„Ø¶ØºØ·'));
        };
        document.head.appendChild(script);
      });
    }
    
    async function extractArchive(fileId) {
      try {
        if (typeof JSZip === 'undefined') {
          showMessage('â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© ÙÙƒ Ø§Ù„Ø¶ØºØ·...', 'info');
          await loadJSZip();
        }
        
        const file = allFiles.find(f => f.id === fileId);
        if (!file) {
          showMessage('âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
          return;
        }
        
        showMessage('ğŸ“¦ Ø¬Ø§Ø±ÙŠ ÙÙƒ Ø¶ØºØ· Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...', 'info');
        
        // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        const card = document.querySelector(`[data-file-id="${fileId}"]`);
        if (card) {
          card.classList.add('processing');
        }
        
        const base64Data = file.data.split(',')[1] || file.data;
        const zip = await JSZip.loadAsync(base64Data, { base64: true });
        
        const extractedFiles = [];
        let processedCount = 0;
        const totalFiles = Object.keys(zip.files).filter(name => !zip.files[name].dir).length;
        
        for (const [filename, fileObj] of Object.entries(zip.files)) {
          if (!fileObj.dir) {
            try {
              const content = await fileObj.async('text');
              
              // ØªØ­Ù„ÙŠÙ„ ÙÙˆØ±ÙŠ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬
              const fileInfo = {
                name: filename,
                content: content,
                size: content.length,
                isTextFile: filename.toLowerCase().endsWith('.txt') || filename.toLowerCase().endsWith('.json'),
                analysisData: null
              };

              // ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
              if (fileInfo.isTextFile) {
                fileInfo.analysisData = await analyzeExtractedContent(content, filename);
              }
              
              extractedFiles.push(fileInfo);
              processedCount++;
              
              // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
              updateProgressBar((processedCount / totalFiles) * 100);
              
            } catch (e) {
              console.warn(`âš ï¸ ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„Ù ÙƒÙ†Øµ: ${filename}`, e.message);
              try {
                const binaryContent = await fileObj.async('uint8array');
                extractedFiles.push({
                  name: filename,
                  content: `[Ù…Ù„Ù Ø«Ù†Ø§Ø¦ÙŠ - ${binaryContent.length} Ø¨Ø§ÙŠØª]`,
                  size: binaryContent.length,
                  isBinary: true,
                  isTextFile: false,
                  analysisData: null
                });
                processedCount++;
                updateProgressBar((processedCount / totalFiles) * 100);
              } catch (e2) {
                console.error(`âŒ ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬: ${filename}`, e2.message);
              }
            }
          }
        }
        
        if (extractedFiles.length === 0) {
          showMessage('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ', 'error');
          return;
        }
        
        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´ Ù…Ø¹ ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„
        extractedFilesCache[fileId] = extractedFiles;
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        displayExtractedFiles(file, extractedFiles);
        
        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„
        const textFilesCount = extractedFiles.filter(f => f.isTextFile).length;
        const totalMessages = extractedFiles.reduce((sum, f) => 
          sum + (f.analysisData?.messagesCount || 0), 0);
        
        showMessage(`âœ… ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${extractedFiles.length} Ù…Ù„Ù (${textFilesCount} Ù…Ù„Ù Ù†ØµÙŠØŒ ${totalMessages} Ø±Ø³Ø§Ù„Ø©)`, 'success');
        
        // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        if (card) {
          card.classList.remove('processing');
          card.classList.add('highlighted');
          setTimeout(() => card.classList.remove('highlighted'), 3000);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        await updateStats();
        
      } catch (error) {
        console.error('ğŸ’¥ Ø®Ø·Ø£ ÙÙŠ ÙÙƒ Ø§Ù„Ø¶ØºØ·:', error);
        showMessage(`âŒ ÙØ´Ù„ ÙÙŠ ÙÙƒ Ø¶ØºØ· Ø§Ù„Ù…Ù„Ù: ${error.message}`, 'error');
        
        const card = document.querySelector(`[data-file-id="${fileId}"]`);
        if (card) {
          card.classList.remove('processing');
        }
      }
    }

    // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬
    async function analyzeExtractedContent(content, filename) {
      try {
        const analysis = {
          messagesCount: 0,
          requestsCount: 0,
          offersCount: 0,
          phonesCount: 0,
          pricesCount: 0,
          isReadyForMatching: false
        };

        if (filename.toLowerCase().endsWith('.json')) {
          try {
            const jsonData = JSON.parse(content);
            if (jsonData.messages && Array.isArray(jsonData.messages)) {
              analysis.messagesCount = jsonData.messages.length;
              
              jsonData.messages.forEach(message => {
                if (message.original_text) {
                  const messageText = message.original_text.toLowerCase();
                  
                  const requestKeywords = ['Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ø¨Ø­Ø« Ø¹Ù†', 'Ø£Ø±ÙŠØ¯', 'Ù†Ø±ÙŠØ¯', 'Ù…Ø­ØªØ§Ø¬', 'Ø¨Ø­Ø« Ø¹Ù†', 'Ø¹Ø§ÙˆØ²', 'Ø¹Ø§ÙŠØ²', 'Ø§Ø¯ÙˆØ± Ø¹Ù„Ù‰', 'Ø£Ø¯ÙˆØ± Ø¹Ù„Ù‰', 'Ù†Ø¨Ø­Ø« Ø¹Ù†', 'wanted', 'looking for', 'need', 'require'];
                  if (requestKeywords.some(keyword => messageText.includes(keyword))) {
                    analysis.requestsCount++;
                  }
                  
                  const offerKeywords = ['Ù„Ù„Ø¨ÙŠØ¹', 'Ù„Ù„Ø§ÙŠØ¬Ø§Ø±', 'Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±', 'Ù…Ø¹Ø±ÙˆØ¶', 'Ù…ØªÙˆÙØ±', 'ÙŠÙˆØ¬Ø¯', 'Ø¹Ù†Ø¯ÙŠ', 'Ù„Ø¯ÙŠ', 'Ù…ØªØ§Ø­', 'Ù„Ù„ØªÙ†Ø§Ø²Ù„', 'Ø£Ø¹Ø±Ø¶', 'for sale', 'for rent', 'available', 'offering'];
                  if (offerKeywords.some(keyword => messageText.includes(keyword))) {
                    analysis.offersCount++;
                  }
                }

                if (message.phones && Array.isArray(message.phones)) {
                  analysis.phonesCount += message.phones.length;
                }
                if (message.prices && Array.isArray(message.prices)) {
                  analysis.pricesCount += message.prices.length;
                }
              });

              analysis.isReadyForMatching = analysis.messagesCount > 0 && (analysis.requestsCount > 0 || analysis.offersCount > 0);
            }
          } catch (e) {
            console.warn('ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ JSON Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬:', e);
          }
        } else if (filename.toLowerCase().endsWith('.txt')) {
          const textLower = content.toLowerCase();
          const requestKeywords = ['Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ø¨Ø­Ø« Ø¹Ù†', 'Ø£Ø±ÙŠØ¯', 'Ù†Ø±ÙŠØ¯', 'Ù…Ø­ØªØ§Ø¬'];
          const offerKeywords = ['Ù„Ù„Ø¨ÙŠØ¹', 'Ù„Ù„Ø§ÙŠØ¬Ø§Ø±', 'Ù…Ø¹Ø±ÙˆØ¶', 'Ù…ØªÙˆÙØ±', 'ÙŠÙˆØ¬Ø¯'];
          
          if (requestKeywords.some(keyword => textLower.includes(keyword))) {
            analysis.requestsCount = 1;
          }
          if (offerKeywords.some(keyword => textLower.includes(keyword))) {
            analysis.offersCount = 1;
          }
          
          const phoneMatches = content.match(/\d{10,}/g);
          const priceMatches = content.match(/\d+[\d,\s]*\s*(Ø±ÙŠØ§Ù„|Ø±Ø³|SR|SAR)/gi);
          
          analysis.phonesCount = phoneMatches ? phoneMatches.length : 0;
          analysis.pricesCount = priceMatches ? priceMatches.length : 0;
          analysis.isReadyForMatching = analysis.requestsCount > 0 || analysis.offersCount > 0;
        }

        return analysis;
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬:', error);
        return null;
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    function updateProgressBar(percentage) {
      let progressBar = document.getElementById('extraction-progress');
      if (!progressBar) {
        const statusDiv = document.getElementById('status-message');
        if (statusDiv && !statusDiv.classList.contains('hidden')) {
          const progressHTML = `
            <div class="progress-bar" id="extraction-progress-container">
              <div class="progress-fill" id="extraction-progress"></div>
            </div>
          `;
          statusDiv.innerHTML += progressHTML;
          progressBar = document.getElementById('extraction-progress');
        }
      }
      
      if (progressBar) {
        progressBar.style.width = percentage + '%';
        if (percentage >= 100) {
          setTimeout(() => {
            const container = document.getElementById('extraction-progress-container');
            if (container) container.remove();
          }, 2000);
        }
      }
    }
    
    // ===============================================================================
    // ENHANCED DISPLAY FUNCTIONS
    // ===============================================================================
    
    function displayExtractedFiles(archiveFile, extractedFiles) {
      const archiveCard = document.querySelector(`[data-file-id="${archiveFile.id}"]`);
      if (!archiveCard) return;
      
      let contentDiv = archiveCard.querySelector('.archive-content');
      if (contentDiv) {
        contentDiv.remove();
      }
      
      contentDiv = document.createElement('div');
      contentDiv.className = 'archive-content';
      contentDiv.style.cssText = 'margin-top: 16px; border-top: 1px solid rgba(255,255,255,.1); padding-top: 16px;';

      // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©
      const textFiles = extractedFiles.filter(f => f.isTextFile);
      const totalMessages = extractedFiles.reduce((sum, f) => sum + (f.analysisData?.messagesCount || 0), 0);
      const readyFiles = extractedFiles.filter(f => f.analysisData?.isReadyForMatching);

      const statsDiv = document.createElement('div');
      statsDiv.innerHTML = `
        <div style="display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
          <span class="file-type-badge">${extractedFiles.length} Ù…Ù„Ù</span>
          <span class="file-type-badge ready-badge">${textFiles.length} Ù†ØµÙŠ</span>
          <span class="file-type-badge ready-badge">${totalMessages} Ø±Ø³Ø§Ù„Ø©</span>
          <span class="file-type-badge ready-badge">${readyFiles.length} Ø¬Ø§Ù‡Ø²</span>
        </div>
      `;
      contentDiv.appendChild(statsDiv);

      extractedFiles.forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; font-size: 12px; padding: 8px; margin: 4px 0; background: rgba(255,255,255,0.02); border-radius: 6px;';
        
        let statusBadge = '';
        if (file.analysisData?.isReadyForMatching) {
          statusBadge = '<span class="file-type-badge ready-badge">Ø¬Ø§Ù‡Ø²</span>';
        } else if (file.isTextFile) {
          statusBadge = '<span class="file-type-badge processing-badge">Ù†ØµÙŠ</span>';
        }

        let analysisInfo = '';
        if (file.analysisData) {
          const msgs = file.analysisData.messagesCount || 0;
          const reqs = file.analysisData.requestsCount || 0;
          const offs = file.analysisData.offersCount || 0;
          if (msgs > 0) {
            analysisInfo = `<br><small style="color: var(--muted);">ğŸ“Š ${msgs} Ø±Ø³Ø§Ù„Ø©ØŒ ${reqs} Ø·Ù„Ø¨ØŒ ${offs} Ø¹Ø±Ø¶</small>`;
          }
        }
        
        fileDiv.innerHTML = `
          <div style="flex: 1; word-break: break-all;">
            ğŸ“„ ${file.name} (${formatFileSize(file.size)}) ${statusBadge}
            ${analysisInfo}
          </div>
          <div style="display: flex; gap: 4px; flex-shrink: 0;">
            <button class="btn btn-small" style="padding: 4px 8px;" onclick="saveExtractedFile('${archiveFile.id}', '${encodeURIComponent(file.name)}')">ğŸ’¾</button>
            <button class="btn btn-small" style="padding: 4px 8px; background: var(--accent);" onclick="viewExtractedFile('${archiveFile.id}', '${encodeURIComponent(file.name)}')">ğŸ‘ï¸</button>
          </div>
        `;
        
        contentDiv.appendChild(fileDiv);
      });
      
      archiveCard.appendChild(contentDiv);
    }
    
    // ===============================================================================
    // ENHANCED SAVE FUNCTIONALITY
    // ===============================================================================
    
    async function saveExtractedFile(archiveId, encodedFileName) {
      try {
        const fileName = decodeURIComponent(encodedFileName);
        const extractedFiles = extractedFilesCache[archiveId];
        if (!extractedFiles) {
          throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©');
        }
        
        const file = extractedFiles.find(f => f.name === fileName);
        if (!file) {
          throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ø¯');
        }
        
        let mimeType = 'text/plain';
        if (fileName.toLowerCase().endsWith('.json')) mimeType = 'application/json';
        
        const base64Content = btoa(unescape(encodeURIComponent(file.content)));
        const dataUrl = `data:${mimeType};charset=utf-8;base64,${base64Content}`;
        
        const timestamp = Date.now();
        const newFileData = {
          id: `${timestamp}_${Math.random().toString(36).substr(2, 9)}`,
          name: `extracted_${fileName}`,
          size: new Blob([file.content]).size,
          type: mimeType,
          data: dataUrl,
          uploadTime: new Date().toLocaleString('ar-SA'),
          timestamp: timestamp,
        };
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©
        if (file.analysisData) {
          newFileData.analysisData = file.analysisData;
        }
        
        await saveFile(newFileData);
        await refreshFiles();
        
        showMessage(`âœ… ØªÙ… Ø­ÙØ¸ ${fileName} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
        setTimeout(() => {
          const newFileCard = document.querySelector(`[data-file-id="${newFileData.id}"]`);
          if (newFileCard) {
            newFileCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            newFileCard.classList.add('highlighted');
            setTimeout(() => newFileCard.classList.remove('highlighted'), 3000);
          }
        }, 500);
        
      } catch (error) {
        console.error('ğŸ’¥ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù:', error);
        showMessage(`âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù: ${error.message}`, 'error');
      }
    }

    // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ø§Ù„Ù…Ø­Ø³Ù†
    async function saveAllExtracted() {
        if (!extractedFilesCache || Object.keys(extractedFilesCache).length === 0) {
            showMessage('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù„Ø­ÙØ¸Ù‡Ø§. Ù‚Ù… Ø¨ÙÙƒ Ø¶ØºØ· Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹.', 'error');
            return;
        }

        showMessage('ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©...', 'info');
        let savedCount = 0;
        let readyFilesCount = 0;
        
        try {
            for (const archiveId in extractedFilesCache) {
                const filesToSave = extractedFilesCache[archiveId];
                for (const file of filesToSave) {
                    await saveExtractedFile(archiveId, encodeURIComponent(file.name));
                    savedCount++;
                    
                    if (file.analysisData?.isReadyForMatching) {
                        readyFilesCount++;
                    }
                }
            }
            showMessage(`âœ… ØªÙ… Ø­ÙØ¸ ${savedCount} Ù…Ù„Ù (${readyFilesCount} Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©)`, 'success');
        } catch(error) {
            showMessage(`âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª: ${error.message}`, 'error');
        }
    }

    // ===============================================================================
    // BULK OPERATIONS - NEW FEATURES
    // ===============================================================================

    async function processAllArchives() {
      const zipFiles = allFiles.filter(file => getFileType(file.type, file.name) === 'archive');
      
      if (zipFiles.length === 0) {
        showMessage('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø¶ØºÙˆØ·Ø© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', 'error');
        return;
      }
      
      showMessage(`ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© ${zipFiles.length} Ù…Ù„Ù Ù…Ø¶ØºÙˆØ·...`, 'info');
      
      for (let i = 0; i < zipFiles.length; i++) {
        const file = zipFiles[i];
        showMessage(`ğŸ“¦ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù ${i + 1}/${zipFiles.length}: ${file.name}`, 'info');
        await extractArchive(file.id);
        
        // ØªÙˆÙ‚Ù Ù‚ØµÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ù…Ù„ÙØ§Øª
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      showMessage(`âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø©`, 'success');
    }

    async function analyzeAllFiles() {
      showMessage('ğŸ” Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª...', 'info');
      
      let analyzed = 0;
      let readyFiles = 0;
      let totalMessages = 0;
      let totalRequests = 0;
      let totalOffers = 0;
      
      for (const file of allFiles) {
        const analysis = await analyzeFileContent(file);
        if (analysis) {
          analysisResults[file.id] = analysis;
          analyzed++;
          
          if (analysis.isReadyForMatching) readyFiles++;
          totalMessages += analysis.messagesCount || 0;
          totalRequests += analysis.requestsCount || 0;
          totalOffers += analysis.offersCount || 0;
        }
      }
      
      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ø£ÙŠØ¶Ø§Ù‹
      for (const archiveId in extractedFilesCache) {
        const extractedFiles = extractedFilesCache[archiveId];
        for (const file of extractedFiles) {
          if (file.analysisData) {
            totalMessages += file.analysisData.messagesCount || 0;
            totalRequests += file.analysisData.requestsCount || 0;
            totalOffers += file.analysisData.offersCount || 0;
            if (file.analysisData.isReadyForMatching) readyFiles++;
          }
        }
      }
      
      showMessage(`ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ù…ÙƒØªÙ…Ù„: ${analyzed} Ù…Ù„ÙØŒ ${readyFiles} Ø¬Ø§Ù‡Ø²ØŒ ${totalMessages} Ø±Ø³Ø§Ù„Ø©ØŒ ${totalRequests} Ø·Ù„Ø¨ØŒ ${totalOffers} Ø¹Ø±Ø¶`, 'success');
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      await updateStats();
      displayFiles();
    }

    // ===============================================================================
    // ENHANCED UI FUNCTIONS
    // ===============================================================================
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function showMessage(message, type) {
      const statusDiv = document.getElementById('status-message');
      statusDiv.innerHTML = message; // Ø§Ø³ØªØ®Ø¯Ø§Ù… innerHTML Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† textContent Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ HTML
      statusDiv.className = `status-message status-${type}`;
      statusDiv.classList.remove('hidden');
      
      if (type !== 'error') {
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 5000);
      }
    }
    
    async function updateStats() {
      const totalFiles = allFiles.length;
      const totalSize = allFiles.reduce((sum, file) => sum + file.size, 0);
      
      let readyFiles = 0;
      let totalMessages = 0;
      let totalRequests = 0;
      let totalOffers = 0;
      
      // Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
      for (const file of allFiles) {
        const analysis = analysisResults[file.id] || await analyzeFileContent(file);
        if (analysis) {
          if (analysis.isReadyForMatching) readyFiles++;
          totalMessages += analysis.messagesCount || 0;
          totalRequests += analysis.requestsCount || 0;
          totalOffers += analysis.offersCount || 0;
        }
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©
      for (const archiveId in extractedFilesCache) {
        const extractedFiles = extractedFilesCache[archiveId];
        for (const file of extractedFiles) {
          if (file.analysisData) {
            totalMessages += file.analysisData.messagesCount || 0;
            totalRequests += file.analysisData.requestsCount || 0;
            totalOffers += file.analysisData.offersCount || 0;
            if (file.analysisData.isReadyForMatching) readyFiles++;
          }
        }
      }
      
      document.getElementById('total-files').textContent = totalFiles;
      document.getElementById('total-size').textContent = formatFileSize(totalSize);
      document.getElementById('ready-files').textContent = readyFiles;
      document.getElementById('messages-count').textContent = totalMessages;
      document.getElementById('requests-count').textContent = totalRequests;
      document.getElementById('offers-count').textContent = totalOffers;
    }
    
    function filterFiles(type, element) {
      currentFilter = type;
      
      document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
      if (element) {
        element.classList.add('active');
      } else {
        document.querySelector(`.filter-tab[onclick*="'${type}'"]`).classList.add('active');
      }
      
      applySearchAndFilter();
    }
    
    function searchFiles() {
      applySearchAndFilter();
    }

    async function applySearchAndFilter() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        
        let tempFiles = allFiles;

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
        if (currentFilter === 'ready') {
          tempFiles = [];
          for (const file of allFiles) {
            const analysis = analysisResults[file.id] || await analyzeFileContent(file);
            if (analysis && analysis.isReadyForMatching) {
              tempFiles.push(file);
            }
          }
        } else if (currentFilter !== 'all') {
          tempFiles = tempFiles.filter(file => getFileType(file.type, file.name) === currentFilter);
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
        if (searchTerm) {
            tempFiles = tempFiles.filter(file => {
              // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
              if (file.name.toLowerCase().includes(searchTerm)) return true;
              
              // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
              const analysis = analysisResults[file.id];
              if (analysis && analysis.contentPreview) {
                return analysis.contentPreview.toLowerCase().includes(searchTerm);
              }
              
              return false;
            });
        }

        filteredFiles = tempFiles;
        displayFiles();
    }
    
    async function displayFiles() {
      const container = document.getElementById('files-container');
      
      if (filteredFiles.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-icon">ğŸ“‚</div>
            <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª</h3>
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©. Ø­Ø§ÙˆÙ„ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ± Ø£Ùˆ Ù…ØµØ·Ù„Ø­ Ø§Ù„Ø¨Ø­Ø«.</p>
            <a href="index.html" class="btn primary">Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©</a>
          </div>
        `;
        return;
      }
      
      const fileCards = await Promise.all(filteredFiles.map(async file => {
        const fileType = getFileType(file.type, file.name);
        const fileIcon = getFileIcon(fileType);
        const isSelected = selectedFiles.has(file.id);
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        let analysis = analysisResults[file.id];
        if (!analysis && (fileType === 'json' || fileType === 'text')) {
          analysis = await analyzeFileContent(file);
          if (analysis) {
            analysisResults[file.id] = analysis;
          }
        }
        
        let preview = '';
        if (fileType === 'image' && file.data) {
          preview = `<div class="file-preview"><img src="${file.data}" alt="${file.name}" onclick="viewFile('${file.id}')" loading="lazy"></div>`;
        } else if (analysis && analysis.contentPreview) {
          preview = `<div class="content-preview">${analysis.contentPreview.substring(0, 150)}...</div>`;
        }
        
        let statusBadges = '';
        if (analysis) {
          if (analysis.isReadyForMatching) {
            statusBadges += '<span class="file-type-badge ready-badge">Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</span>';
          }
          if (analysis.messagesCount > 0) {
            statusBadges += `<span class="messages-count">${analysis.messagesCount} Ø±Ø³Ø§Ù„Ø©</span>`;
          }
        }
        
        let analysisInfo = '';
        if (analysis && (analysis.requestsCount > 0 || analysis.offersCount > 0)) {
          analysisInfo = `
            <div style="margin-top: 8px; font-size: 11px; color: var(--muted);">
              ğŸ“Š ${analysis.requestsCount || 0} Ø·Ù„Ø¨ â€¢ ${analysis.offersCount || 0} Ø¹Ø±Ø¶ â€¢ ${analysis.phonesCount || 0} Ù‡Ø§ØªÙ
            </div>
          `;
        }
        
        let archiveButton = '';
        if (fileType === 'archive') {
            archiveButton = `<button class="btn btn-small" onclick="extractArchive('${file.id}')">ğŸ“¦ ÙÙƒ Ø§Ù„Ø¶ØºØ·</button>`;
        }

        const cardClass = analysis?.isReadyForMatching ? 'file-card highlighted' : 'file-card';

        return `
          <div class="${cardClass}" data-file-id="${file.id}" style="border: ${isSelected ? '2px solid var(--accent-2)' : '1px solid rgba(255,255,255,.08)'};">
            <div class="file-header">
              <div class="file-icon ${fileType}">${fileIcon}</div>
              <div class="file-info">
                <div class="file-name" title="${file.name}">${file.name}</div>
                <div class="file-meta">
                  ${formatFileSize(file.size)} â€¢ ${file.uploadTime}
                  <span class="file-type-badge">${fileType.toUpperCase()}</span>
                  ${statusBadges}
                </div>
              </div>
              <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleFileSelection('${file.id}', this)" style="margin-right: 8px; width: 20px; height: 20px; cursor: pointer;">
            </div>
            ${preview}
            ${analysisInfo}
            <div class="file-actions">
              <button class="btn btn-small" onclick="downloadFile('${file.id}')">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</button>
              <button class="btn btn-small" onclick="viewFile('${file.id}')">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
              ${archiveButton}
              <button class="btn danger btn-small" onclick="deleteFileConfirm('${file.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>
          </div>
        `;
      }));
      
      container.innerHTML = fileCards.join('');
    }

    // ===============================================================================
    // REMAINING UTILITY FUNCTIONS
    // ===============================================================================
    
    function toggleFileSelection(fileId, checkbox) {
      const card = checkbox.closest('.file-card');
      if (checkbox.checked) {
        selectedFiles.add(fileId);
        card.style.border = '2px solid var(--accent-2)';
      } else {
        selectedFiles.delete(fileId);
        card.style.border = '1px solid rgba(255,255,255,.08)';
      }
    }
    
    function selectAll() {
      const allVisibleSelected = filteredFiles.every(file => selectedFiles.has(file.id));
      
      filteredFiles.forEach(file => {
        if (allVisibleSelected) {
          selectedFiles.delete(file.id);
        } else {
          selectedFiles.add(file.id);
        }
      });
      displayFiles();
    }
    
    function downloadFile(fileId) {
      const file = allFiles.find(f => f.id === fileId);
      if (!file) {
        showMessage('âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
        return;
      }
      
      const a = document.createElement('a');
      a.href = file.data;
      a.download = file.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      showMessage(`â¬‡ï¸ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${file.name}`, 'success');
    }
    
    function viewFile(fileId) {
      const file = allFiles.find(f => f.id === fileId);
      if (!file) {
        showMessage('âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
        return;
      }
      
      const newWindow = window.open();
      const fileType = getFileType(file.type, file.name);
      
      if (fileType === 'image') {
        newWindow.document.write(`
          <body style="margin:0; background:#000; display:flex; justify-content:center; align-items:center; min-height:100vh;">
            <img src="${file.data}" style="max-width:100%; max-height:100%; object-fit:contain;">
          </body>
        `);
      } else if (fileType === 'json' || fileType === 'text') {
        // Ø¹Ø±Ø¶ Ù…Ø­Ø³Ù† Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†ØµÙŠØ© ÙˆØ§Ù„Ù€ JSON
        try {
          let content = '';
          if (file.data.includes(',')) {
            const base64 = file.data.split(',')[1];
            content = decodeURIComponent(escape(atob(base64)));
          }
          
          let formattedContent = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          
          if (fileType === 'json') {
            try {
              const jsonData = JSON.parse(content);
              formattedContent = JSON.stringify(jsonData, null, 2)
                .replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                  let cls = 'json-number';
                  if (/^"/.test(match)) {
                    cls = /:$/.test(match) ? 'json-key' : 'json-string';
                  } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                  }
                  return `<span class="${cls}">${match}</span>`;
                });
            } catch (e) {
              // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ Ø§Ø¹Ø±Ø¶ ÙƒÙ†Øµ Ø¹Ø§Ø¯ÙŠ
            }
          }
          
          newWindow.document.write(`
            <html>
              <head>
                <title>${file.name}</title>
                <meta charset="utf-8">
                <style>
                  body { 
                    font-family: 'Courier New', monospace; 
                    background: #0f172a; 
                    color: #e2e8f0; 
                    padding: 20px;
                    margin: 0;
                    line-height: 1.6;
                  }
                  pre { 
                    white-space: pre-wrap; 
                    word-wrap: break-word; 
                    background: #1e293b;
                    padding: 20px;
                    border-radius: 8px;
                    border: 1px solid rgba(255,255,255,0.1);
                  }
                  .json-key { color: #60a5fa; font-weight: bold; }
                  .json-string { color: #34d399; }
                  .json-number { color: #fbbf24; }
                  .json-boolean { color: #f87171; }
                  .header {
                    background: #1e293b;
                    padding: 15px 20px;
                    margin: -20px -20px 20px -20px;
                    border-bottom: 1px solid rgba(255,255,255,0.1);
                  }
                  .stats {
                    color: #94a3b8;
                    font-size: 14px;
                    margin-top: 10px;
                  }
                </style>
              </head>
              <body>
                <div class="header">
                  <h2 style="margin:0; color: #f1f5f9;">${file.name}</h2>
                  <div class="stats">
                    Ø§Ù„Ø­Ø¬Ù…: ${formatFileSize(file.size)} | Ø§Ù„Ù†ÙˆØ¹: ${fileType.toUpperCase()} | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¹: ${file.uploadTime}
                  </div>
                </div>
                <pre>${formattedContent}</pre>
              </body>
            </html>
          `);
        } catch (e) {
          newWindow.location.href = file.data;
        }
      } else {
        newWindow.location.href = file.data;
      }
    }

    function viewExtractedFile(archiveId, encodedFileName) {
      try {
        const fileName = decodeURIComponent(encodedFileName);
        const file = extractedFilesCache[archiveId]?.find(f => f.name === fileName);

        if (!file) {
          throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ù„Ø¹Ø±Ø¶Ù‡');
        }
        
        const newWindow = window.open('', '_blank');
        
        let formattedContent = file.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        if (fileName.toLowerCase().endsWith('.json')) {
          try {
            const jsonData = JSON.parse(file.content);
            formattedContent = JSON.stringify(jsonData, null, 2)
              .replace(/</g, "&lt;").replace(/>/g, "&gt;")
              .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                  cls = /:$/.test(match) ? 'json-key' : 'json-string';
                } else if (/true|false/.test(match)) {
                  cls = 'json-boolean';
                }
                return `<span class="${cls}">${match}</span>`;
              });
          } catch (e) {
            // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ Ø§Ø¹Ø±Ø¶ ÙƒÙ†Øµ Ø¹Ø§Ø¯ÙŠ
          }
        }

        let analysisInfo = '';
        if (file.analysisData) {
          const analysis = file.analysisData;
          analysisInfo = `
            <div class="analysis-panel">
              <h3>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3>
              <div class="analysis-stats">
                <span class="stat-badge">ğŸ“¨ ${analysis.messagesCount || 0} Ø±Ø³Ø§Ù„Ø©</span>
                <span class="stat-badge">ğŸ” ${analysis.requestsCount || 0} Ø·Ù„Ø¨</span>
                <span class="stat-badge">ğŸ’¼ ${analysis.offersCount || 0} Ø¹Ø±Ø¶</span>
                <span class="stat-badge">ğŸ“ ${analysis.phonesCount || 0} Ù‡Ø§ØªÙ</span>
                <span class="stat-badge">ğŸ’° ${analysis.pricesCount || 0} Ø³Ø¹Ø±</span>
                ${analysis.isReadyForMatching ? '<span class="stat-badge ready">âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</span>' : '<span class="stat-badge not-ready">âš ï¸ ØºÙŠØ± Ø¬Ø§Ù‡Ø²</span>'}
              </div>
            </div>
          `;
        }
        
        newWindow.document.write(`
          <html>
            <head>
              <title>${fileName}</title>
              <meta charset="utf-8">
              <style>
                body { 
                  font-family: 'Courier New', monospace; 
                  background: #0f172a; 
                  color: #e2e8f0; 
                  padding: 0;
                  margin: 0;
                  line-height: 1.6;
                }
                .header {
                  background: #1e293b;
                  padding: 20px;
                  border-bottom: 1px solid rgba(255,255,255,0.1);
                  position: sticky;
                  top: 0;
                  z-index: 100;
                }
                .header h2 {
                  margin: 0 0 10px 0;
                  color: #f1f5f9;
                }
                .stats {
                  color: #94a3b8;
                  font-size: 14px;
                }
                .analysis-panel {
                  background: #334155;
                  padding: 15px;
                  margin: 20px;
                  border-radius: 8px;
                  border: 1px solid rgba(255,255,255,0.1);
                }
                .analysis-panel h3 {
                  margin: 0 0 10px 0;
                  color: #60a5fa;
                }
                .analysis-stats {
                  display: flex;
                  flex-wrap: wrap;
                  gap: 8px;
                }
                .stat-badge {
                  background: rgba(59, 130, 246, 0.2);
                  color: #60a5fa;
                  padding: 4px 8px;
                  border-radius: 12px;
                  font-size: 12px;
                  font-weight: bold;
                }
                .stat-badge.ready {
                  background: rgba(34, 197, 94, 0.2);
                  color: #34d399;
                }
                .stat-badge.not-ready {
                  background: rgba(245, 158, 11, 0.2);
                  color: #fbbf24;
                }
                pre { 
                  white-space: pre-wrap; 
                  word-wrap: break-word; 
                  background: #1e293b;
                  padding: 20px;
                  margin: 20px;
                  border-radius: 8px;
                  border: 1px solid rgba(255,255,255,0.1);
                  max-height: 70vh;
                  overflow-y: auto;
                }
                .json-key { color: #60a5fa; font-weight: bold; }
                .json-string { color: #34d399; }
                .json-number { color: #fbbf24; }
                .json-boolean { color: #f87171; }
              </style>
            </head>
            <body>
              <div class="header">
                <h2>${fileName}</h2>
                <div class="stats">
                  Ø§Ù„Ø­Ø¬Ù…: ${formatFileSize(file.size)} | Ø§Ù„Ù†ÙˆØ¹: ${fileName.split('.').pop().toUpperCase()} | Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ù† Ø£Ø±Ø´ÙŠÙ
                </div>
              </div>
              ${analysisInfo}
              <pre>${formattedContent}</pre>
            </body>
          </html>
        `);
        newWindow.document.close();
        
      } catch (error) {
        showMessage(`âŒ ÙØ´Ù„ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù: ${error.message}`, 'error');
      }
    }
    
    function deleteFileConfirm(fileId) {
      const file = allFiles.find(f => f.id === fileId);
      if (!file) return;
      
      if (confirm(`ğŸ—‘ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${file.name}ØŸ`)) {
        deleteFileById(fileId);
      }
    }
    
    async function deleteFileById(fileId) {
      try {
        await deleteFile(fileId);
        selectedFiles.delete(fileId);
        
        // Ø­Ø°Ù Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø£ÙŠØ¶Ø§Ù‹
        delete analysisResults[fileId];
        
        await refreshFiles();
        showMessage('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
      } catch (error) {
        showMessage('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù', 'error');
      }
    }
    
    async function deleteSelected() {
      if (selectedFiles.size === 0) {
        showMessage('âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ù…Ù„ÙØ§Øª', 'error');
        return;
      }
      
      if (!confirm(`ğŸ—‘ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${selectedFiles.size} Ù…Ù„ÙØŸ`)) {
        return;
      }
      
      try {
        for (const fileId of selectedFiles) {
          await deleteFile(fileId);
          delete analysisResults[fileId];
        }
        const count = selectedFiles.size;
        selectedFiles.clear();
        await refreshFiles();
        showMessage(`âœ… ØªÙ… Ø­Ø°Ù ${count} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­`, 'success');
      } catch (error) {
        showMessage('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª', 'error');
      }
    }
    
    async function refreshFiles() {
      await loadFiles();
      showMessage('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª', 'info');
    }
    
    async function loadFiles() {
      try {
        allFiles = await getAllFiles();
        allFiles.sort((a, b) => b.timestamp - a.timestamp);
        await applySearchAndFilter();
        await updateStats();
      } catch (error) {
        showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª', 'error');
        console.error('Error loading files:', error);
      }
    }

    // ===============================================================================
    // SYSTEM INTEGRATION CHECK - NEW FEATURE
    // ===============================================================================

    async function checkSystemIntegration() {
      showMessage('ğŸ” Ø¬Ø§Ø±ÙŠ ÙØ­Øµ ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù†Ø¸Ø§Ù…...', 'info');
      
      try {
        // ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const testData = await getAllFiles();
        
        // ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
        let readyCount = 0;
        let totalMessages = 0;
        let hasRequests = false;
        let hasOffers = false;
        
        for (const file of testData) {
          const analysis = await analyzeFileContent(file);
          if (analysis) {
            if (analysis.isReadyForMatching) readyCount++;
            totalMessages += analysis.messagesCount || 0;
            if (analysis.requestsCount > 0) hasRequests = true;
            if (analysis.offersCount > 0) hasOffers = true;
          }
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©
        for (const archiveId in extractedFilesCache) {
          const extractedFiles = extractedFilesCache[archiveId];
          for (const file of extractedFiles) {
            if (file.analysisData) {
              totalMessages += file.analysisData.messagesCount || 0;
              if (file.analysisData.requestsCount > 0) hasRequests = true;
              if (file.analysisData.offersCount > 0) hasOffers = true;
            }
          }
        }
        
        let status = 'success';
        let message = '';
        
        if (readyCount === 0) {
          status = 'warning';
          message = `âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©. Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„ÙØ§Øª JSON Ø£Ùˆ Ù†ØµÙŠØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù‚Ø§Ø±ÙŠØ©.`;
        } else if (!hasRequests && !hasOffers) {
          status = 'warning';
          message = `âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${readyCount} Ù…Ù„Ù ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø£Ùˆ Ø¹Ø±ÙˆØ¶ ÙˆØ§Ø¶Ø­Ø©.`;
        } else if (!hasRequests || !hasOffers) {
          status = 'warning';
          message = `âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${hasRequests ? 'Ø·Ù„Ø¨Ø§Øª' : 'Ø¹Ø±ÙˆØ¶'} ÙÙ‚Ø·. Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨Ø§Øª ÙˆØ¹Ø±ÙˆØ¶.`;
        } else {
          message = `âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²! ${readyCount} Ù…Ù„Ù Ø¬Ø§Ù‡Ø²ØŒ ${totalMessages} Ø±Ø³Ø§Ù„Ø©ØŒ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§Øª ÙˆØ¹Ø±ÙˆØ¶.`;
        }
        
        showMessage(message, status);
        
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©
        setTimeout(() => {
          showMessage(`ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…: ${testData.length} Ù…Ù„Ù Ø¥Ø¬Ù…Ø§Ù„ÙŠØŒ ${readyCount} Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©ØŒ ${totalMessages} Ø±Ø³Ø§Ù„Ø©`, 'info');
        }, 3000);
        
      } catch (error) {
        showMessage('âŒ ÙØ´Ù„ ÙØ­Øµ ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù†Ø¸Ø§Ù…', 'error');
        console.error('System check failed:', error);
      }
    }

    // ===============================================================================
    // ENHANCED INITIALIZATION
    // ===============================================================================
    
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        showMessage('â³ Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…...', 'info');
        
        await initDB();
        await loadFiles();
        
        // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù„ÙØ§Øª Ù…Ø¶ØºÙˆØ·Ø© Ù„Ù… ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§
        const unprocessedArchives = allFiles.filter(file => 
          getFileType(file.type, file.name) === 'archive' && 
          !extractedFilesCache[file.id]
        );
        
        if (unprocessedArchives.length > 0) {
          showMessage(`ğŸ“¦ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${unprocessedArchives.length} Ù…Ù„Ù Ù…Ø¶ØºÙˆØ·. Ø§Ø³ØªØ®Ø¯Ù… "Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ" Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰.`, 'warning');
        }
        
        // ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
        setTimeout(checkSystemIntegration, 2000);
        
        showMessage('âœ… Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø¬Ø§Ù‡Ø²', 'success');
        
      } catch (error) {
        showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'error');
        console.error('App initialization error:', error);
      }
    });

    // ===============================================================================
    // KEYBOARD SHORTCUTS & UX ENHANCEMENTS
    // ===============================================================================

    document.addEventListener('keydown', (e) => {
      // Ctrl+A Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
      if (e.ctrlKey && e.key === 'a' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        selectAll();
      }
      
      // Delete Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯
      if (e.key === 'Delete' && selectedFiles.size > 0 && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        deleteSelected();
      }
      
      // F5 Ù„Ù„ØªØ­Ø¯ÙŠØ«
      if (e.key === 'F5') {
        e.preventDefault();
        refreshFiles();
      }
    });

    // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„)
    document.addEventListener('dragover', (e) => {
      e.preventDefault();
      document.body.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
    });

    document.addEventListener('dragleave', (e) => {
      if (!e.relatedTarget) {
        document.body.style.backgroundColor = '';
      }
    });

    document.addEventListener('drop', (e) => {
      e.preventDefault();
      document.body.style.backgroundColor = '';
      showMessage('ğŸ’¡ Ù„Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', 'info');
    });
  </script>
</body>
</html>