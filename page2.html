<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>الصفحة 2</title>
<style>
  :root {
    --bg: #0f172a;
    --card: #111827;
    --text: #e5e7eb;
    --muted: #9ca3af;
    --accent: #22c55e;
    --accent-2: #3b82f6;
    --btn-bg: #1f2937;
    --btn-hover: #374151;
    --shadow: 0 10px 25px rgba(0,0,0,.35);
    --radius: 18px;
    --danger: #ef4444;
    --danger-hover: #dc2626;
  }
  * { box-sizing: border-box; }
  html, body {
    margin: 0; padding: 0; background: var(--bg); color: var(--text);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", Arial, sans-serif;
  }
  .wrap { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
  .card {
    width: min(920px, 96vw); background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    border: 1px solid rgba(255,255,255,.08);
    border-radius: var(--radius); padding: 28px; box-shadow: var(--shadow);
    backdrop-filter: blur(6px);
  }
  h1 { margin: 0 0 10px; font-size: clamp(26px, 3.5vw, 40px); letter-spacing: .2px; }
  p.lead { margin: 0 0 26px; color: var(--muted); }
  .grid {
    display: grid; gap: 14px;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }
  a.btn, button.btn {
    display: inline-block; text-decoration: none; text-align: center; cursor: pointer;
    background: var(--btn-bg); color: var(--text); padding: 14px 16px;
    border-radius: 14px; border: 1px solid rgba(255,255,255,.08);
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
    box-shadow: 0 6px 14px rgba(0,0,0,.25);
    font-family: inherit; font-size: inherit;
  }
  a.btn:hover, button.btn:hover { background: var(--btn-hover); transform: translateY(-1px); }
  a.btn.primary, button.btn.primary { background: var(--accent-2); border-color: transparent; color: #fff; }
  .btn.success { background: var(--accent); border-color: transparent; color: #fff; }
  .btn.danger { background: var(--danger); border-color: transparent; color: #fff; }
  .btn.danger:hover { background: var(--danger-hover); }
  
  .files-section {
    margin: 24px 0;
  }
  
  .stats-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 16px;
    background: rgba(255,255,255,.02);
    border-radius: var(--radius);
    flex-wrap: wrap;
    gap: 12px;
  }
  
  .stat-item {
    text-align: center;
  }
  
  .stat-number {
    font-size: 24px;
    font-weight: bold;
    color: var(--accent-2);
  }
  
  .stat-label {
    font-size: 12px;
    color: var(--muted);
  }
  
  .search-bar {
    margin-bottom: 20px;
  }
  
  .search-input {
    width: 100%;
    padding: 12px 16px;
    background: var(--btn-bg);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 10px;
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
  }
  
  .search-input:focus {
    outline: none;
    border-color: var(--accent-2);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, .1);
  }
  
  .filter-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .filter-tab {
    padding: 8px 16px;
    background: var(--btn-bg);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 20px;
    cursor: pointer;
    transition: all .2s ease;
    font-size: 12px;
  }
  
  .filter-tab.active {
    background: var(--accent-2);
    border-color: var(--accent-2);
    color: #fff;
  }
  
  .filter-tab:hover {
    background: var(--btn-hover);
  }
  
  .files-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }
  
  .file-card {
    background: rgba(255,255,255,.02);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: var(--radius);
    padding: 16px;
    transition: all .2s ease;
  }
  
  .file-card:hover {
    background: rgba(255,255,255,.04);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }
  
  .file-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .file-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin-left: 12px;
  }
  
  .file-icon.image { background: linear-gradient(45deg, #10b981, #059669); }
  .file-icon.document { background: linear-gradient(45deg, #3b82f6, #1d4ed8); }
  .file-icon.audio { background: linear-gradient(45deg, #8b5cf6, #7c3aed); }
  .file-icon.video { background: linear-gradient(45deg, #ef4444, #dc2626); }
  .file-icon.archive { background: linear-gradient(45deg, #f59e0b, #d97706); }
  .file-icon.other { background: linear-gradient(45deg, #6b7280, #4b5563); }
  
  .file-info {
    flex: 1;
  }
  
  .file-name {
    font-weight: 500;
    color: var(--text);
    margin-bottom: 4px;
    word-break: break-word;
  }
  
  .file-meta {
    font-size: 12px;
    color: var(--muted);
  }
  
  .file-preview {
    margin: 12px 0;
    text-align: center;
  }
  
  .file-preview img {
    max-width: 100%;
    max-height: 120px;
    border-radius: 8px;
    object-fit: cover;
  }
  
  .file-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  
  .btn-small {
    padding: 6px 12px;
    font-size: 12px;
    flex: 1;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  
  .empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }
  
  .status-message {
    margin: 16px 0;
    padding: 12px;
    border-radius: 10px;
    text-align: center;
  }
  
  .status-success {
    background: rgba(34, 197, 94, .1);
    color: var(--accent);
    border: 1px solid rgba(34, 197, 94, .2);
  }
  
  .status-error {
    background: rgba(239, 68, 68, .1);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, .2);
  }
  
  .status-info {
    background: rgba(59, 130, 246, .1);
    color: var(--accent-2);
    border: 1px solid rgba(59, 130, 246, .2);
  }
  
  .hidden {
    display: none;
  }
  
  footer { margin-top: 18px; color: var(--muted); font-size: 13px; }
</style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>الصفحة 2</h1>
      <p class="lead">هذه صفحة الصفحة 2 - مستعرض الملفات المرفوعة.</p>
      
      <!-- شريط الإحصائيات -->
      <div class="stats-bar">
        <div class="stat-item">
          <div class="stat-number" id="total-files">0</div>
          <div class="stat-label">إجمالي الملفات</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="total-size">0</div>
          <div class="stat-label">الحجم الإجمالي</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="file-types">0</div>
          <div class="stat-label">أنواع الملفات</div>
        </div>
      </div>
      
      <!-- رسائل الحالة -->
      <div id="status-message" class="hidden"></div>
      
      <!-- شريط البحث -->
      <div class="search-bar">
        <input 
          type="text" 
          class="search-input" 
          id="search-input" 
          placeholder="🔍 البحث في الملفات..."
          oninput="searchFiles()"
        />
      </div>
      
      <!-- تبويبات الفلتر -->
      <div class="filter-tabs">
        <div class="filter-tab active" onclick="filterFiles('all', this)">الكل</div>
        <div class="filter-tab" onclick="filterFiles('image', this)">🖼️ الصور</div>
        <div class="filter-tab" onclick="filterFiles('document', this)">📄 المستندات</div>
        <div class="filter-tab" onclick="filterFiles('audio', this)">🎵 الصوتيات</div>
        <div class="filter-tab" onclick="filterFiles('video', this)">🎬 الفيديو</div>
        <div class="filter-tab" onclick="filterFiles('archive', this)">📦 الأرشيف</div>
        <div class="filter-tab" onclick="filterFiles('other', this)">📁 أخرى</div>
      </div>
      
      <!-- منطقة الملفات -->
      <div class="files-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;">
          <h3>الملفات المحفوظة</h3>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-small" onclick="refreshFiles()">🔄 تحديث</button>
            <button class="btn success btn-small" onclick="selectAll()">✅ تحديد الكل</button>
            <button class="btn danger btn-small" onclick="deleteSelected()">🗑️ حذف المحدد</button>
            <button class="btn warning btn-small" onclick="testExtractAll()">📦 اختبار فك الضغط</button>
            <button class="btn success btn-small" onclick="testSaveFirst()">💾 اختبار الحفظ</button>
            <button class="btn success btn-small" onclick="saveAllExtracted()">💾 حفظ الكل</button>
          </div>
        </div>
        
        <div id="files-container" class="files-grid">
          <!-- سيتم إدراج الملفات هنا -->
        </div>
      </div>
      
      <a class="btn primary" href="index.html">العودة للصفحة الرئيسية</a>
      
      <footer>
        <p>📂 <strong>مستعرض الملفات:</strong> عرض وإدارة الملفات المرفوعة من الصفحة 1</p>
      </footer>
    </div>
  </div>

  <script>
    // متغيرات عامة
    const DB_NAME = 'FilesStorage';
    const DB_VERSION = 1;
    const STORE_NAME = 'files';
    
    let db;
    let allFiles = [];
    let filteredFiles = [];
    let currentFilter = 'all';
    let selectedFiles = new Set();
    
    // تهيئة قاعدة البيانات
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            store.createIndex('name', 'name', { unique: false });
            store.createIndex('uploadTime', 'uploadTime', { unique: false });
          }
        };
      });
    }
    
    // قراءة جميع الملفات
    function getAllFiles() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // حفظ ملف في قاعدة البيانات
    function saveFile(fileData) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.put(fileData); // put will add or update
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }
    
    // حذف ملف
    function deleteFile(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
    
    // تحديد نوع الملف (مُحسن للتعرف على الملفات المضغوطة)
    function getFileType(mimeType, fileName) {
      const archiveExtensions = ['.zip', '.rar', '.7z', '.tar', '.gz', '.bz2'];
      const lowerFileName = fileName ? fileName.toLowerCase() : '';
      
      if (archiveExtensions.some(ext => lowerFileName.endsWith(ext))) {
        return 'archive';
      }
      
      if (mimeType) {
        if (mimeType.startsWith('image/')) return 'image';
        if (mimeType.startsWith('video/')) return 'video';
        if (mimeType.startsWith('audio/')) return 'audio';
        if (mimeType.includes('pdf') || mimeType.includes('document') || mimeType.includes('text') || mimeType.includes('sheet') || mimeType.includes('presentation')) return 'document';
        if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('archive') || mimeType.includes('compressed')) return 'archive';
      }
      
      return 'other';
    }
    
    // الحصول على أيقونة نوع الملف
    function getFileIcon(type) {
      const icons = {
        image: '🖼️',
        video: '🎬',
        audio: '🎵',
        document: '📄',
        archive: '📦',
        other: '📁'
      };
      return icons[type] || '📁';
    }
    
    // فك ضغط الملفات وعرض المحتويات (محسن مع تحميل JSZip)
    async function extractArchive(fileId) {
      try {
        if (typeof JSZip === 'undefined') {
          showMessage('⏳ جاري تحميل مكتبة فك الضغط...', 'info');
          await loadJSZip();
        }
        
        const file = allFiles.find(f => f.id === fileId);
        if (!file) {
          showMessage('❌ الملف غير موجود', 'error');
          return;
        }
        
        showMessage('📦 جاري فك ضغط الملف...', 'info');
        
        const base64Data = file.data.split(',')[1] || file.data;
        
        const zip = await JSZip.loadAsync(base64Data, { base64: true });
        
        const extractedFiles = [];
        for (const [filename, fileObj] of Object.entries(zip.files)) {
          if (!fileObj.dir) {
            try {
              const content = await fileObj.async('text');
              extractedFiles.push({ name: filename, content: content, size: content.length });
            } catch (e) {
              console.warn(`⚠️ فشل استخراج الملف كنص: ${filename}`, e.message);
              try {
                const binaryContent = await fileObj.async('uint8array');
                extractedFiles.push({
                  name: filename,
                  content: `[ملف ثنائي - ${binaryContent.length} بايت]`,
                  size: binaryContent.length,
                  isBinary: true
                });
              } catch (e2) {
                console.error(`❌ فشل استخراج: ${filename}`, e2.message);
              }
            }
          }
        }
        
        if (extractedFiles.length === 0) {
          showMessage('⚠️ لا توجد ملفات قابلة للقراءة في الأرشيف', 'error');
          return;
        }
        
        displayExtractedFiles(file, extractedFiles);
        showMessage(`✅ تم استخراج ${extractedFiles.length} ملف من الأرشيف`, 'success');
        
      } catch (error) {
        console.error('💥 خطأ في فك الضغط:', error);
        showMessage(`❌ فشل في فك ضغط الملف: ${error.message}`, 'error');
      }
    }
    
    // تحميل مكتبة JSZip ديناميكياً
    function loadJSZip() {
      return new Promise((resolve, reject) => {
        if (typeof JSZip !== 'undefined') {
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        script.onload = () => {
          console.log('✅ تم تحميل JSZip بنجاح');
          resolve();
        };
        script.onerror = () => {
          console.error('❌ فشل تحميل JSZip');
          reject(new Error('فشل تحميل مكتبة فك الضغط'));
        };
        document.head.appendChild(script);
      });
    }
    
    // عرض الملفات المستخرجة
    function displayExtractedFiles(archiveFile, extractedFiles) {
      const archiveCard = document.querySelector(`[data-file-id="${archiveFile.id}"]`);
      if (!archiveCard) return;
      
      let contentDiv = archiveCard.querySelector('.archive-content');
      if (contentDiv) {
        contentDiv.remove();
      }
      
      contentDiv = document.createElement('div');
      contentDiv.className = 'archive-content';
      contentDiv.style.cssText = 'margin-top: 12px; border-top: 1px solid rgba(255,255,255,.1); padding-top: 12px;';

      extractedFiles.forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; font-size: 12px; padding: 4px 0;';
        
        fileDiv.innerHTML = `
          <span style="word-break: break-all;">📄 ${file.name} (${formatFileSize(file.size)})</span>
          <div style="display: flex; gap: 4px;">
            <button class="btn btn-small" style="padding: 4px 8px;" onclick="saveExtractedFile('${archiveFile.id}', '${encodeURIComponent(file.name)}')">💾</button>
            <button class="btn btn-small" style="padding: 4px 8px; background: var(--accent);" onclick="viewExtractedFile('${archiveFile.id}', '${encodeURIComponent(file.name)}')">👁️</button>
          </div>
        `;
        
        contentDiv.appendChild(fileDiv);
      });
      
      archiveCard.appendChild(contentDiv);
      
      if (!window.extractedFilesCache) {
        window.extractedFilesCache = {};
      }
      window.extractedFilesCache[archiveFile.id] = extractedFiles;
    }
    
    // حفظ ملف مستخرج كملف جديد (محسن)
    async function saveExtractedFile(archiveId, encodedFileName) {
      try {
        const fileName = decodeURIComponent(encodedFileName);
        const extractedFiles = window.extractedFilesCache?.[archiveId];
        if (!extractedFiles) {
          throw new Error('لم يتم العثور على الملفات المستخرجة في الذاكرة المؤقتة');
        }
        
        const file = extractedFiles.find(f => f.name === fileName);
        if (!file) {
          throw new Error('لم يتم العثور على الملف المحدد');
        }
        
        let mimeType = 'text/plain';
        if (fileName.toLowerCase().endsWith('.json')) mimeType = 'application/json';
        
        const base64Content = btoa(unescape(encodeURIComponent(file.content)));
        const dataUrl = `data:${mimeType};charset=utf-8;base64,${base64Content}`;
        
        const timestamp = Date.now();
        const newFileData = {
          id: `${timestamp}_${Math.random().toString(36).substr(2, 9)}`,
          name: `extracted_${fileName}`,
          size: new Blob([file.content]).size,
          type: mimeType,
          data: dataUrl,
          uploadTime: new Date().toLocaleString('ar-SA'),
          timestamp: timestamp,
        };
        
        await saveFile(newFileData);
        await refreshFiles();
        
        showMessage(`✅ تم حفظ ${fileName} بنجاح`, 'success');
        
        setTimeout(() => {
          const newFileCard = document.querySelector(`[data-file-id="${newFileData.id}"]`);
          if (newFileCard) {
            newFileCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            newFileCard.style.border = '2px solid var(--accent)';
            setTimeout(() => { newFileCard.style.border = ''; }, 3000);
          }
        }, 500);
        
      } catch (error) {
        console.error('💥 خطأ في حفظ الملف:', error);
        showMessage(`❌ فشل في حفظ الملف: ${error.message}`, 'error');
      }
    }
    
    // عرض ملف مستخرج
    function viewExtractedFile(archiveId, encodedFileName) {
      try {
        const fileName = decodeURIComponent(encodedFileName);
        const file = window.extractedFilesCache?.[archiveId]?.find(f => f.name === fileName);

        if (!file) {
          throw new Error('لم يتم العثور على الملف لعرضه');
        }
        
        const newWindow = window.open('', '_blank');
        newWindow.document.write(`
          <html>
            <head>
              <title>${fileName}</title>
              <meta charset="utf-8">
              <style>
                body { font-family: monospace; background: #0f172a; color: #e2e8f0; padding: 20px; }
                pre { white-space: pre-wrap; word-wrap: break-word; }
                .json-key { color: #60a5fa; }
                .json-string { color: #34d399; }
                .json-number { color: #fbbf24; }
                .json-boolean { color: #f87171; }
              </style>
            </head>
            <body><pre>${formatFileContent(file.content, fileName)}</pre></body>
          </html>
        `);
        newWindow.document.close();
        
      } catch (error) {
        showMessage(`❌ فشل في عرض الملف: ${error.message}`, 'error');
      }
    }
    
    // تنسيق محتوى الملف حسب نوعه
    function formatFileContent(content, fileName) {
      const escapedContent = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      if (fileName.toLowerCase().endsWith('.json')) {
        try {
          const jsonData = JSON.parse(content);
          const highlighted = JSON.stringify(jsonData, null, 2)
            .replace(/</g, "&lt;").replace(/>/g, "&gt;")
            .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
              let cls = 'json-number';
              if (/^"/.test(match)) {
                cls = /:$/.test(match) ? 'json-key' : 'json-string';
              } else if (/true|false/.test(match)) {
                cls = 'json-boolean';
              }
              return `<span class="${cls}">${match}</span>`;
            });
          return highlighted;
        } catch (e) {
          return escapedContent;
        }
      }
      return escapedContent;
    }
    
    // تنسيق حجم الملف
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // عرض رسالة الحالة
    function showMessage(message, type) {
      const statusDiv = document.getElementById('status-message');
      statusDiv.textContent = message;
      statusDiv.className = `status-message status-${type}`;
      statusDiv.classList.remove('hidden');
      
      setTimeout(() => {
        statusDiv.classList.add('hidden');
      }, 4000);
    }
    
    // تحديث الإحصائيات
    function updateStats() {
      const totalFiles = allFiles.length;
      const totalSize = allFiles.reduce((sum, file) => sum + file.size, 0);
      const fileTypes = new Set(allFiles.map(file => getFileType(file.type, file.name))).size;
      
      document.getElementById('total-files').textContent = totalFiles;
      document.getElementById('total-size').textContent = formatFileSize(totalSize);
      document.getElementById('file-types').textContent = fileTypes;
    }
    
    // فلترة الملفات
    function filterFiles(type, element) {
      currentFilter = type;
      
      document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
      if (element) {
        element.classList.add('active');
      } else {
        // Fallback for initial load
        document.querySelector(`.filter-tab[onclick*="'${type}'"]`).classList.add('active');
      }
      
      applySearchAndFilter();
    }
    
    // البحث في الملفات
    function searchFiles() {
      applySearchAndFilter();
    }

    // تطبيق البحث والفلترة معاً
    function applySearchAndFilter() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        
        let tempFiles = allFiles;

        if (currentFilter !== 'all') {
            tempFiles = tempFiles.filter(file => getFileType(file.type, file.name) === currentFilter);
        }

        if (searchTerm) {
            tempFiles = tempFiles.filter(file => file.name.toLowerCase().includes(searchTerm));
        }

        filteredFiles = tempFiles;
        displayFiles();
    }
    
    // عرض الملفات
    function displayFiles() {
      const container = document.getElementById('files-container');
      
      if (filteredFiles.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-icon">📂</div>
            <h3>لا توجد ملفات</h3>
            <p>لا توجد ملفات تطابق المعايير المحددة. حاول تغيير الفلتر أو مصطلح البحث.</p>
            <a href="index.html" class="btn primary">رفع ملفات جديدة</a>
          </div>
        `;
        return;
      }
      
      const fileCards = filteredFiles.map(file => {
        const fileType = getFileType(file.type, file.name);
        const fileIcon = getFileIcon(fileType);
        const isSelected = selectedFiles.has(file.id);
        
        let preview = '';
        if (fileType === 'image' && file.data) {
          preview = `<div class="file-preview"><img src="${file.data}" alt="${file.name}" onclick="viewFile('${file.id}')" loading="lazy"></div>`;
        }
        
        let archiveButton = '';
        if (fileType === 'archive') {
            archiveButton = `<button class="btn btn-small" onclick="extractArchive('${file.id}')">📦 فك الضغط</button>`;
        }

        return `
          <div class="file-card ${isSelected ? 'selected' : ''}" data-file-id="${file.id}" style="border: ${isSelected ? '2px solid var(--accent-2)' : '1px solid rgba(255,255,255,.08)'};">
            <div class="file-header">
              <div class="file-icon ${fileType}">${fileIcon}</div>
              <div class="file-info">
                <div class="file-name" title="${file.name}">${file.name}</div>
                <div class="file-meta">${formatFileSize(file.size)} • ${file.uploadTime}</div>
              </div>
              <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleFileSelection('${file.id}', this)" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
            </div>
            ${preview}
            <div class="file-actions">
              <button class="btn btn-small" onclick="downloadFile('${file.id}')">⬇️ تحميل</button>
              <button class="btn btn-small" onclick="viewFile('${file.id}')">👁️ عرض</button>
              ${archiveButton}
              <button class="btn danger btn-small" onclick="deleteFileConfirm('${file.id}')">🗑️ حذف</button>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = fileCards;
    }
    
    // تحديد/إلغاء تحديد ملف
    function toggleFileSelection(fileId, checkbox) {
      const card = checkbox.closest('.file-card');
      if (checkbox.checked) {
        selectedFiles.add(fileId);
        card.style.border = '2px solid var(--accent-2)';
      } else {
        selectedFiles.delete(fileId);
        card.style.border = '1px solid rgba(255,255,255,.08)';
      }
    }
    
    // تحديد جميع الملفات
    function selectAll() {
      const allVisibleSelected = filteredFiles.every(file => selectedFiles.has(file.id));
      
      filteredFiles.forEach(file => {
        if (allVisibleSelected) {
          selectedFiles.delete(file.id);
        } else {
          selectedFiles.add(file.id);
        }
      });
      displayFiles();
    }
    
    // تحميل ملف
    function downloadFile(fileId) {
      const file = allFiles.find(f => f.id === fileId);
      if (!file) {
        showMessage('❌ الملف غير موجود', 'error');
        return;
      }
      
      const a = document.createElement('a');
      a.href = file.data;
      a.download = file.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      showMessage(`⬇️ تم تحميل ${file.name}`, 'success');
    }
    
    // عرض ملف
    function viewFile(fileId) {
      const file = allFiles.find(f => f.id === fileId);
      if (!file) {
        showMessage('❌ الملف غير موجود', 'error');
        return;
      }
      
      const newWindow = window.open();
      const fileType = getFileType(file.type, file.name);
      
      if (fileType === 'image') {
        newWindow.document.write(`<body style="margin:0; background:#000;"><img src="${file.data}" style="width:100%;"></body>`);
      } else {
        newWindow.location.href = file.data;
      }
    }
    
    // تأكيد حذف ملف
    function deleteFileConfirm(fileId) {
      const file = allFiles.find(f => f.id === fileId);
      if (!file) return;
      
      if (confirm(`🗑️ هل أنت متأكد من حذف ${file.name}؟`)) {
        deleteFileById(fileId);
      }
    }
    
    // حذف ملف بالمعرف
    async function deleteFileById(fileId) {
      try {
        await deleteFile(fileId);
        selectedFiles.delete(fileId);
        await refreshFiles();
        showMessage('✅ تم حذف الملف بنجاح', 'success');
      } catch (error) {
        showMessage('❌ فشل حذف الملف', 'error');
      }
    }
    
    // اختبار فك ضغط جميع الملفات المضغوطة
    function testExtractAll() {
      const zipFiles = allFiles.filter(file => getFileType(file.type, file.name) === 'archive');
      
      if (zipFiles.length === 0) {
        showMessage('⚠️ لا توجد ملفات مضغوطة', 'error');
        return;
      }
      
      showMessage(`🔍 تم العثور على ${zipFiles.length} ملف مضغوط، بدء فك الضغط...`, 'info');
      
      zipFiles.forEach((file, index) => {
        setTimeout(() => {
          extractArchive(file.id);
        }, index * 500);
      });
    }

    // *** دالة جديدة ***
    // اختبار حفظ أول ملف مستخرج
    function testSaveFirst() {
        if (!window.extractedFilesCache || Object.keys(window.extractedFilesCache).length === 0) {
            showMessage('⚠️ لا توجد ملفات مستخرجة لحفظها. قم بفك ضغط ملف أولاً.', 'error');
            return;
        }
        // الحصول على أول أرشيف وأول ملف فيه
        const firstArchiveId = Object.keys(window.extractedFilesCache)[0];
        const firstFile = window.extractedFilesCache[firstArchiveId][0];

        if (firstArchiveId && firstFile) {
            showMessage('💾 اختبار حفظ أول ملف مستخرج...', 'info');
            saveExtractedFile(firstArchiveId, encodeURIComponent(firstFile.name));
        } else {
            showMessage('❌ لم يتم العثور على ملفات مستخرجة.', 'error');
        }
    }

    // *** دالة جديدة ***
    // حفظ كل الملفات المستخرجة
    async function saveAllExtracted() {
        if (!window.extractedFilesCache || Object.keys(window.extractedFilesCache).length === 0) {
            showMessage('⚠️ لا توجد ملفات مستخرجة لحفظها. قم بفك ضغط ملف أولاً.', 'error');
            return;
        }

        showMessage('💾 جاري حفظ جميع الملفات المستخرجة...', 'info');
        let savedCount = 0;
        try {
            for (const archiveId in window.extractedFilesCache) {
                const filesToSave = window.extractedFilesCache[archiveId];
                for (const file of filesToSave) {
                    await saveExtractedFile(archiveId, encodeURIComponent(file.name));
                    savedCount++;
                }
            }
            showMessage(`✅ تم حفظ ${savedCount} ملف بنجاح.`, 'success');
        } catch(error) {
            showMessage(`❌ حدث خطأ أثناء حفظ الملفات: ${error.message}`, 'error');
        }
    }

    // حذف الملفات المحددة
    async function deleteSelected() {
      if (selectedFiles.size === 0) {
        showMessage('⚠️ لم يتم تحديد أي ملفات', 'error');
        return;
      }
      
      if (!confirm(`🗑️ هل أنت متأكد من حذف ${selectedFiles.size} ملف؟`)) {
        return;
      }
      
      try {
        for (const fileId of selectedFiles) {
          await deleteFile(fileId);
        }
        const count = selectedFiles.size;
        selectedFiles.clear();
        await refreshFiles();
        showMessage(`✅ تم حذف ${count} ملف بنجاح`, 'success');
      } catch (error) {
        showMessage('❌ فشل حذف بعض الملفات', 'error');
      }
    }
    
    // تحديث قائمة الملفات
    async function refreshFiles() {
      await loadFiles();
      showMessage('🔄 تم تحديث قائمة الملفات', 'info');
    }
    
    // تحميل الملفات من قاعدة البيانات
    async function loadFiles() {
      try {
        allFiles = await getAllFiles();
        allFiles.sort((a, b) => b.timestamp - a.timestamp); // ترتيب حسب الأحدث
        applySearchAndFilter();
        updateStats();
      } catch (error) {
        showMessage('❌ خطأ في تحميل الملفات', 'error');
      }
    }
    
    // تهيئة التطبيق
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await initDB();
        await loadFiles();
        showMessage('✅ مستعرض الملفات جاهز', 'success');
      } catch (error) {
        showMessage('❌ خطأ في تهيئة التطبيق', 'error');
        console.error('App initialization error:', error);
      }
    });
  </script>
</body>
</html>
