<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</title>
<style>
  :root {
    --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --accent:#22c55e; --accent2:#3b82f6; --danger:#ef4444; --warn:#f59e0b;
    --btn:#1f2937; --btnh:#374151; --shadow:0 10px 25px rgba(0,0,0,.35); --r:18px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Naskh Arabic",Arial,sans-serif;}
  .wrap{min-height:100vh;display:grid;place-items:center;padding:24px}
  .card{width:min(1100px,96vw);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
    border:1px solid rgba(255,255,255,.08);border-radius:var(--r);padding:28px;box-shadow:var(--shadow);backdrop-filter:blur(6px)}
  h1{margin:0 0 10px;font-size:clamp(26px,3.2vw,38px)}
  p.lead{margin:0 0 18px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
  .btn{background:var(--btn);color:var(--text);border:1px solid rgba(255,255,255,.08);
    padding:10px 12px;border-radius:12px;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.25)}
  .btn:hover{background:var(--btnh)}
  .btn.primary{background:var(--accent2);border-color:transparent;color:#fff}
  .btn.success{background:var(--accent);border-color:transparent;color:#fff}
  .btn.warn{background:var(--warn);border-color:transparent;color:#fff}
  .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .tile{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .list{display:grid;gap:8px}
  .kbd{background:#0003;border:1px solid #fff2;padding:1px 6px;border-radius:6px}
  .ok{color:#34d399} .bad{color:#f87171}
  input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
    background:var(--btn);color:var(--text)}
  small{color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</h1>
    <p class="lead">Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ù„ÙØ§Øª. ØªÙØ­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ IndexedDB Ù„ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰.</p>

    <div class="grid">
      <!-- Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ù… -->
      <div class="tile">
        <h3>1) Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ù… Ù„Ù„Ù…ÙˆÙ‚Ø¹</h3>
        <p class="muted">ÙŠØ²ÙŠØ¯ Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ø­ØªÙØ§Ø¸ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø¯Ù… Ù…Ø³Ø­Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>
        <div class="row">
          <button class="btn primary" id="persistBtn">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ù…</button>
          <span id="persistState" class="muted"></span>
        </div>
        <small>ÙŠØªØ·Ù„Ø¨ HTTPS Ø£Ùˆ <span class="kbd">localhost</span>.</small>
      </div>

      <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù„Ø¯ -->
      <div class="tile">
        <h3>2) Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù„Ø¯ Ù…ØµØ±Ø­ Ø¨Ù‡ (Ø£Ø¬Ù‡Ø²Ø© ØªØ¯Ø¹Ù… Ø°Ù„Ùƒ)</h3>
        <p class="muted">Ø§Ø®ØªØ± Ù…Ø¬Ù„Ø¯Ù‹Ø§ (Ù…Ø«Ù„ <b>Download</b>) ÙˆØ§Ù…Ù†Ø­Ù‡ Ø¥Ø°Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©. Ø³Ù…Ù‘ÙÙ‡ Ø¨Ø§Ø³Ù… Ù…Ø¹Ø±Ù Ù„ØªØ³ØªØ±Ø¬Ø¹Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰.</p>
        <div class="row">
          <input type="text" id="dirLabel" placeholder="Ø§Ø³Ù… Ù…Ø¹Ø±Ù Ù„Ù„Ù…Ø¬Ù„Ø¯ (Ù…Ø«Ø§Ù„: downloads)" />
        </div>
        <div class="row">
          <button class="btn success" id="addDirBtn">ğŸ“‚ Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù„Ø¯</button>
          <button class="btn" id="testSupportBtn">ÙØ­Øµ Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­</button>
        </div>
        <small id="supportInfo" class="muted"></small>
      </div>

      <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª / Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¢Ù…Ù† -->
      <div class="tile">
        <h3>2.1) Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª (.txt/.json) / Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¢Ù…Ù†</h3>
        <p class="muted">Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ ÙƒØ±ÙˆÙ…ØŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„ÙØ§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§ (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¢Ù…Ù† Ø¹Ø¨Ø± Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„Ù‚ÙÙ„).</p>
        <div class="row">
          <button class="btn" id="addFilesBtn">ğŸ“‘ Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª</button>
          <input id="filesFallback" type="file" accept=".txt,.json" multiple style="display:none" />
        </div>
        <small>ÙŠÙ…ÙƒÙ† ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©.</small>
      </div>

      <!-- Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© -->
      <div class="tile">
        <h3>3) Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©</h3>
        <div id="dirsList" class="list"></div>
        <small>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø°Ù† Ø£Ùˆ Ø­Ø°ÙÙ‡ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨Ù‡.</small>
      </div>

      <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
      <div class="tile">
        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
        <ul class="muted">
          <li>ÙŠØ¬Ø¨ ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† <b>Ø¶ØºØ· Ø²Ø±</b> Ù„ÙŠØ¸Ù‡Ø± Ø­ÙˆØ§Ø± Ø§Ù„Ø¥Ø°Ù†.</li>
          <li>Ø¹Ù„Ù‰ Chrome Android: Ø§Ø®ØªÙŠØ§Ø± <b>Ù…Ø¬Ù„Ø¯ ÙƒØ§Ù…Ù„</b> ØºØ§Ù„Ø¨Ù‹Ø§ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…ØŒ Ù„ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± <b>Ù…Ù„ÙØ§Øª</b> Ù…Ø¯Ø¹ÙˆÙ….</li>
          <li>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù…Ø³Ø§Ø±Ø§Øª <code class="mono">content://</code> Ù…Ø¨Ø§Ø´Ø±Ø©.</li>
        </ul>
      </div>
    </div>

    <hr style="border-color:#fff2;margin:18px 0" />

    <div class="tile">
      <h3>ÙƒÙŠÙ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù‚Ø¨Ø¶ ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ØŸ</h3>
      <p class="muted">Ø£Ø¶Ù Ø§Ù„Ù…Ù‚ØªØ·Ù Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ø£ÙŠ ØµÙØ­Ø©ØŒ Ø«Ù… Ù†Ø§Ø¯Ù <code class="mono">getDirectoryHandle('downloads')</code> Ù…Ø«Ù„Ø§Ù‹:</p>
      <pre class="mono" style="white-space:pre-wrap;background:#0003;border:1px solid #fff2;padding:10px;border-radius:10px;overflow:auto">
&lt;script&gt;
(async () =&gt; {
  // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù‚Ø¨Ø¶ Ù…Ø¬Ù„Ø¯ Ù…Ø­ÙÙˆØ¸ Ø¨Ø§Ø³Ù… label
  async function getDirectoryHandle(label){
    const db = await new Promise((res,rej)=>{
      const req = indexedDB.open('FsPerms',1);
      req.onupgradeneeded = () =&gt; req.result.createObjectStore('dirs',{keyPath:'id'});
      req.onsuccess = () =&gt; res(req.result);
      req.onerror = () =&gt; rej(req.error);
    });
    const tx = db.transaction(['dirs'],'readonly');
    const st = tx.objectStore('dirs');
    const item = await new Promise((res,rej)=>{
      const g = st.get(label);
      g.onsuccess = () =&gt; res(g.result);
      g.onerror = () =&gt; rej(g.error);
    });
    if(!item?.handle) throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø¨Ø¶ Ù…Ø­ÙÙˆØ¸ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…');
    const q = await item.handle.queryPermission?.({mode:'read'}) ?? 'prompt';
    if(q !== 'granted'){
      const r = await item.handle.requestPermission?.({mode:'read'});
      if(r !== 'granted') throw new Error('Ø¥Ø°Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ø±ÙÙˆØ¶');
    }
    return item.handle;
  }
  window.getDirectoryHandle = getDirectoryHandle;
})();
&lt;/script&gt;
      </pre>
      <small>Ù‡Ø°Ø§ ÙŠÙƒÙÙŠ Ù„Ø¬Ø¹Ù„ ÙƒÙ„ ØµÙØ­Ø© Ù…Ù† ØµÙØ­Ø§ØªÙƒ Ø§Ù„Ø¹Ø´Ø± ØªØ¹ÙŠØ¯ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ù†ÙØ³ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø¬Ù‡ÙˆØ¯.</small>
    </div>

  </div>
</div>

<script>
/* ==================== Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© ==================== */
const DB_NAME = 'FsPerms';
let db;

/* ---------- IndexedDB: dirs ---------- */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const _db = req.result;
      if (!_db.objectStoreNames.contains('dirs')) _db.createObjectStore('dirs', { keyPath: 'id' });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function saveDir(label, handle){
  if(!db) db = await openDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(['dirs'],'readwrite');
    const st = tx.objectStore('dirs');
    const put = st.put({ id: label, handle, savedAt: Date.now() });
    put.onsuccess = () => res();
    put.onerror = () => rej(put.error);
  });
}

async function listDirs(){
  if(!db) db = await openDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(['dirs'],'readonly');
    const st = tx.objectStore('dirs');
    const out = [];
    st.openCursor().onsuccess = (e) => {
      const cur = e.target.result;
      if(cur){ out.push(cur.value); cur.continue(); } else { res(out); }
    };
    tx.onerror = () => rej(tx.error);
  });
}

async function removeDir(label){
  if(!db) db = await openDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(['dirs'],'readwrite');
    const st = tx.objectStore('dirs');
    const del = st.delete(label);
    del.onsuccess = () => res();
    del.onerror = () => rej(del.error);
  });
}

/* ---------- Storage persistence ---------- */
async function updatePersistUI(){
  const out = document.getElementById('persistState');
  try{
    if(!('storage' in navigator) || !('persist' in navigator.storage)){
      out.textContent = 'ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.';
      return;
    }
    const persisted = await navigator.storage.persisted();
    out.innerHTML = persisted ? '<span class="ok">Ù…ÙØ¹Ù‘Ù„ âœ…</span>' : '<span class="bad">ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</span>';
  }catch(e){
    out.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚: ' + e.message;
  }
}

async function enablePersist(){
  const out = document.getElementById('persistState');
  if(!('storage' in navigator) || !('persist' in navigator.storage)){
    out.textContent = 'StorageManager.persist ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…';
    return;
  }
  const ok = await navigator.storage.persist();
  out.innerHTML = ok ? '<span class="ok">ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ âœ…</span>' : '<span class="bad">Ø±ÙØ¶ Ø§Ù„Ù…ØªØµÙØ­</span>';
}

/* ---------- Support probe ---------- */
function testSupport(){
  const el = document.getElementById('supportInfo');
  const hasDirPicker = 'showDirectoryPicker' in window;
  const hasOpenPicker = 'showOpenFilePicker' in window;
  const isSecure = window.isSecureContext;
  el.innerHTML =
    `secureContext: <b>${isSecure}</b> Â· showDirectoryPicker: <b>${hasDirPicker}</b> Â· showOpenFilePicker: <b>${hasOpenPicker}</b>`;
  // Ø£Ø®ÙÙ Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù„Ø¯ Ø¥Ø°Ø§ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…
  const dirBtn = document.getElementById('addDirBtn');
  dirBtn.style.display = hasDirPicker ? 'inline-block' : 'none';
}

/* ---------- Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù„Ø¯ ---------- */
async function addDirectory(){
  try{
    const label = (document.getElementById('dirLabel').value || '').trim();
    if(!label) { alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…Ø¹Ø±Ù Ù„Ù„Ù…Ø¬Ù„Ø¯'); return; }

    if(!('showDirectoryPicker' in window)){
      alert('Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.\nØ§Ø³ØªØ®Ø¯Ù… "Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ.');
      return;
    }
    const dirHandle = await window.showDirectoryPicker({ id: 'fs-setup', mode:'read' });
    const q = await dirHandle.queryPermission?.({mode:'read'}) ?? 'prompt';
    if(q !== 'granted'){
      const r = await dirHandle.requestPermission?.({mode:'read'});
      if(r !== 'granted'){ alert('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†'); return; }
    }
    await saveDir(label, dirHandle);
    await renderDirs();
  }catch(e){
    if(e?.name === 'AbortError') return;
    alert('Ø®Ø·Ø£: ' + e.message);
    console.error(e);
  }
}

/* ---------- Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¢Ù…Ù† Ø¹Ø¨Ø± Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…) ---------- */
async function addFiles(){
  try{
    if('showOpenFilePicker' in window){
      const handles = await window.showOpenFilePicker({
        multiple: true,
        types: [{ description: 'Text/JSON', accept: { 'text/plain': ['.txt'], 'application/json': ['.json'] } }]
      });
      let names = [];
      for (const h of handles) {
        const perm = await h.requestPermission?.({ mode: 'read' });
        if (perm !== 'granted') continue;
        const file = await h.getFile();
        names.push(file.name);
        // Ù‡Ù†Ø§ ÙÙ‚Ø· Ù†Ø«Ø¨Øª Ø§Ù„ÙˆØµÙˆÙ„Ø› Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØªÙ… ÙÙŠ ØµÙØ­Ø§ØªÙƒ Ø§Ù„Ø£Ø®Ø±Ù‰ (Ø­Ø³Ø¨ Ù…Ù†Ø·Ù‚Ùƒ).
        // Ø¥Ø°Ø§ Ø±ØºØ¨ØªØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù„ÙØ§Øª Ù†ÙØ³Ù‡Ø§ ÙÙŠ IndexedDB Ù‡Ù†Ø§.
      }
      alert(names.length ? `ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: \n- ${names.join('\n- ')}` : 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„ÙØ§Øª.');
    } else {
      // Ù…ØªØµÙØ­Ø§Øª Ø£Ù‚Ø¯Ù…
      document.getElementById('filesFallback').click();
    }
  }catch(e){
    if(e?.name === 'AbortError') return;
    console.error(e);
    alert('ØªØ¹Ø°Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª: ' + e.message);
  }
}

/* ---------- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª ---------- */
async function probe(label, item){
  try{
    const handle = item.handle;
    if(!handle){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ handle Ù…Ø®Ø²ÙˆÙ†'); return; }
    const mode = 'read';
    const q = await handle.queryPermission?.({mode}) ?? 'prompt';
    if(q !== 'granted'){
      const r = await handle.requestPermission?.({mode});
      if(r !== 'granted'){ alert('Ø¥Ø°Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ø±ÙÙˆØ¶'); return; }
    }
    if('getFile' in handle){
      const file = await handle.getFile();
      alert('OK: ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù„Ù: ' + file.name);
    } else {
      let i=0, names=[];
      for await(const [name, entry] of handle.entries()){
        names.push(name);
        if(++i>=5) break;
      }
      alert('OK: ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø¬Ù„Ø¯. Ø£Ù…Ø«Ù„Ø© Ø¹Ù†Ø§ØµØ±: \n' + (names[0] ? names.join('\n') : '(ÙØ§Ø±Øº)'));
    }
  }catch(e){
    alert('ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„: ' + e.message);
    console.error(e);
  }
}

async function regrant(label, item){
  try{
    const handle = item.handle;
    const mode = 'read';
    const r = await handle.requestPermission?.({mode});
    alert(r === 'granted' ? 'ØªÙ… Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† âœ…' : 'Ø±ÙÙØ¶ Ø§Ù„Ø¥Ø°Ù†');
  }catch(e){
    alert('ØªØ¹Ø°Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø°Ù†: ' + e.message);
  }
}

async function remove(label){
  if(!confirm('Ø­Ø°Ù "'+label+'" Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†ØŸ')) return;
  await removeDir(label);
  await renderDirs();
}

async function renderDirs(){
  const root = document.getElementById('dirsList');
  root.innerHTML = '<span class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>';
  const items = await listDirs();
  if(!items.length){
    root.innerHTML = '<span class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù„Ø¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.</span>';
    return;
  }
  root.innerHTML = '';
  for(const it of items){
    const row = document.createElement('div');
    row.style.display='grid';
    row.style.gridTemplateColumns='1fr auto auto auto';
    row.style.gap='8px';
    row.style.alignItems='center';
    row.style.padding='8px';
    row.style.border='1px solid rgba(255,255,255,.08)';
    row.style.borderRadius='10px';
    const time = new Date(it.savedAt||Date.now()).toLocaleString('ar-SA');
    row.innerHTML = `
      <div>
        <div><b>${it.id}</b></div>
        <div class="muted" style="font-size:12px">Ø­ÙÙØ¸: ${time}</div>
      </div>
      <button class="btn" data-act="probe">Ø§Ø®ØªØ¨Ø§Ø±</button>
      <button class="btn warn" data-act="regrant">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø°Ù†</button>
      <button class="btn danger" data-act="remove">Ø­Ø°Ù</button>
    `;
    row.querySelector('[data-act="probe"]').onclick = () => probe(it.id, it);
    row.querySelector('[data-act="regrant"]').onclick = () => regrant(it.id, it);
    row.querySelector('[data-act="remove"]').onclick = () => remove(it.id);
    root.appendChild(row);
  }
}

/* ---------- Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹ ---------- */
document.getElementById('persistBtn').onclick = enablePersist;
document.getElementById('addDirBtn').onclick = addDirectory;
document.getElementById('testSupportBtn').onclick = testSupport;
document.getElementById('addFilesBtn').onclick = addFiles;

// Ø¯Ø¹Ù… fallback Ù„Ù„Ù…Ù„ÙØ§Øª
document.getElementById('filesFallback')?.addEventListener('change', async (ev) => {
  const files = Array.from(ev.target.files || []);
  alert(files.length ? `ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: \n- ${files.map(f=>f.name).join('\n- ')}` : 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„ÙØ§Øª.');
});

(async () => {
  db = await openDB();
  await updatePersistUI();
  await renderDirs();
  // Ø§Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¯Ø¹Ù…
  testSupport();
})();
</script>
</body>
</html>
